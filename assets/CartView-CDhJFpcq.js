import{s as B,t as P,w as q,i as c,V as D}from"./index-Bs4X4nXp.js";import{ac as S,b,e as g,H as I,a1 as L,a2 as n,a3 as N,j as a,l as h,u as k,a6 as v,Z as y}from"./vue-vendor-DIljl67C.js";import{r as $,s as A,t as M}from"./icons-BFoqPsYi.js";import{V as T}from"./VContainer-CmQjZGRo.js";import{V as f}from"./VCol-CAg5l0iK.js";import{V as j}from"./VDivider-CqZtPwNB.js";import{V as H}from"./VDataTable-Crchovy_.js";import"./vuetify-vendor-BSJ2BONf.js";import"./VList-xpnpME0i.js";import"./VChip-BXsRJurh.js";import"./VSelectionControl-CSOuNvLX.js";const X={__name:"CartView",setup(R){const{apiAuth:u}=q(),i=B(),l=P(),m=S();l.isLogin||(i({text:"請先登入才能查看購物車",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),m.push("/login"));const s=b([]),C=[{align:"center",sortable:!1,value:"name"},{title:"書本圖片",key:"book.image"},{title:"書本名稱",key:"book.title"},{title:"單價",key:"book.retailPrice"},{title:"數量",key:"quantity"},{title:"總價",key:"total",value:t=>t.book.retailPrice*t.quantity},{title:"操作",key:"action"}],x=g(()=>s.value.reduce((t,o)=>t+o.quantity*o.book.retailPrice,0)),d=async(t,o)=>{if(!l.isLogin){m.push("/login");return}try{const{data:e}=await u.patch("/users/cart",{book:t,quantity:o});l.cart=e.result,i({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}});const r=s.value.findIndex(w=>w.book._id===t);s.value[r].quantity+=o,s.value[r].quantity<=0&&s.value.splice(r,1)}catch(e){const r=e?.response?.data?.message||"發生錯誤，請稍後再試";i({text:r,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}},_=g(()=>s.value.length>0),p=b(!1),V=async()=>{p.value=!0;try{await u.post("/orders"),l.cart=0,m.push("/orders"),i({text:"結帳成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(t){const o=t?.response?.data?.message||"發生錯誤，請稍後再試";i({text:o,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}p.value=!1};return I(async()=>{if(l.isLogin)try{const{data:t}=await u.get("/users/cart");s.value.push(...t.result)}catch(t){const o=t?.response?.data?.message||"發生錯誤，請稍後再試";i({text:o,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),(t,o)=>(N(),L(T,null,{default:n(()=>[a(f,{cols:"12"},{default:n(()=>o[0]||(o[0]=[h("h1",null,"購物車",-1)])),_:1,__:[0]}),a(j),a(f,{cols:"12"},{default:n(()=>[a(H,{items:s.value,headers:C},{"item.book.image":n(({item:e})=>[a(D,{src:e.book.image,alt:"Book Image","max-height":"100","max-width":"60"},null,8,["src"])]),"item.quantity":n(({item:e})=>[a(c,{variant:"text",icon:k(A),color:"red",onClick:r=>d(e.book._id,-1)},null,8,["icon","onClick"]),v(y(e.quantity),1),a(c,{variant:"text",icon:k(M),color:"green",onClick:r=>d(e.book._id,1)},null,8,["icon","onClick"])]),"item.action":n(({item:e})=>[a(c,{variant:"text",icon:k($),color:"red",onClick:r=>d(e.book._id,e.quantity*-1)},null,8,["icon","onClick"])]),_:2},1032,["items"])]),_:1}),a(f,{class:"text-center",cols:"12"},{default:n(()=>[h("p",null,"總金額: "+y(x.value),1),a(c,{color:"green",disabled:!_.value,loading:p.value,onClick:V},{default:n(()=>o[1]||(o[1]=[v("結帳",-1)])),_:1,__:[1]},8,["disabled","loading"])]),_:1})]),_:1}))}};export{X as default};
