import{J as F,r as l,D as x,G as r,a0 as T,E,F as I,H as u,a8 as H,a9 as M,aq as N,al as K,a6 as j,M as q,ad as z,ar as G,as as J,Y as X,Z as Y}from"./vue-vendor-DZ6ShR-l.js";import{u as Z,a as O}from"./index-Mk3cYYfI.js";import"./vendor-fvIX-KvJ.js";const L=55,ae={__name:"MybookView",setup(Q){const{apiAuth:k}=O(),m=Z(),P=F(),b=l(10),R=l([{key:"createdAt",order:"desc"}]),h=l(1),c=l([]),w=l(null),S=a=>a?.result?.image||a?.image||"",A=a=>(a?.result?.reviews||a?.reviews||[]).find(e=>e.user.$oid===m.value||e.user===m.value)?.rating||0,B=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"result.title"},{title:"作者",align:"center",sortable:!0,key:"result.authors"},{title:"出版者",align:"center",sortable:!0,key:"result.publisher"},{title:"分類",align:"center",sortable:!0,key:"result.categories"},{title:"評分(1-5)",align:"center",sortable:!0,key:"result.rating"},{title:"書評",align:"center",sortable:!1,key:"result.review",value:a=>{const s=(a?.result?.reviews||a?.reviews||[]).find(e=>e.user.$oid===m.value||e.user===m.value);if(s){const e=s.comment,i=[];for(let n=0;n<e.length;n+=L)i.push(e.substring(n,n+L));return i.join(`
`)}else return"未提供書評"}}],$=l(!0),y=l(0),g=l(""),D=async a=>{if(!(!a||a.length===0))try{console.log("準備清理無效的 favorite 記錄:",a);const t=a.map(s=>k.delete(`/users/favorite/${s}`).catch(e=>(console.warn(`清理 favorite ${s} 失敗:`,e),null)));await Promise.all(t)}catch(t){console.error("清理 favorite 記錄時發生錯誤:",t)}},v=async()=>{$.value=!0,w.value=null;try{console.log("開始載入使用者喜愛書籍...");const{data:a}=await k.get("/users/favorite");console.log("獲取 favorite IDs:",a);const t=a.result||a;if(!t||t.length===0){c.value=[],y.value=0;return}console.log(`找到 ${t.length} 本喜愛書籍`);const s=[],e=[];for(const o of t){console.log(`嘗試獲取書籍 ID: ${o}`);const V=[`/books/${o}`,`/book/${o}`,`/books/detail/${o}`,`/api/books/${o}`];let d=null,p=!1;for(const C of V)try{const f=await k.get(C);console.log(`成功使用端點 ${C}:`,f.data),d=f.data,p=!0;break}catch(f){if(f.response?.status===404){console.log(`書籍 ${o} 不存在 (404)`);continue}console.log(`端點 ${C} 失敗:`,f.response?.status)}p&&d?s.push(d):(console.warn(`書籍 ${o} 不存在，加入清理列表`),e.push(o))}console.log(`有效書籍: ${s.length}, 無效書籍: ${e.length}`),e.length>0&&await D(e);let i=s;g.value&&(i=s.filter(o=>{const V=o?.result?.title||o?.title||"",d=o?.result?.authors||o?.authors||"",p=g.value.toLowerCase();return V.toLowerCase().includes(p)||d.toLowerCase().includes(p)}));const n=(h.value-1)*b.value,U=n+b.value;c.value=i.slice(n,U),y.value=i.length,console.log(`最終顯示書籍數量: ${c.value.length}`)}catch(a){console.error("載入失敗:",a);const t=a?.response?.data?.message||"載入喜愛書籍失敗";P({text:t,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"red",location:"bottom"}}),c.value=[],y.value=0}$.value=!1};v();const _=()=>{h.value=1,v()};return(a,t)=>{const s=E("RouterLink");return I(),x(T,null,{default:r(()=>[u(H,null,{default:r(()=>[u(M,{cols:"12"},{default:r(()=>[u(N,{"items-per-page":b.value,"onUpdate:itemsPerPage":[t[2]||(t[2]=e=>b.value=e),v],"sort-by":R.value,"onUpdate:sortBy":[t[3]||(t[3]=e=>R.value=e),v],page:h.value,"onUpdate:page":[t[4]||(t[4]=e=>h.value=e),v],items:c.value,headers:B,loading:$.value,"items-length":y.value,search:g.value,hover:""},{top:r(()=>[u(z,{label:"搜尋","append-icon":"mdi-magnify",modelValue:g.value,"onUpdate:modelValue":t[0]||(t[0]=e=>g.value=e),"onClick:append":_,onKeydown:G(_,["enter"])},null,8,["modelValue"]),w.value?(I(),x(J,{key:0,class:"mt-2",type:"warning",dismissible:"","onClick:close":t[1]||(t[1]=e=>w.value=null)},{default:r(()=>[X(Y(w.value),1)]),_:1})):q("",!0)]),"item.image":r(({item:e})=>[u(s,{class:"text-primary text-decoration-none",to:"/books/"+(e?.result?._id||e?._id||e?.result?.id||e?.id),title:e?.result?.title||e?.title||""},{default:r(()=>[u(j,{src:S(e),width:"80",height:"80",cover:""},null,8,["src"])]),_:2},1032,["to","title"])]),"item.starRating":r(({item:e})=>[u(K,{value:A(e),readonly:"",color:"#4d4637 darken-3",size:"20"},null,8,["value"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1})}}};export{ae as default};
