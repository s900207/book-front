var ee=Object.defineProperty,ae=Object.defineProperties;var te=Object.getOwnPropertyDescriptors;var z=Object.getOwnPropertySymbols;var le=Object.prototype.hasOwnProperty,oe=Object.prototype.propertyIsEnumerable;var E=(n,i,r)=>i in n?ee(n,i,{enumerable:!0,configurable:!0,writable:!0,value:r}):n[i]=r,H=(n,i)=>{for(var r in i||(i={}))le.call(i,r)&&E(n,r,i[r]);if(z)for(var r of z(i))oe.call(i,r)&&E(n,r,i[r]);return n},K=(n,i)=>ae(n,te(i));var I=(n,i,r)=>new Promise((C,f)=>{var V=c=>{try{w(r.next(c))}catch(k){f(k)}},_=c=>{try{w(r.throw(c))}catch(k){f(k)}},w=c=>c.done?C(c.value):Promise.resolve(c.value).then(V,_);w((r=r.apply(n,i)).next())});import{J as se,r as m,D,G as l,a0 as re,F as S,H as t,a8 as G,a9 as L,at as ue,a1 as F,Y as v,a6 as J,ad as x,ar as ie,ak as ne,ac as q,a7 as M,ap as Y,ah as de,a5 as A,M as pe,au as me,$ as T,as as ce,Z as ve,am as ge,ab as fe,a3 as be}from"./vue-vendor-CO2Qqhmb.js";import{_ as ye,a as Ve}from"./index-VDA-datB.js";import"./vendor-oObasS19.js";/* empty css                   */const ke={class:"text-center"},xe={__name:"BookmanagementView",setup(n){const{apiAuth:i}=Ve(),r=se(),C=m(10),f=m([{key:"createdAt",order:"desc"}]),V=m(1),_=m([]),w=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"title"},{title:"作者",align:"center",sortable:!0,key:"authors"},{title:"出版者",align:"center",sortable:!0,key:"publisher"},{title:"價格",align:"center",sortable:!0,key:"retailPrice"},{title:"分類",align:"center",sortable:!0,key:"categories"},{title:"編輯",align:"center",sortable:!1,key:"edit"},{title:"刪除",align:"center",sortable:!1,key:"delete"}],c=m(!0),k=m(0),P=m(""),U=m(!1),o=m({_id:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",description:"",image:""}),b=m(null),g=m(""),R=m(!1),j=()=>g.value?g.value:o.value.image||"",$=()=>{const u=document.querySelector('input[type="file"]');u&&u.click()},Z=u=>{const e=u.target.files[0];e&&(b.value=e,g.value&&URL.revokeObjectURL(g.value),g.value=URL.createObjectURL(e))},y=()=>I(null,null,function*(){var u,e,a,d;c.value=!0;try{const{data:p}=yield i.get("/books/all",{params:{page:V.value,itemsPerPage:C.value,sortBy:((u=f.value[0])==null?void 0:u.key)||"createdAt",sortOrder:((e=f.value[0])==null?void 0:e.order)==="asc"?1:-1,search:P.value}});_.value.splice(0,_.value.length,...p.result.data),k.value=p.result.total}catch(p){console.log(p);const B=((d=(a=p==null?void 0:p.response)==null?void 0:a.data)==null?void 0:d.message)||"發生錯誤，請稍後再試";r({text:B,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}c.value=!1});y();const Q=u=>I(null,null,function*(){var e,a;if(console.log(u),!u._id){console.error("沒有書籍 ID");return}try{yield i.delete(`/books/${u._id}`),r({text:"書籍已成功刪除",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),y()}catch(d){console.log(d);const p=((a=(e=d==null?void 0:d.response)==null?void 0:e.data)==null?void 0:a.message)||"刪除書籍時發生錯誤，請稍後再試";r({text:p,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),O=()=>{V.value=1,y()},W=u=>{o.value=K(H({},u),{image:u.image||""}),U.value=!0,b.value=null,g.value=""},N=()=>{U.value=!1,b.value=null,g.value&&(URL.revokeObjectURL(g.value),g.value="");const u=document.querySelector('input[type="file"]');u&&(u.value="")},X=()=>I(null,null,function*(){var u,e,a,d,p,B;R.value=!0;try{if(b.value){const s=new FormData;s.append("image",b.value),s.append("title",o.value.title),s.append("authors",o.value.authors),s.append("publisher",o.value.publisher),s.append("retailPrice",o.value.retailPrice),s.append("categories",o.value.categories),s.append("description",o.value.description),yield i.patch(`/books/${o.value._id}`,s,{headers:{"Content-Type":"multipart/form-data"}})}else{const s={title:o.value.title,authors:o.value.authors,publisher:o.value.publisher,retailPrice:parseFloat(o.value.retailPrice)||0,categories:o.value.categories,description:o.value.description};yield i.patch(`/books/${o.value._id}`,s)}r({text:"書籍已成功更新",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),y(),N()}catch(s){console.error("更新書籍失敗:",s);let h="更新書籍時發生錯誤，請稍後再試";((u=s==null?void 0:s.response)==null?void 0:u.status)===404?h="找不到書籍":((e=s==null?void 0:s.response)==null?void 0:e.status)===400?h=((d=(a=s==null?void 0:s.response)==null?void 0:a.data)==null?void 0:d.message)||"ID 格式錯誤":(B=(p=s==null?void 0:s.response)==null?void 0:p.data)!=null&&B.message&&(h=s.response.data.message),r({text:h,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"red",location:"bottom"}})}R.value=!1});return(u,e)=>(S(),D(re,null,{default:l(()=>[t(G,null,{default:l(()=>[t(L,{cols:"12"},{default:l(()=>[t(ue,{"items-per-page":C.value,"onUpdate:itemsPerPage":[e[1]||(e[1]=a=>C.value=a),y],"sort-by":f.value,"onUpdate:sortBy":[e[2]||(e[2]=a=>f.value=a),y],page:V.value,"onUpdate:page":[e[3]||(e[3]=a=>V.value=a),y],items:_.value,headers:w,loading:c.value,"items-length":k.value,search:P.value,hover:""},{top:l(()=>[t(x,{label:"搜尋","append-icon":"mdi-magnify",modelValue:P.value,"onUpdate:modelValue":e[0]||(e[0]=a=>P.value=a),"onClick:append":O,onKeydown:ie(O,["enter"])},null,8,["modelValue"])]),"item.image":l(({item:a})=>[t(J,{src:a.image,width:"80",height:"80",cover:""},null,8,["src"])]),"item.edit":l(({item:a})=>[t(F,{onClick:d=>W(a)},{default:l(()=>e[11]||(e[11]=[v("編輯",-1)])),_:2,__:[11]},1032,["onClick"])]),"item.delete":l(({item:a})=>[t(F,{onClick:d=>Q(a)},{default:l(()=>e[12]||(e[12]=[v("刪除",-1)])),_:2,__:[12]},1032,["onClick"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"]),t(ne,{modelValue:U.value,"onUpdate:modelValue":e[10]||(e[10]=a=>U.value=a),persistent:"","max-width":"700px"},{default:l(()=>[t(q,null,{default:l(()=>[t(M,null,{default:l(()=>e[13]||(e[13]=[v("編輯書籍",-1)])),_:1,__:[13]}),t(Y,null,{default:l(()=>[t(de,{ref:"editForm"},{default:l(()=>[t(G,null,{default:l(()=>[t(L,{cols:"12",md:"6"},{default:l(()=>[t(x,{modelValue:o.value.title,"onUpdate:modelValue":e[4]||(e[4]=a=>o.value.title=a),label:"書名",required:""},null,8,["modelValue"]),t(x,{modelValue:o.value.authors,"onUpdate:modelValue":e[5]||(e[5]=a=>o.value.authors=a),label:"作者",required:""},null,8,["modelValue"]),t(x,{modelValue:o.value.publisher,"onUpdate:modelValue":e[6]||(e[6]=a=>o.value.publisher=a),label:"出版者",required:""},null,8,["modelValue"]),t(x,{modelValue:o.value.retailPrice,"onUpdate:modelValue":e[7]||(e[7]=a=>o.value.retailPrice=a),label:"價格",required:"",type:"number"},null,8,["modelValue"]),t(x,{modelValue:o.value.categories,"onUpdate:modelValue":e[8]||(e[8]=a=>o.value.categories=a),label:"分類",required:""},null,8,["modelValue"])]),_:1}),t(L,{cols:"12",md:"6"},{default:l(()=>[t(q,{outlined:""},{default:l(()=>[t(M,null,{default:l(()=>e[14]||(e[14]=[v("書籍圖片",-1)])),_:1,__:[14]}),t(Y,null,{default:l(()=>[j()?(S(),D(q,{key:0,class:"image-upload-area mb-3 d-flex align-center justify-center",onClick:$,hover:""},{default:l(()=>[t(J,{class:"mx-auto",src:j(),"max-height":"200","max-width":"100%",contain:""},null,8,["src"]),t(me,{class:"align-center justify-center hover-overlay","model-value":!1,style:{position:"absolute",top:"0",left:"0",right:"0",bottom:"0",background:"rgba(0,0,0,0.5)",opacity:"0",transition:"opacity 0.3s"}},{default:l(()=>[t(T,{color:"white",size:"48"},{default:l(()=>e[15]||(e[15]=[v("mdi-camera",-1)])),_:1,__:[15]}),e[16]||(e[16]=A("div",{style:{color:"white","margin-top":"8px"}},"點擊更換圖片",-1))]),_:1,__:[16]})]),_:1})):(S(),D(q,{key:1,class:"image-upload-area mb-3 d-flex align-center justify-center",onClick:$,hover:""},{default:l(()=>[A("div",ke,[t(T,{size:"64",color:"grey"},{default:l(()=>e[17]||(e[17]=[v("mdi-camera-plus",-1)])),_:1,__:[17]}),e[18]||(e[18]=A("div",{class:"mt-2 text-grey"},"點擊上傳圖片",-1))])]),_:1})),A("input",{ref:"fileInput",type:"file",accept:"image/*",style:{display:"none"},onChange:Z},null,544),b.value?(S(),D(ce,{key:2,class:"mt-3",type:"info",variant:"tonal"},{default:l(()=>[t(T,{class:"mr-2"},{default:l(()=>e[19]||(e[19]=[v("mdi-file-image",-1)])),_:1,__:[19]}),v("已選擇: "+ve(b.value.name),1)]),_:1})):pe("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),t(L,{cols:"12"},{default:l(()=>[t(ge,{modelValue:o.value.description,"onUpdate:modelValue":e[9]||(e[9]=a=>o.value.description=a),label:"簡介",rows:"5"},null,8,["modelValue"])]),_:1})]),_:1},512)]),_:1}),t(fe,null,{default:l(()=>[t(be),t(F,{color:"blue darken-1",variant:"text",onClick:N},{default:l(()=>e[20]||(e[20]=[v("取消",-1)])),_:1,__:[20]}),t(F,{color:"blue darken-1",variant:"text",onClick:X,loading:R.value},{default:l(()=>e[21]||(e[21]=[v("保存",-1)])),_:1,__:[21]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}))}},Be=ye(xe,[["__scopeId","data-v-9e024360"]]);export{Be as default};
