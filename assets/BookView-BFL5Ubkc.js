import{j as t,P as ee,n as te,b as k,ac as E,af as ae,H as le,a7 as L,a2 as a,F as T,a3 as b,u as i,a6 as C,Z as p,l as d,a1 as I,a8 as z,ae as D,ad as oe}from"./vue-vendor-DIljl67C.js";import{u as se}from"./vee-validate-7KorKqsb.js";import{m as re,t as G,s as J,w as K,_ as ne,J as ue,V as ie,G as H,i as V,H as M,K as de,E as ce,N as me}from"./index-BRZ02E1-.js";import{h as fe,i as ve,c as pe,q as ge,r as _e,s as be}from"./icons-C5frdmYn.js";import{V as Ve}from"./VContainer-2tbue3aE.js";import{V as m}from"./VRow-BjGxhWPh.js";import{V as r}from"./VCol-C8p0eyUI.js";import{V as N}from"./VForm-Bj8hpwjr.js";import{V as $}from"./VRating-BVnsBN5W.js";import{V as j}from"./VTextarea-DWKYi__b.js";import{V as ke,a as we,b as ye}from"./VList-D8ZyF8Dv.js";import{g as he,p as Ce,f as xe,a as Pe}from"./vuetify-vendor-BSJ2BONf.js";import"./VDivider-DutfJ1wv.js";const Be=Ce({start:Boolean,end:Boolean,...Pe(),...re()},"VListItemAction"),q=he()({name:"VListItemAction",props:Be(),setup(f,w){let{slots:y}=w;return xe(()=>t(f.tag,{class:te(["v-list-item-action",{"v-list-item-action--start":f.start,"v-list-item-action--end":f.end},f.class]),style:ee(f.style)},y)),{}}});function Se(f){const{apiAuth:w}=K(),y=G(),c=k(!1),x=J(),P=E();return{isFavorite:c,checkFavoriteStatus:async()=>{try{const{data:u}=await w.get("/users/favorite",{params:{bookId:f}});c.value=u.result.includes(f)}catch(u){console.error(u),c.value=!1}},addFavorite:async()=>{if(!y.isLogin){P.push("/login");return}c.value=!c.value;try{const{data:u}=await w.post("/users/favorite",{bookId:f,isFavorite:c.value});y.favorite=u.result,x({text:c.value?"已加入我的最愛":"已移除我的最愛",showCloseButton:!1,snackbarProps:{timeout:2e3,color:c.value?"green":"red",location:"bottom"}})}catch(u){console.error(u),u.response&&u.response.status===401?P.push("/login"):x({text:"發生錯誤，請稍後再試",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}}}const Le=["innerHTML"],Fe={key:1},Ie={class:"mb-3",style:{fontSize:"16px",lineHeight:"1.5",color:"#333"}},$e={__name:"BookView",setup(f){const w=o=>o?`https://www.gravatar.com/avatar/${btoa(o).slice(0,32)}?d=identicon&s=120`:"https://www.gravatar.com/avatar/default?d=identicon&s=120",y=o=>!h.isLogin||!h._id?!1:o?.toString()===h._id.toString(),c=ae(),x=E(),{api:P,apiAuth:B}=K(),v=k(!1),u=k(!1),g=J(),h=G(),_=k({usersId:"",rating:0,comment:""}),S=k(!1),{handleSubmit:U}=se({initialValues:{usersId:"",rating:0,comment:""}}),l=k({_id:"",image:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",buyLink:"",description:"",reviews:[]}),n=k({id:"",rating:0,comment:"",bookId:""}),{isFavorite:F,checkFavoriteStatus:W,addFavorite:Z}=Se(c.params.id),R=()=>{S.value=!1,n.value={id:"",rating:0,comment:"",bookId:""}},O=U(async o=>{if(!h.isLogin){x.push("/login"),g({text:"請先登入",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}});return}v.value=!0;try{const{data:e}=await B.post(`/books/${c.params.id}/reviews`,{rating:_.value.rating,comment:_.value.comment});e&&e.result&&(l.value.reviews.push(e.result),_.value={usersId:"",rating:0,comment:""}),g({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(e){console.log(e);const s=e?.response?.data?.message||"發生錯誤，請稍後再試";g({text:s,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}finally{v.value=!1}}),Q=o=>{if(o){const e=l.value.reviews.find(s=>s._id===o);e&&(n.value.id=e._id,n.value.rating=e.rating,n.value.comment=e.comment,n.value.bookId=l.value._id)}S.value=!0},A=U(async o=>{v.value=!0;try{await B.patch(`/books/${n.value.bookId}/reviews/${n.value.id}`,{rating:n.value.rating,comment:n.value.comment});const e=l.value.reviews.findIndex(s=>s._id===n.value.id);e!==-1&&(l.value.reviews[e].rating=n.value.rating,l.value.reviews[e].comment=n.value.comment),g({text:"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),R()}catch(e){console.log(e);const s=e?.response?.data?.message||"發生錯誤，請稍後再試";g({text:s,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}finally{v.value=!1}});le(async()=>{try{const{data:o}=await P.get(`/books/${c.params.id}`);l.value._id=o.result._id,l.value.image=o.result.image,l.value.title=o.result.title,l.value.authors=o.result.authors,l.value.publisher=o.result.publisher,l.value.retailPrice=o.result.retailPrice,l.value.categories=o.result.categories,l.value.buyLink=o.result.buyLink;let e=o.result.description.replace(/(※|★|◆|✓|●|▓|▌|￭|──|【)/g,"<br>$1");e=e.replace(/(】)/g,"$1<br>"),e=e.replace(new RegExp("(?<=──[^,]*?)(?=,)","g"),"<br>$1"),l.value.description=e,l.value.reviews=o.result.reviews,document.title=`書評網 | ${l.value.title}`,await W()}catch(o){console.log(o)}});const X=async()=>{if(!h.isLogin){x.push("/login");return}try{const{data:o}=await B.patch("/users/cart",{book:l.value._id,quantity:1});h.cart=o.result,g({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(o){const e=o?.response?.data?.message||"發生錯誤，請稍後再試";g({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}};return(o,e)=>(b(),L(T,null,[t(Ve,null,{default:a(()=>[t(m,null,{default:a(()=>[t(r,{cols:"12",md:"3",style:{position:"sticky"},top:"0"},{default:a(()=>[t(ie,{src:l.value.image},null,8,["src"]),t(H,null,{default:a(()=>[t(m,{class:"justify-center align-center"},{default:a(()=>[t(r,{cols:"6"},{default:a(()=>[t(V,{"prepend-icon":i(F)?i(fe):i(ve),color:i(F)?"red":"blue",onClick:i(Z)},{default:a(()=>[C(p(i(F)?"取消最愛":"加入最愛"),1)]),_:1},8,["prepend-icon","color","onClick"])]),_:1}),t(r,{cols:"6"},{default:a(()=>[t(V,{color:"primary","prepend-icon":i(pe),onClick:X},{default:a(()=>e[6]||(e[6]=[C("加入購物車",-1)])),_:1,__:[6]},8,["prepend-icon"])]),_:1})]),_:1})]),_:1})]),_:1}),t(r,{cols:"12",md:"9"},{default:a(()=>[d("h1",null,p(l.value.title),1),d("h2",null,p(l.value.authors),1),t(m,null,{default:a(()=>[t(r,{cols:"auto"},{default:a(()=>e[7]||(e[7]=[d("h3",null,"出版者:",-1)])),_:1,__:[7]}),t(r,null,{default:a(()=>[d("p",null,p(l.value.publisher),1)]),_:1})]),_:1}),t(m,null,{default:a(()=>[t(r,{cols:"auto"},{default:a(()=>e[8]||(e[8]=[d("h3",null,"價格:",-1)])),_:1,__:[8]}),t(r,null,{default:a(()=>[d("p",null,"$"+p(l.value.retailPrice),1)]),_:1})]),_:1}),t(m,null,{default:a(()=>[t(r,{cols:"auto"},{default:a(()=>e[9]||(e[9]=[d("h3",null,"分類:",-1)])),_:1,__:[9]}),t(r,null,{default:a(()=>[d("p",null,p(l.value.categories),1)]),_:1})]),_:1}),t(m,null,{default:a(()=>[t(r,{cols:"auto"},{default:a(()=>[e[10]||(e[10]=d("h3",null,"簡介:",-1)),u.value?(b(),L("p",{key:0,innerHTML:l.value.description},null,8,Le)):(b(),L("p",Fe,p(l.value.description.substring(0,500)),1))]),_:1,__:[10]}),t(r,{class:"text-center"},{default:a(()=>[l.value.description.length>100?(b(),I(V,{key:0,color:"#4d4637",onClick:e[0]||(e[0]=s=>u.value=!u.value),icon:u.value?i(ge):i(_e)},null,8,["icon"])):z("",!0)]),_:1})]),_:1}),t(m,null,{default:a(()=>[t(r,{cols:"12"},{default:a(()=>[e[12]||(e[12]=d("h3",null,"新增書評:",-1)),t(N,{disabled:v.value,onSubmit:D(i(O),["prevent"])},{default:a(()=>[t($,{modelValue:_.value.rating,"onUpdate:modelValue":e[1]||(e[1]=s=>_.value.rating=s),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),t(j,{modelValue:_.value.comment,"onUpdate:modelValue":e[2]||(e[2]=s=>_.value.comment=s),label:"你的書評",required:""},null,8,["modelValue"]),t(V,{color:"#4d4637",type:"submit",loading:v.value},{default:a(()=>e[11]||(e[11]=[C("提交",-1)])),_:1,__:[11]},8,["loading"])]),_:1},8,["disabled","onSubmit"])]),_:1,__:[12]})]),_:1}),t(m,null,{default:a(()=>[t(r,{cols:"12"},{default:a(()=>[e[13]||(e[13]=d("h3",null,"書評:",-1)),t(ke,null,{default:a(()=>[(b(!0),L(T,null,oe(l.value.reviews,s=>(b(),I(we,{key:s._id},{default:a(()=>[t(M,null,{default:a(()=>[t(m,{class:"align-center"},{default:a(()=>[t(r,{cols:"auto"},{default:a(()=>[t(de,{image:w(s.user.account),size:"60"},null,8,["image"])]),_:2},1024),t(r,null,{default:a(()=>[t(m,null,{default:a(()=>[t(r,{cols:"auto"},{default:a(()=>[t(ye,{style:{fontSize:"24px",fontWeight:"bold"}},{default:a(()=>[C(p(s.user.account),1)]),_:2},1024)]),_:2},1024),t(r,{cols:"auto"},{default:a(()=>[t(q,null,{default:a(()=>[t($,{modelValue:s.rating,"onUpdate:modelValue":Y=>s.rating=Y,color:"#4d4637 darken-3",size:"20",readonly:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),t(m,null,{default:a(()=>[t(r,{cols:"12"},{default:a(()=>[d("p",Ie,p(s.comment),1)]),_:2},1024)]),_:2},1024)]),_:2},1024),t(r,{class:"d-flex justify-end",cols:"auto"},{default:a(()=>[y(s.user._id)?(b(),I(q,{key:0},{default:a(()=>[t(V,{icon:i(be),color:"#4d4637",size:"small",onClick:()=>Q(s._id)},null,8,["icon","onClick"])]),_:2},1024)):z("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1,__:[13]})]),_:1})]),_:1})]),_:1})]),_:1}),t(ue,{modelValue:S.value,"onUpdate:modelValue":e[5]||(e[5]=s=>S.value=s),"max-width":"400"},{default:a(()=>[t(N,{disabled:v.value,onSubmit:D(i(A),["prevent"])},{default:a(()=>[t(M,null,{default:a(()=>[t(ce,{class:"text-center py-4"},{default:a(()=>e[14]||(e[14]=[d("h3",null,"編輯書評",-1)])),_:1,__:[14]}),t(me,null,{default:a(()=>[t($,{class:"mb-4",modelValue:n.value.rating,"onUpdate:modelValue":e[3]||(e[3]=s=>n.value.rating=s),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),t(j,{modelValue:n.value.comment,"onUpdate:modelValue":e[4]||(e[4]=s=>n.value.comment=s),label:"你的書評",required:"",rows:"4"},null,8,["modelValue"])]),_:1}),t(H,{class:"justify-center pb-4"},{default:a(()=>[t(V,{class:"mr-2",color:"grey",variant:"outlined",onClick:R},{default:a(()=>e[15]||(e[15]=[C("取消",-1)])),_:1,__:[15]}),t(V,{color:"#4d4637",onClick:i(A),loading:v.value},{default:a(()=>e[16]||(e[16]=[C("修正",-1)])),_:1,__:[16]},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64))}},Je=ne($e,[["__scopeId","data-v-9cdb9ed6"]]);export{Je as default};
