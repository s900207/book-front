import{_ as H,s as M,t as R,w as T,R as U,H as L,r as E,i as f,V as F}from"./index-CLsaBFoP.js";import{b as x,e as S,H as O,a1 as v,a2 as o,ac as Q,a3 as p,j as l,a8 as Z,l as u,a6 as k,Z as y,u as h}from"./vue-vendor-DIljl67C.js";import{v as G,w as J,x as K,y as W}from"./icons-BmvWcfYN.js";import{V as X}from"./VContainer-DLqEUT7d.js";import{V as w}from"./VCol-HoqbGPYx.js";import{V as Y}from"./VDivider-J5w1HoUO.js";import{V as tt}from"./VDataTable-BG-vFee7.js";import"./vuetify-vendor-CjpGIcAt.js";import"./VList-TZpTG25G.js";import"./VChip-Cksqm0uA.js";import"./VSelectionControl-BYLK3JUE.js";const et={class:"d-flex align-center justify-center"},at={class:"mx-3"},ot={__name:"CartView",setup(st){const{apiAuth:b}=T(),C=M(),c=R(),g=Q(),s=x([]),d=x(!1),r=x(!1),_=x(!1),z=[{title:"書本圖片",key:"book.image",sortable:!1},{title:"書本名稱",key:"book.title"},{title:"單價",key:"book.retailPrice",align:"center"},{title:"數量",key:"quantity",align:"center",sortable:!1},{title:"小計",key:"total",align:"center",sortable:!1},{title:"操作",key:"action",align:"center",sortable:!1}],D=S(()=>s.value.reduce((a,e)=>a+e.quantity*e.book.retailPrice,0)),P=S(()=>s.value.length>0&&!d.value&&!r.value),m=(a,e="發生錯誤，請稍後再試")=>{const t=a?.response?.data?.message||e;C({text:t,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"red",location:"bottom"}})},V=a=>{C({text:a,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})},q=async(a,e)=>{if(!c.isLogin){g.push("/login");return}const t=s.value.find(n=>n.book._id===a);if(!t){m(null,"找不到指定的商品");return}const i=t.quantity+e;if(i<=0){await B(a,t.quantity);return}r.value=!0;try{const{data:n}=await b.patch("/users/cart",{book:a,quantity:e});c.cart=n.result;const $=s.value.findIndex(A=>A.book._id===a);$!==-1&&(s.value[$].quantity=i);const j=e>0?"商品數量已增加":"商品數量已減少";V(j)}catch(n){m(n,"更新數量失敗")}finally{r.value=!1}},B=async(a,e)=>{if(!c.isLogin){g.push("/login");return}r.value=!0;try{const{data:t}=await b.patch("/users/cart",{book:a,quantity:-e});c.cart=t.result;const i=s.value.findIndex(n=>n.book._id===a);i!==-1&&s.value.splice(i,1),V("商品已從購物車移除")}catch(t){m(t,"移除商品失敗")}finally{r.value=!1}},N=async()=>{if(P.value){_.value=!0;try{await b.post("/orders"),c.cart=0,s.value=[],V("結帳成功！"),g.push("/orders")}catch(a){m(a,"結帳失敗")}finally{_.value=!1}}},I=async()=>{if(!c.isLogin){C({text:"請先登入才能查看購物車",showCloseButton:!1,snackbarProps:{timeout:3e3,color:"warning",location:"bottom"}}),g.push("/login");return}d.value=!0;try{const{data:a}=await b.get("/users/cart");s.value=[...a.result]}catch(a){m(a,"載入購物車失敗")}finally{d.value=!1}};return O(()=>{I()}),(a,e)=>(p(),v(X,null,{default:o(()=>[l(w,{cols:"12"},{default:o(()=>e[0]||(e[0]=[u("h1",null,"購物車",-1)])),_:1,__:[0]}),l(Y),l(w,{cols:"12"},{default:o(()=>[d.value?(p(),v(U,{key:0,indeterminate:"",color:"primary"})):s.value.length===0?(p(),v(L,{key:1,class:"text-center pa-8"},{default:o(()=>[l(E,{size:"64",color:"grey"},{default:o(()=>[k(y(h(G)),1)]),_:1}),e[2]||(e[2]=u("h3",{class:"mt-4 mb-2"},"購物車是空的",-1)),e[3]||(e[3]=u("p",{class:"text-grey"},"還沒有添加任何商品到購物車",-1)),l(f,{color:"primary",to:"/"},{default:o(()=>e[1]||(e[1]=[k("繼續購物",-1)])),_:1,__:[1]})]),_:1,__:[2,3]})):(p(),v(tt,{key:2,items:s.value,headers:z,loading:d.value},{"item.book.image":o(({item:t})=>[l(F,{src:t.book.image,alt:"Book Image","max-height":"100","max-width":"60"},null,8,["src"])]),"item.quantity":o(({item:t})=>[u("div",et,[l(f,{variant:"text",icon:h(K),color:"red",size:"small",disabled:r.value,onClick:i=>q(t.book._id,-1)},null,8,["icon","disabled","onClick"]),u("span",at,y(t.quantity),1),l(f,{variant:"text",icon:h(W),color:"green",size:"small",disabled:r.value,onClick:i=>q(t.book._id,1)},null,8,["icon","disabled","onClick"])])]),"item.action":o(({item:t})=>[l(f,{variant:"text",icon:h(J),color:"red",disabled:r.value,onClick:i=>B(t.book._id,t.quantity)},null,8,["icon","disabled","onClick"])]),"item.book.retailPrice":o(({item:t})=>[k("$"+y(t.book.retailPrice),1)]),"item.total":o(({item:t})=>[k("$"+y(t.book.retailPrice*t.quantity),1)]),_:2},1032,["items","loading"]))]),_:1}),s.value.length>0?(p(),v(w,{key:0,class:"text-center",cols:"12"},{default:o(()=>[l(L,{class:"pa-4"},{default:o(()=>[u("h3",null,"總金額: $"+y(D.value),1),l(f,{class:"mt-4",color:"green",size:"large",disabled:!P.value||_.value,loading:_.value,onClick:N},{default:o(()=>e[4]||(e[4]=[k("結帳",-1)])),_:1,__:[4]},8,["disabled","loading"])]),_:1})]),_:1})):Z("",!0)]),_:1}))}},kt=H(ot,[["__scopeId","data-v-8b612cba"]]);export{kt as default};
