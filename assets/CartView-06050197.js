var h=(_,r,s)=>new Promise((u,d)=>{var l=o=>{try{m(s.next(o))}catch(k){d(k)}},v=o=>{try{m(s.throw(o))}catch(k){d(k)}},m=o=>o.done?u(o.value):Promise.resolve(o.value).then(l,v);m((s=s.apply(_,r)).next())});import{u as I,a as S}from"./index-183e0965.js";import{O as D,r as C,j as x,k as N,G as $,H as i,a2 as A,X as M,F as T,I as n,ac as y,am as j,aw as F,a9 as G,a3 as g,a0 as w,a8 as B,M as V}from"./vue-vendor-5ccff89c.js";import"./vendor-913c4e2a.js";const H=V("h1",null,"購物車",-1),X={__name:"CartView",setup(_){const{apiAuth:r}=S(),s=D(),u=I(),d=M(),l=C([]),v=[{align:"center",sortable:!1,value:"name"},{title:"書本圖片",key:"book.image"},{title:"書本名稱",key:"book.title"},{title:"單價",key:"book.retailPrice"},{title:"數量",key:"quantity"},{title:"總價",key:"total",value:e=>e.book.retailPrice*e.quantity},{title:"操作",key:"action"}],m=x(()=>l.value.reduce((e,a)=>e+a.quantity*a.book.retailPrice,0)),o=(e,a)=>h(this,null,function*(){var t,c;if(!u.isLogin){d.push("/login");return}try{const{data:p}=yield r.patch("/users/cart",{book:e,quantity:a});u.cart=p.result,s({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}});const b=l.value.findIndex(q=>q.book._id===e);l.value[b].quantity+=a,l.value[b].quantity<=0&&l.value.splice(b,1)}catch(p){const b=((c=(t=p==null?void 0:p.response)==null?void 0:t.data)==null?void 0:c.message)||"發生錯誤，請稍後再試";s({text:b,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),k=x(()=>l.value.length>0),f=C(!1),P=()=>h(this,null,function*(){var e,a;f.value=!0;try{yield r.post("/orders"),u.cart=0,d.push("/orders"),s({text:"結帳成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(t){const c=((a=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";s({text:c,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}f.value=!1});return N(()=>h(this,null,function*(){var e,a;try{const{data:t}=yield r.get("/users/cart");l.value.push(...t.result)}catch(t){const c=((a=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";s({text:c,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}})),(e,a)=>(T(),$(A,null,{default:i(()=>[n(y,{cols:"12"},{default:i(()=>[H]),_:1}),n(j),n(y,{cols:"12"},{default:i(()=>[n(F,{items:l.value,headers:v},{"item.book.image":i(({item:t})=>[n(G,{src:t.book.image,alt:"Book Image","max-height":"100","max-width":"60"},null,8,["src"])]),"item.quantity":i(({item:t})=>[n(g,{variant:"text",icon:"mdi-minus",color:"red",onClick:c=>o(t.book._id,-1)},null,8,["onClick"]),w(B(t.quantity),1),n(g,{variant:"text",icon:"mdi-plus",color:"green",onClick:c=>o(t.book._id,1)},null,8,["onClick"])]),"item.action":i(({item:t})=>[n(g,{variant:"text",icon:"mdi-delete",color:"red",onClick:c=>o(t.book._id,t.quantity*-1)},null,8,["onClick"])]),_:2},1032,["items"])]),_:1}),n(y,{class:"text-center",cols:"12"},{default:i(()=>[V("p",null,"總金額: "+B(m.value),1),n(g,{color:"green",disabled:!k.value,loading:f.value,onClick:P},{default:i(()=>[w("結帳")]),_:1},8,["disabled","loading"])]),_:1})]),_:1}))}};export{X as default};
