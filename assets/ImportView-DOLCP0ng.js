import{b as g,D as ee,j as l,m as E,e as ae,o as le,a1 as I,a2 as o,a3 as B,l as G,ag as te,P as oe,u as s,ae as se,a8 as L,a6 as A}from"./vue-vendor-DIljl67C.js";import{c as re,a as q,d as ue}from"./index.esm-Czkp3GW_.js";import{u as ne,a as f}from"./vee-validate-7KorKqsb.js";import{y as ie,z as O,A as me,B as de,s as ce,w as pe,v as J,J as x,H as $,V as ve,r as fe,i as D,E as ge,G as be,ab as Ve}from"./index-C_tv00P6.js";import{j as ye,F as he,G as ke}from"./icons-BmvWcfYN.js";import{V as xe}from"./VContainer-CZi5Xp4O.js";import{V as U}from"./VRow-DuJyZejm.js";import{V as C}from"./VCol-nel5MGKg.js";import{V as Ce}from"./VForm-CzX7DFL9.js";import{V as K,m as we,a as Pe}from"./VChip-DFe582hF.js";import{g as Ie,p as Be,C as Ue,f as Re,ae as Me,o as Fe}from"./vuetify-vendor-CjpGIcAt.js";import{V as Se}from"./VTextarea-s-e-v81K.js";import"./VSelectionControl-CwyxR3d7.js";const Ae=Be({...de(),...Fe(we(),["inline"])},"VCheckbox"),je=Ie()({name:"VCheckbox",inheritAttrs:!1,props:Ae(),emits:{"update:modelValue":n=>!0,"update:focused":n=>!0},setup(n,j){let{attrs:i,slots:R}=j;const m=Ue(n,"modelValue"),{isFocused:p,focus:d,blur:c}=ie(n),u=g(),b=ee();return Re(()=>{const[w,_]=Me(i),T=O.filterProps(n),M=K.filterProps(n);return l(O,E({ref:u,class:["v-checkbox",n.class]},w,T,{modelValue:m.value,"onUpdate:modelValue":v=>m.value=v,id:n.id||`checkbox-${b}`,focused:p.value,style:n.style}),{...R,default:v=>{let{id:V,messagesId:y,isDisabled:h,isReadonly:P,isValid:k}=v;return l(K,E(M,{id:V.value,"aria-describedby":y.value,disabled:h.value,readonly:P.value},_,{error:k.value===!1,modelValue:m.value,"onUpdate:modelValue":F=>m.value=F,onFocus:d,onBlur:c}),R)}})}),me({},u)}}),He={__name:"ImportView",setup(n){const{apiAuth:j}=pe(),i=ce(),R=g(!1),m=g(!1),p=g(""),d=g(""),c=g(null),u=g(""),b=g(!1),w=ae(()=>u.value==="upload"&&c.value?URL.createObjectURL(c.value):u.value==="api"&&d.value?d.value:null),_=re({title:q().required("缺少商品名稱"),publisher:q().required("缺少出版者"),retailPrice:ue().typeError("書籍價格格式錯誤").required("缺少書籍價格").min(0,"書籍價格不能小於 0"),description:q().required("缺少簡介")}),{handleSubmit:T,resetForm:M}=ne({validationSchema:_,initialValues:{title:"",authors:"",publisher:"",retailPrice:"",categories:"",description:"",image:"",maturityRating:""}}),v=f("title"),V=f("authors"),y=f("publisher"),h=f("retailPrice"),P=f("categories"),k=f("description"),F=f("image"),H=f("maturityRating");le(b,t=>{H.value.value=t?"MATURE":"NOT_MATURE"});const W=t=>{const e=t.target.files[0];if(e){if(!["image/jpeg","image/png","image/jpg"].includes(e.type)){i({text:"只支援 JPG 和 PNG 格式",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),t.target.value="";return}if(e.size>1024*1024){i({text:"檔案大小不能超過 1MB",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),t.target.value="";return}c.value=e,u.value="upload",i({text:"圖片選取成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}},S=()=>{c.value=null,d.value="",u.value="",F.value.value="",document.querySelector('input[type="file"]')&&(document.querySelector('input[type="file"]').value="")},Q=()=>{M(),S(),p.value="",b.value=!1},X=(t,e=null)=>{const a=new FormData;return Object.keys(t).forEach(r=>{t[r]!==null&&t[r]!==void 0&&t[r]!==""&&a.append(r,t[r])}),e&&a.append("image",e),a},Y=T(async t=>{m.value=!0;try{let e;const a={};u.value==="upload"&&c.value?(console.log("準備提交含用戶圖片的資料..."),e=X(t,c.value),a["Content-Type"]="multipart/form-data"):(console.log("準備提交 JSON 資料..."),e={...t,image:u.value==="api"&&d.value?d.value:""},a["Content-Type"]="application/json"),console.log("準備提交數據:",e);const r=await j.post("/books",e,{headers:a});console.log("書籍創建成功:",r.data),i({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),Q()}catch(e){console.error("提交失敗:",e),console.error("錯誤詳情:",e.response?.data);const a=e?.response?.data?.message||"發生錯誤，請稍後再試";i({text:a,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}finally{m.value=!1}}),z=async()=>{if(p.value.trim())try{const t=/^\d{10}(\d{3})?$/.test(p.value),e=encodeURIComponent(p.value.trim()),{data:a}=await Ve.get(`https://www.googleapis.com/books/v1/volumes?q=${t?"isbn":"intitle"}:${e}`);if(console.log("Google Books API 回應:",a),a&&a.items&&a.items.length>0){const r=a.items[0].volumeInfo,N=a.items[0].saleInfo;v.value.value=r.title||"",V.value.value=r.authors?r.authors.join(", "):"",y.value.value=r.publisher||"",h.value.value=N.retailPrice?N.retailPrice.amount:"",P.value.value=r.categories?r.categories.join(", "):"",k.value.value=r.description||"";const Z=r.maturityRating||"";b.value=Z==="MATURE",r.imageLinks&&r.imageLinks.thumbnail?(d.value=r.imageLinks.thumbnail.replace("http://","https://").replace("img=1&zoom=1","img=2").replace("edge=curl",""),u.value="api",F.value.value=d.value,c.value=null,document.querySelector('input[type="file"]')&&(document.querySelector('input[type="file"]').value="")):S(),i({text:"引入成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}else i({text:"查無此書",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}catch(t){console.error("搜尋書籍錯誤:",t);const e=t?.response?.data?.message||"查無此書";i({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),M(),S()}};return(t,e)=>(B(),I(xe,null,{default:o(()=>[l(U,null,{default:o(()=>[l(C,{cols:"12"},{default:o(()=>e[9]||(e[9]=[G("h1",{class:"text-center"},"引入書籍",-1)])),_:1,__:[9]})]),_:1}),l(J,null,{default:o(()=>[l(U,null,{default:o(()=>[l(C,null,{default:o(()=>[l(x,{class:"mx-auto mt-5",modelValue:p.value,"onUpdate:modelValue":e[0]||(e[0]=a=>p.value=a),density:"comfortable","menu-icon":"",placeholder:"請輸入書籍名稱或13碼的isbn進行搜尋","prepend-inner-icon":s(ye),rounded:"",theme:"light",variant:"solo",style:oe({width:R.value?"100%":"500px"}),"onClick:append":z,onKeydown:te(z,["enter"])},null,8,["modelValue","prepend-inner-icon","style"])]),_:1})]),_:1})]),_:1}),l(U,null,{default:o(()=>[l(C,{class:"d-flex justify-center",cols:"12"},{default:o(()=>[l(Ce,{disabled:m.value,onSubmit:se(s(Y),["prevent"])},{default:o(()=>[l($,null,{default:o(()=>[l(U,{class:"flex justify-center align-center"},{default:o(()=>[l(C,null,{default:o(()=>[l($,{class:"d-flex justify-center align-center flex-column ml-4",outlined:"",style:{"min-height":"500px","min-width":"400px"}},{default:o(()=>[w.value?(B(),I(ve,{key:0,src:w.value,width:"350px",height:"500px",cover:""},null,8,["src"])):(B(),I(fe,{key:1,class:"mb-3",size:"100",color:"grey-lighten-2",icon:s(he)},null,8,["icon"])),u.value==="upload"?(B(),I(Pe,{key:2,class:"mb-3",color:"green",size:"small"},{default:o(()=>e[10]||(e[10]=[A("上傳圖片",-1)])),_:1,__:[10]})):L("",!0),l(D,{class:"mt-1",color:"primary","prepend-icon":s(ke),onClick:e[1]||(e[1]=a=>t.$refs.fileInput.click()),disabled:m.value},{default:o(()=>e[11]||(e[11]=[A("上傳自己的圖片",-1)])),_:1,__:[11]},8,["prepend-icon","disabled"]),G("input",{ref:"fileInput",type:"file",accept:"image/*",style:{display:"none"},onChange:W},null,544),w.value?(B(),I(D,{key:3,class:"mt-2",color:"error",variant:"text",size:"small",onClick:S},{default:o(()=>e[12]||(e[12]=[A("清除圖片",-1)])),_:1,__:[12]})):L("",!0)]),_:1})]),_:1}),l(C,{class:"me-5 mt-5"},{default:o(()=>[l(ge),l(x,{label:"書本名稱",modelValue:s(v).value.value,"onUpdate:modelValue":e[2]||(e[2]=a=>s(v).value.value=a),width:300,"error-messages":s(v).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"作者",modelValue:s(V).value.value,"onUpdate:modelValue":e[3]||(e[3]=a=>s(V).value.value=a),"error-messages":s(V).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"出版者",modelValue:s(y).value.value,"onUpdate:modelValue":e[4]||(e[4]=a=>s(y).value.value=a),"error-messages":s(y).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"價格",modelValue:s(h).value.value,"onUpdate:modelValue":e[5]||(e[5]=a=>s(h).value.value=a),"error-messages":s(h).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"分類",modelValue:s(P).value.value,"onUpdate:modelValue":e[6]||(e[6]=a=>s(P).value.value=a)},null,8,["modelValue"]),l($,{class:"pa-1 mb-6",outlined:"",style:{"background-color":"rgba(0,0,0,0.04)"}},{default:o(()=>[l(je,{label:"成人內容 (18+)",modelValue:b.value,"onUpdate:modelValue":e[7]||(e[7]=a=>b.value=a),"hide-details":""},null,8,["modelValue"])]),_:1}),l(Se,{label:"簡介",modelValue:s(k).value.value,"onUpdate:modelValue":e[8]||(e[8]=a=>s(k).value.value=a),"error-messages":s(k).errorMessage.value},null,8,["modelValue","error-messages"]),l(be)]),_:1})]),_:1}),l(U,{class:"text-center mb-5",cols:"12"},{default:o(()=>[l(C,null,{default:o(()=>[l(J),l(D,{color:"green",type:"submit",loading:m.value},{default:o(()=>e[13]||(e[13]=[A("送出",-1)])),_:1,__:[13]},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1})]),_:1}))}};export{He as default};
