var w=(x,h,f)=>new Promise((d,_)=>{var g=u=>{try{c(f.next(u))}catch(v){_(v)}},k=u=>{try{c(f.throw(u))}catch(v){_(v)}},c=u=>u.done?d(u.value):Promise.resolve(u.value).then(g,k);c((f=f.apply(x,h)).next())});import{r as C,O as j,X as E,k as Q,K as P,I as e,H as t,a2 as ee,ap as te,W as U,aq as le,F,ab as p,ac as r,a9 as ae,ae as T,a3 as S,u as y,a0 as B,a8 as b,M as m,G as A,R as oe,an as M,ao as q,ar as D,as as N,a1 as se,Y as ue,af as z,aa as ne,at as re,Z as ie,$ as de,au as H,av as ce}from"./vue-vendor-5ccff89c.js";import{u as me}from"./vendor-1de8772a.js";import{u as G,a as K}from"./index-79ded718.js";function ve(x){const{apiAuth:h}=K(),f=G(),d=C(!1),_=j(),g=E();return{isFavorite:d,checkFavoriteStatus:()=>w(this,null,function*(){try{const{data:u}=yield h.get("/users/favorite",{params:{bookId:x}});d.value=u.result.includes(x)}catch(u){console.error(u),d.value=!1}}),addFavorite:()=>w(this,null,function*(){if(!f.isLogin){g.push("/login");return}d.value=!d.value;try{const{data:u}=yield h.post("/users/favorite",{bookId:x,isFavorite:d.value});f.favorite=u.result,_({text:d.value?"已加入我的最愛":"已移除我的最愛",showCloseButton:!1,snackbarProps:{timeout:2e3,color:d.value?"green":"red",location:"bottom"}})}catch(u){console.error(u),u.response&&u.response.status===401?g.push("/login"):_({text:"發生錯誤，請稍後再試",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}})}}const fe=m("h3",null,"出版者:",-1),pe=m("h3",null,"價格:",-1),_e=m("h3",null,"分類:",-1),ge=m("h3",null,"簡介:",-1),be=["innerHTML"],he={key:1},ke=m("h3",null,"新增書評:",-1),Ve=m("h3",null,"書評:",-1),we=m("h3",null,"編輯書評",-1),Se={__name:"BookView",setup(x){const h=le(),f=E(),{api:d,apiAuth:_}=K(),g=C(!1),k=C(!1),c=j(),u=G(),v=C({usersId:"",rating:0,comment:""}),L=C(!1),{handleSubmit:I}=me({initialValues:{usersId:"",rating:0,comment:""}}),o=C({_id:"",image:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",buyLink:"",description:"",reviews:[]}),i=C([]),{isFavorite:$,checkFavoriteStatus:O,addFavorite:W}=ve(h.params.id),X=()=>{L.value=!1},R=I(s=>w(this,null,function*(){var l,a;if(console.log(v.value),!u.isLogin){f.push("/login"),c({text:"請先登入",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}});return}try{const{data:n}=yield _.post(`/books/${h.params.id}/reviews`,{rating:v.value.rating,conmment:v.value.comment});n&&n.result&&o.value.reviews.push(n.result),c({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(n){console.log(n);const V=((a=(l=n==null?void 0:n.response)==null?void 0:l.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";c({text:V,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}})),Y=s=>{if(s){const l=o.value.reviews.find(a=>a._id===s);i.value.id=l._id,i.value.rating=l.rating,i.value.comment=l.comment,i.value.bookId=o.value._id,console.log(i.value.bookId)}L.value=!0},Z=I(s=>w(this,null,function*(){var l,a;try{console.log(i.value),console.log("Form values:",s);const n=new FormData;for(const V in s)n.append(V,i.value[V]||s[V]);L.value===""&&(yield _.patch(`/books/${i.value.bookId}/reviews/${i.value.id}`,n)),console.log("FormData entries:",...n.entries()),c({text:"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(n){console.log(n);const V=((a=(l=n==null?void 0:n.response)==null?void 0:l.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";c({text:V,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}X()}));console.log(i.value),Q(()=>w(this,null,function*(){try{const{data:s}=yield d.get(`/books/${h.params.id}`);o.value._id=s.result._id,o.value.image=s.result.image,o.value.title=s.result.title,o.value.authors=s.result.authors,o.value.publisher=s.result.publisher,o.value.retailPrice=s.result.retailPrice,o.value.categories=s.result.categories,o.value.buyLink=s.result.buyLink;let l=s.result.description.replace(/(※|★|◆|✓|●|▓|▌|￭|──|【)/g,"<br>$1");l=l.replace(/(】)/g,"$1<br>"),l=l.replace(new RegExp("(?<=──[^,]*?)(?=,)","g"),"<br>$1"),o.value.description=l,o.value.reviews=s.result.reviews,document.title=`書評網 | ${o.value.title}`,yield O()}catch(s){console.log(s)}}));const J=()=>w(this,null,function*(){var s,l;if(!u.isLogin){f.push("/login");return}try{const{data:a}=yield _.patch("/users/cart",{book:o.value._id,quantity:1});u.cart=a.result,c({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(a){const n=((l=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:l.message)||"發生錯誤，請稍後再試";c({text:n,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}});return(s,l)=>(F(),P(U,null,[e(ee,null,{default:t(()=>[e(p,null,{default:t(()=>[e(r,{cols:"12",md:"3",style:{position:"sticky"},top:"0"},{default:t(()=>[e(ae,{src:o.value.image},null,8,["src"]),e(T,null,{default:t(()=>[e(p,{class:"justify-center align-center"},{default:t(()=>[e(r,{cols:"6"},{default:t(()=>[e(S,{"prepend-icon":y($)?"mdi-heart-minus":"mdi-heart-plus",color:y($)?"red":"blue",onClick:y(W)},{default:t(()=>[B(b(y($)?"取消最愛":"加入最愛"),1)]),_:1},8,["prepend-icon","color","onClick"])]),_:1}),e(r,{cols:"6"},{default:t(()=>[e(S,{color:"primary","prepend-icon":"mdi-cart",onClick:J},{default:t(()=>[B("加入購物車")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(r,{cols:"12",md:"9"},{default:t(()=>[m("h1",null,b(o.value.title),1),m("h2",null,b(o.value.authors),1),e(p,null,{default:t(()=>[e(r,{cols:"auto"},{default:t(()=>[fe]),_:1}),e(r,null,{default:t(()=>[m("p",null,b(o.value.publisher),1)]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(r,{cols:"auto"},{default:t(()=>[pe]),_:1}),e(r,null,{default:t(()=>[m("p",null,"$"+b(o.value.retailPrice),1)]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(r,{cols:"auto"},{default:t(()=>[_e]),_:1}),e(r,null,{default:t(()=>[m("p",null,b(o.value.categories),1)]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(r,{cols:"auto"},{default:t(()=>[ge,k.value?(F(),P("p",{key:0,innerHTML:o.value.description},null,8,be)):(F(),P("p",he,b(o.value.description.substring(0,500)),1))]),_:1}),e(r,{class:"text-center"},{default:t(()=>[o.value.description.length>100?(F(),A(S,{key:0,color:"#4d4637",onClick:l[0]||(l[0]=a=>k.value=!k.value),icon:k.value?"mdi-chevron-up":"mdi-chevron-down"},null,8,["icon"])):oe("",!0)]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(r,{cols:"12"},{default:t(()=>[ke,e(M,{disabled:g.value,onSubmit:q(y(R),["prevent"])},{default:t(()=>[e(D,{modelValue:v.value.rating,"onUpdate:modelValue":l[1]||(l[1]=a=>v.value.rating=a),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(N,{modelValue:v.value.comment,"onUpdate:modelValue":l[2]||(l[2]=a=>v.value.comment=a),label:"你的書評",required:""},null,8,["modelValue"]),e(S,{color:"#4d4637",type:"submit",loading:g.value},{default:t(()=>[B("提交")]),_:1},8,["loading"])]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(r,{cols:"12"},{default:t(()=>[Ve,e(se,null,{default:t(()=>[(F(!0),P(U,null,ue(o.value.reviews,a=>(F(),A(ie,{key:a._id},{default:t(()=>[e(z,null,{default:t(()=>[e(p,null,{default:t(()=>[e(r,{cols:"auto"},{default:t(()=>[e(de,{style:{fontSize:"30px"}},{default:t(()=>[B(b(a.user.account),1)]),_:2},1024)]),_:2},1024),e(r,{cols:"auto"},{default:t(()=>[e(H,null,{default:t(()=>[e(D,{modelValue:a.rating,"onUpdate:modelValue":n=>a.rating=n,color:"#4d4637 darken-3",size:"25",readonly:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),e(p,null,{default:t(()=>[e(r,{cols:"auto"},{default:t(()=>[e(ce,{class:"mb-5",style:{fontSize:"20px"}},{default:t(()=>[B(b(a.comment),1)]),_:2},1024)]),_:2},1024),e(r,{class:"d-flex justify-end"},{default:t(()=>[e(H,null,{default:t(()=>[e(S,{icon:"mdi-pencil",color:"#4d4637",onClick:()=>Y(a._id)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(te,{modelValue:L.value,"onUpdate:modelValue":l[6]||(l[6]=a=>L.value=a),"max-width":"290"},{default:t(()=>[e(M,{disabled:g.value,onSubmit:q(y(R),["prevent"])},{default:t(()=>[e(z,null,{default:t(()=>[e(ne,null,{default:t(()=>[we]),_:1}),e(re,null,{default:t(()=>[e(D,{modelValue:i.value.rating,"onUpdate:modelValue":l[3]||(l[3]=a=>i.value.rating=a),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(N,{modelValue:i.value.comment,"onUpdate:modelValue":l[4]||(l[4]=a=>i.value.comment=a),label:"你的書評",required:""},null,8,["modelValue"])]),_:1}),e(T,null,{default:t(()=>[e(S,{color:"#4d4637",onClick:l[5]||(l[5]=a=>y(Z)(s.review)),loading:g.value},{default:t(()=>[B("修正")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64))}};export{Se as default};
