import{j as t,P as le,n as oe,b as w,ac as K,af as se,H as re,a7 as I,a2 as a,F as D,a3 as V,u as i,a6 as x,Z as p,l as d,a1 as A,a8 as M,ae as N,ad as ne}from"./vue-vendor-DIljl67C.js";import{u as ue}from"./vee-validate-7KorKqsb.js";import{m as ie,t as W,s as Z,w as O,_ as de,J as ce,V as me,G as j,i as k,H as q,K as fe,E as ve,N as pe}from"./index-C9KdP_uT.js";import{h as ge,i as _e,c as be,q as Ve,r as ke,s as we}from"./icons-C5frdmYn.js";import{V as he}from"./VContainer-CZYKgrN-.js";import{V as m}from"./VRow-9HzZIeh6.js";import{V as r}from"./VCol-BpxVe32F.js";import{V as E}from"./VForm-BRoSrFSW.js";import{V as H}from"./VRating-BBpoT8CN.js";import{V as G}from"./VTextarea-PdDthxyk.js";import{V as ye,a as Ce,b as xe}from"./VList-CBNFvD2Q.js";import{g as Pe,p as Se,f as Be,a as Le}from"./vuetify-vendor-BSJ2BONf.js";import"./VDivider-Dc-frIgM.js";const Fe=Se({start:Boolean,end:Boolean,...Le(),...ie()},"VListItemAction"),J=Pe()({name:"VListItemAction",props:Fe(),setup(f,h){let{slots:y}=h;return Be(()=>t(f.tag,{class:oe(["v-list-item-action",{"v-list-item-action--start":f.start,"v-list-item-action--end":f.end},f.class]),style:le(f.style)},y)),{}}});function Ie(f){const{apiAuth:h}=O(),y=W(),c=w(!1),P=Z(),S=K();return{isFavorite:c,checkFavoriteStatus:async()=>{try{const{data:u}=await h.get("/users/favorite",{params:{bookId:f}});c.value=u.result.includes(f)}catch(u){console.error(u),c.value=!1}},addFavorite:async()=>{if(!y.isLogin){S.push("/login");return}c.value=!c.value;try{const{data:u}=await h.post("/users/favorite",{bookId:f,isFavorite:c.value});y.favorite=u.result,P({text:c.value?"已加入我的最愛":"已移除我的最愛",showCloseButton:!1,snackbarProps:{timeout:2e3,color:c.value?"green":"red",location:"bottom"}})}catch(u){console.error(u),u.response&&u.response.status===401?S.push("/login"):P({text:"發生錯誤，請稍後再試",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}}}const $e=["innerHTML"],Ue={key:1},Ae={class:"mb-3",style:{fontSize:"16px",lineHeight:"1.5",color:"#333"}},He={__name:"BookView",setup(f){const h=s=>s?`https://www.gravatar.com/avatar/${(F=>{let b=0;for(let U=0;U<F.length;U++){const ae=F.charCodeAt(U);b=(b<<5)-b+ae,b=b&b}return Math.abs(b).toString(16)})(s.toLowerCase().trim())}?d=identicon&s=120`:"https://www.gravatar.com/avatar/default?d=identicon&s=120",y=s=>!C.isLogin||!C._id?!1:s?.toString()===C._id.toString(),c=se(),P=K(),{api:S,apiAuth:B}=O(),v=w(!1),u=w(!1),g=Z(),C=W(),_=w({usersId:"",rating:0,comment:""}),L=w(!1),{handleSubmit:R}=ue({initialValues:{usersId:"",rating:0,comment:""}}),l=w({_id:"",image:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",buyLink:"",description:"",reviews:[]}),n=w({id:"",rating:0,comment:"",bookId:""}),{isFavorite:$,checkFavoriteStatus:Q,addFavorite:X}=Ie(c.params.id),T=()=>{L.value=!1,n.value={id:"",rating:0,comment:"",bookId:""}},Y=R(async s=>{if(!C.isLogin){P.push("/login"),g({text:"請先登入",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}});return}v.value=!0;try{const{data:e}=await B.post(`/books/${c.params.id}/reviews`,{rating:_.value.rating,comment:_.value.comment});e&&e.result&&(l.value.reviews.push(e.result),_.value={usersId:"",rating:0,comment:""}),g({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(e){console.log(e);const o=e?.response?.data?.message||"發生錯誤，請稍後再試";g({text:o,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}finally{v.value=!1}}),ee=s=>{if(s){const e=l.value.reviews.find(o=>o._id===s);e&&(n.value.id=e._id,n.value.rating=e.rating,n.value.comment=e.comment,n.value.bookId=l.value._id)}L.value=!0},z=R(async s=>{v.value=!0;try{await B.patch(`/books/${n.value.bookId}/reviews/${n.value.id}`,{rating:n.value.rating,comment:n.value.comment});const e=l.value.reviews.findIndex(o=>o._id===n.value.id);e!==-1&&(l.value.reviews[e].rating=n.value.rating,l.value.reviews[e].comment=n.value.comment),g({text:"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),T()}catch(e){console.log(e);const o=e?.response?.data?.message||"發生錯誤，請稍後再試";g({text:o,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}finally{v.value=!1}});re(async()=>{try{const{data:s}=await S.get(`/books/${c.params.id}`);l.value._id=s.result._id,l.value.image=s.result.image,l.value.title=s.result.title,l.value.authors=s.result.authors,l.value.publisher=s.result.publisher,l.value.retailPrice=s.result.retailPrice,l.value.categories=s.result.categories,l.value.buyLink=s.result.buyLink;let e=s.result.description.replace(/(※|★|◆|✓|●|▓|▌|￭|──|【)/g,"<br>$1");e=e.replace(/(】)/g,"$1<br>"),e=e.replace(new RegExp("(?<=──[^,]*?)(?=,)","g"),"<br>$1"),l.value.description=e,l.value.reviews=s.result.reviews,document.title=`書評網 | ${l.value.title}`,await Q()}catch(s){console.log(s)}});const te=async()=>{if(!C.isLogin){P.push("/login");return}try{const{data:s}=await B.patch("/users/cart",{book:l.value._id,quantity:1});C.cart=s.result,g({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(s){const e=s?.response?.data?.message||"發生錯誤，請稍後再試";g({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}};return(s,e)=>(V(),I(D,null,[t(he,null,{default:a(()=>[t(m,null,{default:a(()=>[t(r,{cols:"12",md:"3",style:{position:"sticky"},top:"0"},{default:a(()=>[t(me,{src:l.value.image},null,8,["src"]),t(j,null,{default:a(()=>[t(m,{class:"justify-center align-center"},{default:a(()=>[t(r,{cols:"6"},{default:a(()=>[t(k,{"prepend-icon":i($)?i(ge):i(_e),color:i($)?"red":"blue",onClick:i(X)},{default:a(()=>[x(p(i($)?"取消最愛":"加入最愛"),1)]),_:1},8,["prepend-icon","color","onClick"])]),_:1}),t(r,{cols:"6"},{default:a(()=>[t(k,{color:"primary","prepend-icon":i(be),onClick:te},{default:a(()=>e[6]||(e[6]=[x("加入購物車",-1)])),_:1,__:[6]},8,["prepend-icon"])]),_:1})]),_:1})]),_:1})]),_:1}),t(r,{cols:"12",md:"9"},{default:a(()=>[d("h1",null,p(l.value.title),1),d("h2",null,p(l.value.authors),1),t(m,null,{default:a(()=>[t(r,{cols:"auto"},{default:a(()=>e[7]||(e[7]=[d("h3",null,"出版者:",-1)])),_:1,__:[7]}),t(r,null,{default:a(()=>[d("p",null,p(l.value.publisher),1)]),_:1})]),_:1}),t(m,null,{default:a(()=>[t(r,{cols:"auto"},{default:a(()=>e[8]||(e[8]=[d("h3",null,"價格:",-1)])),_:1,__:[8]}),t(r,null,{default:a(()=>[d("p",null,"$"+p(l.value.retailPrice),1)]),_:1})]),_:1}),t(m,null,{default:a(()=>[t(r,{cols:"auto"},{default:a(()=>e[9]||(e[9]=[d("h3",null,"分類:",-1)])),_:1,__:[9]}),t(r,null,{default:a(()=>[d("p",null,p(l.value.categories),1)]),_:1})]),_:1}),t(m,null,{default:a(()=>[t(r,{cols:"auto"},{default:a(()=>[e[10]||(e[10]=d("h3",null,"簡介:",-1)),u.value?(V(),I("p",{key:0,innerHTML:l.value.description},null,8,$e)):(V(),I("p",Ue,p(l.value.description.substring(0,500)),1))]),_:1,__:[10]}),t(r,{class:"text-center"},{default:a(()=>[l.value.description.length>100?(V(),A(k,{key:0,color:"#4d4637",onClick:e[0]||(e[0]=o=>u.value=!u.value),icon:u.value?i(Ve):i(ke)},null,8,["icon"])):M("",!0)]),_:1})]),_:1}),t(m,null,{default:a(()=>[t(r,{cols:"12"},{default:a(()=>[e[12]||(e[12]=d("h3",null,"新增書評:",-1)),t(E,{disabled:v.value,onSubmit:N(i(Y),["prevent"])},{default:a(()=>[t(H,{modelValue:_.value.rating,"onUpdate:modelValue":e[1]||(e[1]=o=>_.value.rating=o),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),t(G,{modelValue:_.value.comment,"onUpdate:modelValue":e[2]||(e[2]=o=>_.value.comment=o),label:"你的書評",required:""},null,8,["modelValue"]),t(k,{color:"#4d4637",type:"submit",loading:v.value},{default:a(()=>e[11]||(e[11]=[x("提交",-1)])),_:1,__:[11]},8,["loading"])]),_:1},8,["disabled","onSubmit"])]),_:1,__:[12]})]),_:1}),t(m,null,{default:a(()=>[t(r,{cols:"12"},{default:a(()=>[e[13]||(e[13]=d("h3",null,"書評:",-1)),t(ye,null,{default:a(()=>[(V(!0),I(D,null,ne(l.value.reviews,o=>(V(),A(Ce,{key:o._id},{default:a(()=>[t(q,null,{default:a(()=>[t(m,{class:"align-center"},{default:a(()=>[t(r,{cols:"auto"},{default:a(()=>[t(fe,{image:h(o.user.account),size:"60"},null,8,["image"])]),_:2},1024),t(r,null,{default:a(()=>[t(m,null,{default:a(()=>[t(r,{cols:"auto"},{default:a(()=>[t(xe,{style:{fontSize:"24px",fontWeight:"bold"}},{default:a(()=>[x(p(o.user.account),1)]),_:2},1024)]),_:2},1024),t(r,{cols:"auto"},{default:a(()=>[t(J,null,{default:a(()=>[t(H,{modelValue:o.rating,"onUpdate:modelValue":F=>o.rating=F,color:"#4d4637 darken-3",size:"20",readonly:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),t(m,null,{default:a(()=>[t(r,{cols:"12"},{default:a(()=>[d("p",Ae,p(o.comment),1)]),_:2},1024)]),_:2},1024)]),_:2},1024),t(r,{class:"d-flex justify-end",cols:"auto"},{default:a(()=>[y(o.user._id)?(V(),A(J,{key:0},{default:a(()=>[t(k,{icon:i(we),color:"#4d4637",size:"small",onClick:()=>ee(o._id)},null,8,["icon","onClick"])]),_:2},1024)):M("",!0)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1,__:[13]})]),_:1})]),_:1})]),_:1})]),_:1}),t(ce,{modelValue:L.value,"onUpdate:modelValue":e[5]||(e[5]=o=>L.value=o),"max-width":"400"},{default:a(()=>[t(E,{disabled:v.value,onSubmit:N(i(z),["prevent"])},{default:a(()=>[t(q,null,{default:a(()=>[t(ve,{class:"text-center py-4"},{default:a(()=>e[14]||(e[14]=[d("h3",null,"編輯書評",-1)])),_:1,__:[14]}),t(pe,null,{default:a(()=>[t(H,{class:"mb-4",modelValue:n.value.rating,"onUpdate:modelValue":e[3]||(e[3]=o=>n.value.rating=o),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),t(G,{modelValue:n.value.comment,"onUpdate:modelValue":e[4]||(e[4]=o=>n.value.comment=o),label:"你的書評",required:"",rows:"4"},null,8,["modelValue"])]),_:1}),t(j,{class:"justify-center pb-4"},{default:a(()=>[t(k,{class:"mr-2",color:"grey",variant:"outlined",onClick:T},{default:a(()=>e[15]||(e[15]=[x("取消",-1)])),_:1,__:[15]}),t(k,{color:"#4d4637",onClick:i(z),loading:v.value},{default:a(()=>e[16]||(e[16]=[x("修正",-1)])),_:1,__:[16]},8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64))}},Ze=de(He,[["__scopeId","data-v-2a8eff64"]]);export{Ze as default};
