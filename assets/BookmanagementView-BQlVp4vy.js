import{m as ue,h as O,t as V,n as t,v as z,y as b,F as J,p as ne,d as i,a1 as U,a2 as r,a3 as F,a6 as p,ag as ie,a8 as de,Z as me}from"./vue-vendor-BLj5oUxN.js";import{_ as pe,s as ce,w as ve,i as R,V as W,I as D,J as ge,H as L,E as Z,K as M,T as fe,r as $,G as be,v as ye}from"./index-U2vFlqRl.js";import{V as Ve}from"./VContainer-BcJpgH9G.js";import{V as Q}from"./VRow-B31iD-oS.js";import{V as q}from"./VCol-BxUbbmnY.js";import{c as ke,a as Pe,b as xe,d as he,u as we,p as De,e as Se,f as Ce,g as _e,h as Te,i as Be,j as Ie,k as X,l as Y,m as ee,n as ae,o as Ue,q as Fe,r as Re}from"./VDataTable-Evll_vMq.js";import{g as Le,p as qe,l as Ae,f as Ee}from"./vuetify-vendor-BJLvFpJU.js";import{V as He}from"./VDivider-Ck6QiYlQ.js";import{V as je}from"./VForm-C8i5rr7m.js";import{V as Ge}from"./VAlert-CnL3sRm-.js";import{V as Ne}from"./VTextarea-C_j90rkH.js";import"./VList-T7MCEX3S.js";import"./VChip-tn9s2HSv.js";import"./VSelectionControl-jcQEbmuu.js";const Oe=qe({itemsLength:{type:[Number,String],required:!0},...Re(),...Fe(),...Ue()},"VDataTableServer"),$e=Le()({name:"VDataTableServer",props:Oe(),emits:{"update:modelValue":l=>!0,"update:page":l=>!0,"update:itemsPerPage":l=>!0,"update:sortBy":l=>!0,"update:options":l=>!0,"update:expanded":l=>!0,"update:groupBy":l=>!0},setup(l,k){let{attrs:y,slots:u}=k;const{groupBy:c}=ke(l),{sortBy:d,multiSort:S,mustSort:A}=Pe(l),{page:f,itemsPerPage:P}=xe(l),{disableSort:x}=ue(l),h=O(()=>parseInt(l.itemsLength,10)),{columns:o,headers:v}=he(l,{groupBy:c,showSelect:V(()=>l.showSelect),showExpand:V(()=>l.showExpand)}),{items:n}=we(l,o),{toggleSort:w}=De({sortBy:d,multiSort:S,mustSort:A,page:f}),{opened:C,isGroupOpen:_,toggleGroup:E,extractRows:g}=Se({groupBy:c,sortBy:d,disableSort:x}),{pageCount:H,setItemsPerPage:T}=Ce({page:f,itemsPerPage:P,itemsLength:h}),{flatItems:B}=_e(n,c,C),{isSelected:I,select:j,selectAll:a,toggleSelect:e,someSelected:s,allSelected:G}=Te(l,{allItems:n,currentPage:n}),{isExpanded:te,toggleExpand:le}=Be(l),K=O(()=>g(n.value));Ie({page:f,itemsPerPage:P,sortBy:d,groupBy:c,search:V(()=>l.search)}),ne("v-data-table",{toggleSort:w,sortBy:d}),Ae({VDataTableRows:{hideNoData:V(()=>l.hideNoData),noDataText:V(()=>l.noDataText),loading:V(()=>l.loading),loadingText:V(()=>l.loadingText)}});const m=O(()=>({page:f.value,itemsPerPage:P.value,sortBy:d.value,pageCount:H.value,toggleSort:w,setItemsPerPage:T,someSelected:s.value,allSelected:G.value,isSelected:I,select:j,selectAll:a,toggleSelect:e,isExpanded:te,toggleExpand:le,isGroupOpen:_,toggleGroup:E,items:K.value.map(N=>N.raw),internalItems:K.value,groupedItems:B.value,columns:o.value,headers:v.value}));Ee(()=>{const N=X.filterProps(l),oe=Y.filterProps(l),se=ee.filterProps(l),re=ae.filterProps(l);return t(ae,z({class:["v-data-table",{"v-data-table--loading":l.loading},l.class],style:l.style},re,{fixedHeader:l.fixedHeader||l.sticky}),{top:()=>u.top?.(m.value),default:()=>u.default?u.default(m.value):b(J,null,[u.colgroup?.(m.value),!l.hideDefaultHeader&&b("thead",{key:"thead",class:"v-data-table__thead",role:"rowgroup"},[t(Y,oe,u)]),u.thead?.(m.value),!l.hideDefaultBody&&b("tbody",{class:"v-data-table__tbody",role:"rowgroup"},[u["body.prepend"]?.(m.value),u.body?u.body(m.value):t(ee,z(y,se,{items:B.value}),u),u["body.append"]?.(m.value)]),u.tbody?.(m.value),u.tfoot?.(m.value)]),bottom:()=>u.bottom?u.bottom(m.value):!l.hideDefaultFooter&&b(J,null,[t(He,null,null),t(X,N,{prepend:u["footer.prepend"]})])})})}}),Ke={class:"text-center"},ze={__name:"BookmanagementView",setup(l){const{apiAuth:k}=ve(),y=ce(),u=i(10),c=i([{key:"createdAt",order:"desc"}]),d=i(1),S=i([]),A=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"title"},{title:"作者",align:"center",sortable:!0,key:"authors"},{title:"出版者",align:"center",sortable:!0,key:"publisher"},{title:"價格",align:"center",sortable:!0,key:"retailPrice"},{title:"分類",align:"center",sortable:!0,key:"categories"},{title:"編輯",align:"center",sortable:!1,key:"edit"},{title:"刪除",align:"center",sortable:!1,key:"delete"}],f=i(!0),P=i(0),x=i(""),h=i(!1),o=i({_id:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",description:"",image:""}),v=i(null),n=i(""),w=i(!1),C=()=>n.value?n.value:o.value.image||"",_=()=>{const a=document.querySelector('input[type="file"]');a&&a.click()},E=a=>{const e=a.target.files[0];e&&(v.value=e,n.value&&URL.revokeObjectURL(n.value),n.value=URL.createObjectURL(e))},g=async()=>{f.value=!0;try{const{data:a}=await k.get("/books/all",{params:{page:d.value,itemsPerPage:u.value,sortBy:c.value[0]?.key||"createdAt",sortOrder:c.value[0]?.order==="asc"?1:-1,search:x.value}});S.value.splice(0,S.value.length,...a.result.data),P.value=a.result.total}catch(a){console.log(a);const e=a?.response?.data?.message||"發生錯誤，請稍後再試";y({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}f.value=!1};g();const H=async a=>{if(console.log(a),!a._id){console.error("沒有書籍 ID");return}try{await k.delete(`/books/${a._id}`),y({text:"書籍已成功刪除",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),g()}catch(e){console.log(e);const s=e?.response?.data?.message||"刪除書籍時發生錯誤，請稍後再試";y({text:s,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}},T=()=>{d.value=1,g()},B=a=>{o.value={...a,image:a.image||""},h.value=!0,v.value=null,n.value=""},I=()=>{h.value=!1,v.value=null,n.value&&(URL.revokeObjectURL(n.value),n.value="");const a=document.querySelector('input[type="file"]');a&&(a.value="")},j=async()=>{w.value=!0;try{if(v.value){const a=new FormData;a.append("image",v.value),a.append("title",o.value.title),a.append("authors",o.value.authors),a.append("publisher",o.value.publisher),a.append("retailPrice",o.value.retailPrice),a.append("categories",o.value.categories),a.append("description",o.value.description),await k.patch(`/books/${o.value._id}`,a,{headers:{"Content-Type":"multipart/form-data"}})}else{const a={title:o.value.title,authors:o.value.authors,publisher:o.value.publisher,retailPrice:parseFloat(o.value.retailPrice)||0,categories:o.value.categories,description:o.value.description};await k.patch(`/books/${o.value._id}`,a)}y({text:"書籍已成功更新",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),g(),I()}catch(a){console.error("更新書籍失敗:",a);let e="更新書籍時發生錯誤，請稍後再試";a?.response?.status===404?e="找不到書籍":a?.response?.status===400?e=a?.response?.data?.message||"ID 格式錯誤":a?.response?.data?.message&&(e=a.response.data.message),y({text:e,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"red",location:"bottom"}})}w.value=!1};return(a,e)=>(F(),U(Ve,null,{default:r(()=>[t(Q,null,{default:r(()=>[t(q,{cols:"12"},{default:r(()=>[t($e,{"items-per-page":u.value,"onUpdate:itemsPerPage":[e[1]||(e[1]=s=>u.value=s),g],"sort-by":c.value,"onUpdate:sortBy":[e[2]||(e[2]=s=>c.value=s),g],page:d.value,"onUpdate:page":[e[3]||(e[3]=s=>d.value=s),g],items:S.value,headers:A,loading:f.value,"items-length":P.value,search:x.value,hover:""},{top:r(()=>[t(D,{label:"搜尋","append-icon":"mdi-magnify",modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=s=>x.value=s),"onClick:append":T,onKeydown:ie(T,["enter"])},null,8,["modelValue"])]),"item.image":r(({item:s})=>[t(W,{src:s.image,width:"80",height:"80",cover:""},null,8,["src"])]),"item.edit":r(({item:s})=>[t(R,{onClick:G=>B(s)},{default:r(()=>e[11]||(e[11]=[p("編輯",-1)])),_:2,__:[11]},1032,["onClick"])]),"item.delete":r(({item:s})=>[t(R,{onClick:G=>H(s)},{default:r(()=>e[12]||(e[12]=[p("刪除",-1)])),_:2,__:[12]},1032,["onClick"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"]),t(ge,{modelValue:h.value,"onUpdate:modelValue":e[10]||(e[10]=s=>h.value=s),persistent:"","max-width":"700px"},{default:r(()=>[t(L,null,{default:r(()=>[t(Z,null,{default:r(()=>e[13]||(e[13]=[p("編輯書籍",-1)])),_:1,__:[13]}),t(M,null,{default:r(()=>[t(je,{ref:"editForm"},{default:r(()=>[t(Q,null,{default:r(()=>[t(q,{cols:"12",md:"6"},{default:r(()=>[t(D,{modelValue:o.value.title,"onUpdate:modelValue":e[4]||(e[4]=s=>o.value.title=s),label:"書名",required:""},null,8,["modelValue"]),t(D,{modelValue:o.value.authors,"onUpdate:modelValue":e[5]||(e[5]=s=>o.value.authors=s),label:"作者",required:""},null,8,["modelValue"]),t(D,{modelValue:o.value.publisher,"onUpdate:modelValue":e[6]||(e[6]=s=>o.value.publisher=s),label:"出版者",required:""},null,8,["modelValue"]),t(D,{modelValue:o.value.retailPrice,"onUpdate:modelValue":e[7]||(e[7]=s=>o.value.retailPrice=s),label:"價格",required:"",type:"number"},null,8,["modelValue"]),t(D,{modelValue:o.value.categories,"onUpdate:modelValue":e[8]||(e[8]=s=>o.value.categories=s),label:"分類",required:""},null,8,["modelValue"])]),_:1}),t(q,{cols:"12",md:"6"},{default:r(()=>[t(L,{outlined:""},{default:r(()=>[t(Z,null,{default:r(()=>e[14]||(e[14]=[p("書籍圖片",-1)])),_:1,__:[14]}),t(M,null,{default:r(()=>[C()?(F(),U(L,{key:0,class:"image-upload-area mb-3 d-flex align-center justify-center",onClick:_,hover:""},{default:r(()=>[t(W,{class:"mx-auto",src:C(),"max-height":"200","max-width":"100%",contain:""},null,8,["src"]),t(fe,{class:"align-center justify-center hover-overlay","model-value":!1,style:{position:"absolute",top:"0",left:"0",right:"0",bottom:"0",background:"rgba(0,0,0,0.5)",opacity:"0",transition:"opacity 0.3s"}},{default:r(()=>[t($,{color:"white",size:"48"},{default:r(()=>e[15]||(e[15]=[p("mdi-camera",-1)])),_:1,__:[15]}),e[16]||(e[16]=b("div",{style:{color:"white","margin-top":"8px"}},"點擊更換圖片",-1))]),_:1,__:[16]})]),_:1})):(F(),U(L,{key:1,class:"image-upload-area mb-3 d-flex align-center justify-center",onClick:_,hover:""},{default:r(()=>[b("div",Ke,[t($,{size:"64",color:"grey"},{default:r(()=>e[17]||(e[17]=[p("mdi-camera-plus",-1)])),_:1,__:[17]}),e[18]||(e[18]=b("div",{class:"mt-2 text-grey"},"點擊上傳圖片",-1))])]),_:1})),b("input",{ref:"fileInput",type:"file",accept:"image/*",style:{display:"none"},onChange:E},null,544),v.value?(F(),U(Ge,{key:2,class:"mt-3",type:"info",variant:"tonal"},{default:r(()=>[t($,{class:"mr-2"},{default:r(()=>e[19]||(e[19]=[p("mdi-file-image",-1)])),_:1,__:[19]}),p("已選擇: "+me(v.value.name),1)]),_:1})):de("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),t(q,{cols:"12"},{default:r(()=>[t(Ne,{modelValue:o.value.description,"onUpdate:modelValue":e[9]||(e[9]=s=>o.value.description=s),label:"簡介",rows:"5"},null,8,["modelValue"])]),_:1})]),_:1},512)]),_:1}),t(be,null,{default:r(()=>[t(ye),t(R,{color:"blue darken-1",variant:"text",onClick:I},{default:r(()=>e[20]||(e[20]=[p("取消",-1)])),_:1,__:[20]}),t(R,{color:"blue darken-1",variant:"text",onClick:j,loading:w.value},{default:r(()=>e[21]||(e[21]=[p("保存",-1)])),_:1,__:[21]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}))}},ua=pe(ze,[["__scopeId","data-v-9e024360"]]);export{ua as default};
