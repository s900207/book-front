import{Y as P,Z as q,X as S,x as f,o as g,A,a0 as D,a2 as I,a3 as l,ab as N,c as a,V as $,J as u,a8 as v,aa as y,an as _}from"./index-f822e752.js";import{V as T}from"./VContainer-19829c7d.js";import{V as b}from"./VCol-9fe9712b.js";import{V as J}from"./VDivider-6b83265f.js";import{V as L}from"./VDataTable-c55a8821.js";import"https://s900207.github.io/book-front/assets/materialdesignicons-webfont-61e8aba5.ttf";import"https://s900207.github.io/book-front/assets/materialdesignicons-webfont-a5928a0d.woff";import"https://s900207.github.io/book-front/assets/materialdesignicons-webfont-662fefa8.woff2";import"./VList-d7072f41.js";import"./VSelectionControl-476dede5.js";const M=_("h1",null,"購物車",-1),K={__name:"CartView",setup(R){const{apiAuth:d}=N(),r=P(),m=q(),h=S(),n=f([]),x=[{align:"center",sortable:!1,value:"name"},{title:"書本圖片",key:"book.image"},{title:"書本名稱",key:"book.title"},{title:"單價",key:"book.retailPrice"},{title:"數量",key:"quantity"},{title:"總價",key:"total",value:e=>e.book.retailPrice*e.quantity},{title:"操作",key:"action"}],C=g(()=>n.value.reduce((e,o)=>e+o.quantity*o.book.retailPrice,0)),p=async(e,o)=>{var t,s;if(!m.isLogin){h.push("/login");return}try{const{data:i}=await d.patch("/users/cart",{book:e,quantity:o});m.cart=i.result,r({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}});const c=n.value.findIndex(B=>B.book._id===e);n.value[c].quantity+=o,n.value[c].quantity<=0&&n.value.splice(c,1)}catch(i){const c=((s=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:s.message)||"發生錯誤，請稍後再試";r({text:c,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}},V=g(()=>n.value.length>0),k=f(!1),w=async()=>{var e,o;k.value=!0;try{await d.post("/orders"),m.cart=0,h.push("/orders"),r({text:"結帳成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(t){const s=((o=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:o.message)||"發生錯誤，請稍後再試";r({text:s,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}k.value=!1};return A(async()=>{var e,o;try{const{data:t}=await d.get("/users/cart");n.value.push(...t.result)}catch(t){const s=((o=(e=t==null?void 0:t.response)==null?void 0:e.data)==null?void 0:o.message)||"發生錯誤，請稍後再試";r({text:s,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),(e,o)=>(D(),I(T,null,{default:l(()=>[a(b,{cols:"12"},{default:l(()=>[M]),_:1}),a(J),a(b,{cols:"12"},{default:l(()=>[a(L,{items:n.value,headers:x},{"item.book.image":l(({item:t})=>[a($,{src:t.book.image,alt:"Book Image","max-height":"100","max-width":"60"},null,8,["src"])]),"item.quantity":l(({item:t})=>[a(u,{variant:"text",icon:"mdi-minus",color:"red",onClick:s=>p(t.book._id,-1)},null,8,["onClick"]),v(y(t.quantity),1),a(u,{variant:"text",icon:"mdi-plus",color:"green",onClick:s=>p(t.book._id,1)},null,8,["onClick"])]),"item.action":l(({item:t})=>[a(u,{variant:"text",icon:"mdi-delete",color:"red",onClick:s=>p(t.book._id,t.quantity*-1)},null,8,["onClick"])]),_:2},1032,["items"])]),_:1}),a(b,{class:"text-center",cols:"12"},{default:l(()=>[_("p",null,"總金額: "+y(C.value),1),a(u,{color:"green",disabled:!V.value,loading:k.value,onClick:w},{default:l(()=>[v("結帳")]),_:1},8,["disabled","loading"])]),_:1})]),_:1}))}};export{K as default};
