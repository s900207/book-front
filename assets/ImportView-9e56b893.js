import{p as te,ac as oe,a_ as se,g as ue,D as re,ae as ne,af as ie,o as X,u as ce,ag as de,ah as G,c as a,G as O,X as me,x as h,z as pe,$ as B,a0 as t,ab as ve,a5 as _,at as P,bC as fe,aC as ge,a9 as J,ay as be,a7 as s,aq as D,V as Ve,W as he,a8 as M,a1 as K,J as z,an as H,al as ye,ao as xe,bD as ke}from"./index-6851ac4d.js";import{c as Ce,a as N,d as Pe}from"./index.esm-3d8b24aa.js";import{u as we,a as b}from"./vee-validate.esm-238e7707.js";import{V as Ie}from"./VContainer-622fefbb.js";import{V as w}from"./VCol-b84c0405.js";import{V as R}from"./VRow-4fc3757b.js";import{V as Ue}from"./VForm-fda22642.js";import{m as Be,V as W,a as _e}from"./VChip-12f9ec26.js";import{V as Me}from"./VTextarea-e9691060.js";import"./VSelectionControl-b27dd453.js";const Re=te({...oe(),...se(Be(),["inline"])},"VCheckbox"),Se=ue()({name:"VCheckbox",inheritAttrs:!1,props:Re(),emits:{"update:modelValue":i=>!0,"update:focused":i=>!0},setup(i,j){let{attrs:c,slots:S}=j;const d=re(i,"modelValue"),{isFocused:f,focus:p,blur:v}=ne(i),m=ie(),V=X(()=>i.id||`checkbox-${m}`);return ce(()=>{const[I,q]=de(c),T=G.filterProps(i),F=W.filterProps(i);return a(G,O({class:["v-checkbox",i.class]},I,T,{modelValue:d.value,"onUpdate:modelValue":g=>d.value=g,id:V.value,focused:f.value,style:i.style}),{...S,default:g=>{let{id:y,messagesId:x,isDisabled:k,isReadonly:U}=g;return a(W,O(F,{id:y.value,"aria-describedby":x.value,disabled:k.value,readonly:U.value},q,{modelValue:d.value,"onUpdate:modelValue":C=>d.value=C,onFocus:p,onBlur:v}),S)}})}),{}}}),Fe=H("h1",{class:"text-center"},"引入書籍",-1),Ge={__name:"ImportView",setup(i){const{apiAuth:j}=ve(),c=me(),S=h(!1),d=h(!1),f=h(""),p=h(""),v=h(null),m=h(""),V=h(!1),I=X(()=>m.value==="upload"&&v.value?URL.createObjectURL(v.value):m.value==="api"&&p.value?p.value:null),q=Ce({title:N().required("缺少商品名稱"),publisher:N().required("缺少出版者"),retailPrice:Pe().typeError("書籍價格格式錯誤").required("缺少書籍價格").min(0,"書籍價格不能小於 0"),description:N().required("缺少簡介")}),{handleSubmit:T,resetForm:F}=we({validationSchema:q,initialValues:{title:"",authors:"",publisher:"",retailPrice:"",categories:"",description:"",image:"",maturityRating:""}}),g=b("title"),y=b("authors"),x=b("publisher"),k=b("retailPrice"),U=b("categories"),C=b("description"),E=b("image"),Q=b("maturityRating");pe(V,o=>{Q.value.value=o?"MATURE":"NOT_MATURE"});const Y=o=>{const e=o.target.files[0];if(e){if(!["image/jpeg","image/png","image/jpg"].includes(e.type)){c({text:"只支援 JPG 和 PNG 格式",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),o.target.value="";return}if(e.size>1024*1024){c({text:"檔案大小不能超過 1MB",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),o.target.value="";return}v.value=e,m.value="upload",c({text:"圖片選取成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}},A=()=>{v.value=null,p.value="",m.value="",E.value.value="",document.querySelector('input[type="file"]')&&(document.querySelector('input[type="file"]').value="")},Z=()=>{F(),A(),f.value="",V.value=!1},ee=(o,e=null)=>{const l=new FormData;return Object.keys(o).forEach(n=>{o[n]!==null&&o[n]!==void 0&&o[n]!==""&&l.append(n,o[n])}),e&&l.append("image",e),l},ae=T(async o=>{var e,l,n;d.value=!0;try{let u;const r={};m.value==="upload"&&v.value?(console.log("準備提交含用戶圖片的資料..."),u=ee(o,v.value),r["Content-Type"]="multipart/form-data"):(console.log("準備提交 JSON 資料..."),u={...o,image:m.value==="api"&&p.value?p.value:""},r["Content-Type"]="application/json"),console.log("準備提交數據:",u);const $=await j.post("/books",u,{headers:r});console.log("書籍創建成功:",$.data),c({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),Z()}catch(u){console.error("提交失敗:",u),console.error("錯誤詳情:",(e=u.response)==null?void 0:e.data);const r=((n=(l=u==null?void 0:u.response)==null?void 0:l.data)==null?void 0:n.message)||"發生錯誤，請稍後再試";c({text:r,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}finally{d.value=!1}}),L=async()=>{var o,e;if(f.value.trim())try{const l=/^\d{10}(\d{3})?$/.test(f.value),n=encodeURIComponent(f.value.trim()),{data:u}=await ke.get(`https://www.googleapis.com/books/v1/volumes?q=${l?"isbn":"intitle"}:${n}`);if(console.log("Google Books API 回應:",u),u&&u.items&&u.items.length>0){const r=u.items[0].volumeInfo,$=u.items[0].saleInfo;g.value.value=r.title||"",y.value.value=r.authors?r.authors.join(", "):"",x.value.value=r.publisher||"",k.value.value=$.retailPrice?$.retailPrice.amount:"",U.value.value=r.categories?r.categories.join(", "):"",C.value.value=r.description||"";const le=r.maturityRating||"";V.value=le==="MATURE",r.imageLinks&&r.imageLinks.thumbnail?(p.value=r.imageLinks.thumbnail.replace("http://","https://").replace("img=1&zoom=1","img=2").replace("edge=curl",""),m.value="api",E.value.value=p.value,v.value=null,document.querySelector('input[type="file"]')&&(document.querySelector('input[type="file"]').value="")):A(),c({text:"引入成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}else c({text:"查無此書",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}catch(l){console.error("搜尋書籍錯誤:",l);const n=((e=(o=l==null?void 0:l.response)==null?void 0:o.data)==null?void 0:e.message)||"查無此書";c({text:n,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),F(),A()}};return(o,e)=>(_(),B(Ie,null,{default:t(()=>[a(R,null,{default:t(()=>[a(w,{cols:"12"},{default:t(()=>[Fe]),_:1})]),_:1}),a(J,null,{default:t(()=>[a(R,null,{default:t(()=>[a(w,null,{default:t(()=>[a(P,{class:"mx-auto mt-5",modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=l=>f.value=l),density:"comfortable","menu-icon":"",placeholder:"請輸入書籍名稱或13碼的isbn進行搜尋","prepend-inner-icon":"mdi-magnify",rounded:"",theme:"light",variant:"solo",style:fe({width:S.value?"100%":"500px"}),"onClick:append":L,onKeydown:ge(L,["enter"])},null,8,["modelValue","style"])]),_:1})]),_:1})]),_:1}),a(R,null,{default:t(()=>[a(w,{class:"d-flex justify-center",cols:"12"},{default:t(()=>[a(Ue,{disabled:d.value,onSubmit:be(s(ae),["prevent"])},{default:t(()=>[a(D,null,{default:t(()=>[a(R,{class:"flex justify-center align-center"},{default:t(()=>[a(w,null,{default:t(()=>[a(D,{class:"d-flex justify-center align-center flex-column ml-4",outlined:"",style:{"min-height":"500px","min-width":"400px"}},{default:t(()=>[I.value?(_(),B(Ve,{key:0,src:I.value,width:"350px",height:"500px",cover:""},null,8,["src"])):(_(),B(he,{key:1,class:"mb-3",size:"100",color:"grey-lighten-2"},{default:t(()=>[M("mdi-image-outline")]),_:1})),m.value==="upload"?(_(),B(_e,{key:2,class:"mb-3",color:"green",size:"small"},{default:t(()=>[M("上傳圖片")]),_:1})):K("",!0),a(z,{class:"mt-1",color:"primary","prepend-icon":"mdi-upload",onClick:e[1]||(e[1]=l=>o.$refs.fileInput.click()),disabled:d.value},{default:t(()=>[M("上傳自己的圖片")]),_:1},8,["disabled"]),H("input",{ref:"fileInput",type:"file",accept:"image/*",style:{display:"none"},onChange:Y},null,544),I.value?(_(),B(z,{key:3,class:"mt-2",color:"error",variant:"text",size:"small",onClick:A},{default:t(()=>[M("清除圖片")]),_:1})):K("",!0)]),_:1})]),_:1}),a(w,{class:"me-5 mt-5"},{default:t(()=>[a(ye),a(P,{label:"書本名稱",modelValue:s(g).value.value,"onUpdate:modelValue":e[2]||(e[2]=l=>s(g).value.value=l),width:300,"error-messages":s(g).errorMessage.value},null,8,["modelValue","error-messages"]),a(P,{label:"作者",modelValue:s(y).value.value,"onUpdate:modelValue":e[3]||(e[3]=l=>s(y).value.value=l),"error-messages":s(y).errorMessage.value},null,8,["modelValue","error-messages"]),a(P,{label:"出版者",modelValue:s(x).value.value,"onUpdate:modelValue":e[4]||(e[4]=l=>s(x).value.value=l),"error-messages":s(x).errorMessage.value},null,8,["modelValue","error-messages"]),a(P,{label:"價格",modelValue:s(k).value.value,"onUpdate:modelValue":e[5]||(e[5]=l=>s(k).value.value=l),"error-messages":s(k).errorMessage.value},null,8,["modelValue","error-messages"]),a(P,{label:"分類",modelValue:s(U).value.value,"onUpdate:modelValue":e[6]||(e[6]=l=>s(U).value.value=l)},null,8,["modelValue"]),a(D,{class:"pa-1 mb-6",outlined:"",style:{"background-color":"rgba(0,0,0,0.04)"}},{default:t(()=>[a(Se,{label:"成人內容 (18+)",modelValue:V.value,"onUpdate:modelValue":e[7]||(e[7]=l=>V.value=l),"hide-details":""},null,8,["modelValue"])]),_:1}),a(Me,{label:"簡介",modelValue:s(C).value.value,"onUpdate:modelValue":e[8]||(e[8]=l=>s(C).value.value=l),"error-messages":s(C).errorMessage.value},null,8,["modelValue","error-messages"]),a(xe)]),_:1})]),_:1}),a(R,{class:"text-center mb-5",cols:"12"},{default:t(()=>[a(w,null,{default:t(()=>[a(J),a(z,{color:"green",type:"submit",loading:d.value},{default:t(()=>[M("送出")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1})]),_:1}))}};export{Ge as default};
