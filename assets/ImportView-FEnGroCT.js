var oe=Object.defineProperty,se=Object.defineProperties;var ue=Object.getOwnPropertyDescriptors;var L=Object.getOwnPropertySymbols;var re=Object.prototype.hasOwnProperty,ne=Object.prototype.propertyIsEnumerable;var G=(d,i,t)=>i in d?oe(d,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[i]=t,O=(d,i)=>{for(var t in i||(i={}))re.call(i,t)&&G(d,t,i[t]);if(L)for(var t of L(i))ne.call(i,t)&&G(d,t,i[t]);return d},J=(d,i)=>se(d,ue(i));var q=(d,i,t)=>new Promise((j,g)=>{var b=m=>{try{p(t.next(m))}catch(f){g(f)}},v=m=>{try{p(t.throw(m))}catch(f){g(f)}},p=m=>m.done?j(m.value):Promise.resolve(m.value).then(b,v);p((t=t.apply(d,i)).next())});import{J as ie,r as y,d as me,w as de,D as w,G as o,a0 as ce,F as k,H as l,a8 as C,a9 as h,a5 as K,a3 as H,ad as x,ar as pe,av as ve,ah as fe,ai as ge,u,ac as $,M as W,a6 as be,$ as Ve,Y as P,aw as ye,a1 as A,a7 as he,ax as xe,am as we,ab as ke}from"./vue-vendor-CO2Qqhmb.js";import{b as Ce,e as D,i as Pe,u as Ue,h as V,a as Be}from"./vendor-oObasS19.js";import{a as Ie}from"./index-BzE3j7FH.js";/* empty css                   */const Fe={__name:"ImportView",setup(d){const{apiAuth:i}=Ie(),t=ie(),j=y(!1),g=y(!1),b=y(""),v=y(""),p=y(null),m=y(""),f=y(!1),F=me(()=>m.value==="upload"&&p.value?URL.createObjectURL(p.value):m.value==="api"&&v.value?v.value:null),Y=Ce({title:D().required("缺少商品名稱"),publisher:D().required("缺少出版者"),retailPrice:Pe().typeError("書籍價格格式錯誤").required("缺少書籍價格").min(0,"書籍價格不能小於 0"),description:D().required("缺少簡介")}),{handleSubmit:Q,resetForm:N}=Ue({validationSchema:Y,initialValues:{title:"",authors:"",publisher:"",retailPrice:"",categories:"",description:"",image:"",maturityRating:""}}),U=V("title"),B=V("authors"),I=V("publisher"),M=V("retailPrice"),T=V("categories"),S=V("description"),z=V("image"),X=V("maturityRating");de(f,s=>{X.value.value=s?"MATURE":"NOT_MATURE"});const Z=s=>{const e=s.target.files[0];if(e){if(!["image/jpeg","image/png","image/jpg"].includes(e.type)){t({text:"只支援 JPG 和 PNG 格式",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),s.target.value="";return}if(e.size>1024*1024){t({text:"檔案大小不能超過 1MB",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),s.target.value="";return}p.value=e,m.value="upload",t({text:"圖片選取成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}},R=()=>{p.value=null,v.value="",m.value="",z.value.value="",document.querySelector('input[type="file"]')&&(document.querySelector('input[type="file"]').value="")},ee=()=>{N(),R(),b.value="",f.value=!1},ae=(s,e=null)=>{const a=new FormData;return Object.keys(s).forEach(c=>{s[c]!==null&&s[c]!==void 0&&s[c]!==""&&a.append(c,s[c])}),e&&a.append("image",e),a},le=Q(s=>q(null,null,function*(){var e,a,c;g.value=!0;try{let r;const n={};m.value==="upload"&&p.value?(console.log("準備提交含用戶圖片的資料..."),r=ae(s,p.value),n["Content-Type"]="multipart/form-data"):(console.log("準備提交 JSON 資料..."),r=J(O({},s),{image:m.value==="api"&&v.value?v.value:""}),n["Content-Type"]="application/json"),console.log("準備提交數據:",r);const _=yield i.post("/books",r,{headers:n});console.log("書籍創建成功:",_.data),t({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),ee()}catch(r){console.error("提交失敗:",r),console.error("錯誤詳情:",(e=r.response)==null?void 0:e.data);const n=((c=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:c.message)||"發生錯誤，請稍後再試";t({text:n,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}finally{g.value=!1}})),E=()=>q(null,null,function*(){var s,e;if(b.value.trim())try{const a=/^\d{10}(\d{3})?$/.test(b.value),c=encodeURIComponent(b.value.trim()),{data:r}=yield Be.get(`https://www.googleapis.com/books/v1/volumes?q=${a?"isbn":"intitle"}:${c}`);if(console.log("Google Books API 回應:",r),r&&r.items&&r.items.length>0){const n=r.items[0].volumeInfo,_=r.items[0].saleInfo;U.value.value=n.title||"",B.value.value=n.authors?n.authors.join(", "):"",I.value.value=n.publisher||"",M.value.value=_.retailPrice?_.retailPrice.amount:"",T.value.value=n.categories?n.categories.join(", "):"",S.value.value=n.description||"";const te=n.maturityRating||"";f.value=te==="MATURE",n.imageLinks&&n.imageLinks.thumbnail?(v.value=n.imageLinks.thumbnail.replace("http://","https://").replace("img=1&zoom=1","img=2").replace("edge=curl",""),m.value="api",z.value.value=v.value,p.value=null,document.querySelector('input[type="file"]')&&(document.querySelector('input[type="file"]').value="")):R(),t({text:"引入成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}else t({text:"查無此書",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}catch(a){console.error("搜尋書籍錯誤:",a);const c=((e=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:e.message)||"查無此書";t({text:c,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),N(),R()}});return(s,e)=>(k(),w(ce,null,{default:o(()=>[l(C,null,{default:o(()=>[l(h,{cols:"12"},{default:o(()=>e[9]||(e[9]=[K("h1",{class:"text-center"},"引入書籍",-1)])),_:1,__:[9]})]),_:1}),l(H,null,{default:o(()=>[l(C,null,{default:o(()=>[l(h,null,{default:o(()=>[l(x,{class:"mx-auto mt-5",modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=a=>b.value=a),density:"comfortable","menu-icon":"",placeholder:"請輸入書籍名稱或13碼的isbn進行搜尋","prepend-inner-icon":"mdi-magnify",rounded:"",theme:"light",variant:"solo",style:ve({width:j.value?"100%":"500px"}),"onClick:append":E,onKeydown:pe(E,["enter"])},null,8,["modelValue","style"])]),_:1})]),_:1})]),_:1}),l(C,null,{default:o(()=>[l(h,{class:"d-flex justify-center",cols:"12"},{default:o(()=>[l(fe,{disabled:g.value,onSubmit:ge(u(le),["prevent"])},{default:o(()=>[l($,null,{default:o(()=>[l(C,{class:"flex justify-center align-center"},{default:o(()=>[l(h,null,{default:o(()=>[l($,{class:"d-flex justify-center align-center flex-column ml-4",outlined:"",style:{"min-height":"500px","min-width":"400px"}},{default:o(()=>[F.value?(k(),w(be,{key:0,src:F.value,width:"350px",height:"500px",cover:""},null,8,["src"])):(k(),w(Ve,{key:1,class:"mb-3",size:"100",color:"grey-lighten-2"},{default:o(()=>e[10]||(e[10]=[P("mdi-image-outline",-1)])),_:1,__:[10]})),m.value==="upload"?(k(),w(ye,{key:2,class:"mb-3",color:"green",size:"small"},{default:o(()=>e[11]||(e[11]=[P("上傳圖片",-1)])),_:1,__:[11]})):W("",!0),l(A,{class:"mt-1",color:"primary","prepend-icon":"mdi-upload",onClick:e[1]||(e[1]=a=>s.$refs.fileInput.click()),disabled:g.value},{default:o(()=>e[12]||(e[12]=[P("上傳自己的圖片",-1)])),_:1,__:[12]},8,["disabled"]),K("input",{ref:"fileInput",type:"file",accept:"image/*",style:{display:"none"},onChange:Z},null,544),F.value?(k(),w(A,{key:3,class:"mt-2",color:"error",variant:"text",size:"small",onClick:R},{default:o(()=>e[13]||(e[13]=[P("清除圖片",-1)])),_:1,__:[13]})):W("",!0)]),_:1})]),_:1}),l(h,{class:"me-5 mt-5"},{default:o(()=>[l(he),l(x,{label:"書本名稱",modelValue:u(U).value.value,"onUpdate:modelValue":e[2]||(e[2]=a=>u(U).value.value=a),width:300,"error-messages":u(U).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"作者",modelValue:u(B).value.value,"onUpdate:modelValue":e[3]||(e[3]=a=>u(B).value.value=a),"error-messages":u(B).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"出版者",modelValue:u(I).value.value,"onUpdate:modelValue":e[4]||(e[4]=a=>u(I).value.value=a),"error-messages":u(I).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"價格",modelValue:u(M).value.value,"onUpdate:modelValue":e[5]||(e[5]=a=>u(M).value.value=a),"error-messages":u(M).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"分類",modelValue:u(T).value.value,"onUpdate:modelValue":e[6]||(e[6]=a=>u(T).value.value=a)},null,8,["modelValue"]),l($,{class:"pa-1 mb-6",outlined:"",style:{"background-color":"rgba(0,0,0,0.04)"}},{default:o(()=>[l(xe,{label:"成人內容 (18+)",modelValue:f.value,"onUpdate:modelValue":e[7]||(e[7]=a=>f.value=a),"hide-details":""},null,8,["modelValue"])]),_:1}),l(we,{label:"簡介",modelValue:u(S).value.value,"onUpdate:modelValue":e[8]||(e[8]=a=>u(S).value.value=a),"error-messages":u(S).errorMessage.value},null,8,["modelValue","error-messages"]),l(ke)]),_:1})]),_:1}),l(C,{class:"text-center mb-5",cols:"12"},{default:o(()=>[l(h,null,{default:o(()=>[l(H),l(A,{color:"green",type:"submit",loading:g.value},{default:o(()=>e[14]||(e[14]=[P("送出",-1)])),_:1,__:[14]},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1})]),_:1}))}};export{Fe as default};
