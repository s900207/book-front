var y=(U,C,c)=>new Promise((L,f)=>{var R=u=>{try{g(c.next(u))}catch(p){f(p)}},V=u=>{try{g(c.throw(u))}catch(p){f(p)}},g=u=>u.done?L(u.value):Promise.resolve(u.value).then(R,V);g((c=c.apply(U,C)).next())});import{J as X,r as v,D as $,G as d,a0 as Y,E as Z,F as M,H as w,a8 as O,a9 as Q,aq as W,al as b,a6 as z,M as I,ad as k,ar as ee,as as te,Y as ae,Z as se}from"./vue-vendor-CO2Qqhmb.js";import{u as le,a as re}from"./index-BOcPIx1O.js";import"./vendor-oObasS19.js";/* empty css                   */const F=55,ve={__name:"MybookView",setup(U){const{apiAuth:C}=re(),c=le(),L=X(),f=v(10),R=v([{key:"createdAt",order:"desc"}]),V=v(1),g=v([]),u=v(null),p=new Map,A=v(!1),H=t=>{var s;return((s=t==null?void 0:t.result)==null?void 0:s.image)||(t==null?void 0:t.image)||""},N=t=>{var e;const a=(((e=t==null?void 0:t.result)==null?void 0:e.reviews)||(t==null?void 0:t.reviews)||[]).find(l=>l.user.$oid===c.value||l.user===c.value);return(a==null?void 0:a.rating)||0},K=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"result.title"},{title:"作者",align:"center",sortable:!0,key:"result.authors"},{title:"出版者",align:"center",sortable:!0,key:"result.publisher"},{title:"分類",align:"center",sortable:!0,key:"result.categories"},{title:"評分(1-5)",align:"center",sortable:!0,key:"result.rating"},{title:"書評",align:"center",sortable:!1,key:"result.review",value:t=>{var e;const a=(((e=t==null?void 0:t.result)==null?void 0:e.reviews)||(t==null?void 0:t.reviews)||[]).find(l=>l.user.$oid===c.value||l.user===c.value);if(a){const l=a.comment,i=[];for(let r=0;r<l.length;r+=F)i.push(l.substring(r,r+F));return i.join(`
`)}else return"未提供書評"}}],D=v(!0),_=v(0),B=v(""),j=t=>y(null,null,function*(){var s;if(p.has(t))return p.get(t);try{const e=(yield C.get(`/books/${t}`)).data;return p.set(t,e),e}catch(a){if(((s=a.response)==null?void 0:s.status)===404)return p.set(t,null),null;throw a}}),q=(t,s=3)=>y(null,null,function*(){const a=[],e=[];for(let l=0;l<t.length;l+=s){const r=t.slice(l,l+s).map(n=>y(null,null,function*(){try{const h=yield j(n);return{bookId:n,book:h,valid:h!==null}}catch(h){return console.warn(`獲取書籍 ${n} 失敗:`,h),{bookId:n,book:null,valid:!1}}})),x=yield Promise.all(r);for(const n of x)n.valid&&n.book?a.push(n.book):e.push(n.bookId);l+s<t.length&&(yield new Promise(n=>setTimeout(n,100)))}return{validBooks:a,invalidIds:e}}),E=t=>y(null,null,function*(){if(!(!t||t.length===0||A.value)){A.value=!0;try{const s=t.map(a=>y(null,null,function*(){var e;try{return yield C.delete(`/users/favorite/${a}`),{bookId:a,success:!0}}catch(l){return((e=l.response)==null?void 0:e.status)===404?{bookId:a,success:!0,alreadyRemoved:!0}:{bookId:a,success:!1,error:l}}}));yield Promise.all(s)}catch(s){}finally{A.value=!1}}}),P=()=>y(null,null,function*(){var t,s;D.value=!0,u.value=null;try{const{data:a}=yield C.get("/users/favorite");console.log("獲取 favorite IDs:",a);const e=a.result||a;if(!e||e.length===0){g.value=[],_.value=0;return}const{validBooks:l,invalidIds:i}=yield q(e);i.length>0&&setTimeout(()=>E(i),0);let r=l;if(B.value){const h=B.value.toLowerCase();r=l.filter(o=>{var S,T;const G=((S=o==null?void 0:o.result)==null?void 0:S.title)||(o==null?void 0:o.title)||"",J=((T=o==null?void 0:o.result)==null?void 0:T.authors)||(o==null?void 0:o.authors)||"";return G.toLowerCase().includes(h)||J.toLowerCase().includes(h)})}const x=(V.value-1)*f.value,n=x+f.value;g.value=r.slice(x,n),_.value=r.length}catch(a){console.error("載入失敗:",a);const e=((s=(t=a==null?void 0:a.response)==null?void 0:t.data)==null?void 0:s.message)||"載入喜愛書籍失敗";L({text:e,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"red",location:"bottom"}}),g.value=[],_.value=0}finally{D.value=!1}}),m=()=>{V.value=1,P()};return P(),(t,s)=>{const a=Z("RouterLink");return M(),$(Y,null,{default:d(()=>[w(O,null,{default:d(()=>[w(Q,{cols:"12"},{default:d(()=>[w(W,{"items-per-page":f.value,"onUpdate:itemsPerPage":[s[2]||(s[2]=e=>f.value=e),P],"sort-by":R.value,"onUpdate:sortBy":[s[3]||(s[3]=e=>R.value=e),P],page:V.value,"onUpdate:page":[s[4]||(s[4]=e=>V.value=e),P],items:g.value,headers:K,loading:D.value,"items-length":_.value,search:B.value,hover:""},{top:d(()=>[w(k,{label:"搜尋","append-icon":"mdi-magnify",modelValue:B.value,"onUpdate:modelValue":s[0]||(s[0]=e=>B.value=e),"onClick:append":m,onKeydown:ee(m,["enter"])},null,8,["modelValue"]),u.value?(M(),$(te,{key:0,class:"mt-2",type:"warning",dismissible:"","onClick:close":s[1]||(s[1]=e=>u.value=null)},{default:d(()=>[ae(se(u.value),1)]),_:1})):I("",!0)]),"item.image":d(({item:e})=>{var l,i,r;return[w(a,{class:"text-primary text-decoration-none",to:"/books/"+(((l=e==null?void 0:e.result)==null?void 0:l._id)||(e==null?void 0:e._id)||((i=e==null?void 0:e.result)==null?void 0:i.id)||(e==null?void 0:e.id)),title:((r=e==null?void 0:e.result)==null?void 0:r.title)||(e==null?void 0:e.title)||""},{default:d(()=>[w(z,{src:H(e),width:"80",height:"80",cover:""},null,8,["src"])]),_:2},1032,["to","title"])]}),"item.starRating":d(({item:e})=>[w(b,{value:N(e),readonly:"",color:"#4d4637 darken-3",size:"20"},null,8,["value"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1})}}};export{ve as default};
