import{U as j,x as w,Z as z,$ as s,af as A,a4 as D,c as e,au as m,bH as N,aB as E,a7 as K,aa as P,ax as H,a6 as o,as as F,V as Z,ap as G,ar as J,a9 as O,a8 as Q,ae as W,bI as X}from"./index-e52cf8ff.js";import{c as Y,a as x,d as ee}from"./index.esm-3d8b24aa.js";import{u as ae,a as u}from"./vee-validate.esm-ced433dd.js";import{V as le}from"./VContainer-ba827015.js";import{V as d}from"./VCol-73ba0aa5.js";import{V}from"./VRow-41aaa32e.js";import{V as te}from"./VForm-bdfb4b9d.js";import{V as oe}from"./VTextarea-966cee22.js";const se=W("h1",{class:"text-center"},"引入書籍",-1),fe={__name:"ImportView",setup(re){const{apiAuth:k}=A(),y=j(),S=w(!1),I=w(!1),c=w(""),M=Y({title:x().required("缺少商品名稱"),publisher:x().required("缺少出版者"),retailPrice:ee().typeError("商品價格格式錯誤").required("缺少商品價格").min(0,"商品價格不能小於 0"),description:x().required("缺少簡介")}),{handleSubmit:R}=ae({validationSchema:M,initialValues:{title:"",authors:"",publisher:"",retailPrice:"",categories:"",description:"",image:"",maturityRating:"",buyLink:""}}),v=u("title"),p=u("authors"),f=u("publisher"),g=u("retailPrice"),h=u("categories"),b=u("description"),i=u("image"),$=u("maturityRating"),L=u("buyLink"),_=async()=>{var n,t;if(c.value.trim())try{const a=/^\d{10}(\d{3})?$/.test(c.value),r=encodeURIComponent(c.value.trim()),{data:l}=await X.get(`https://www.googleapis.com/books/v1/volumes?q=${a?"isbn":"intitle"}:${r}`);console.log(l),l&&l.items&&l.items.length>0&&(v.value.value=l.items[0].volumeInfo.title,p.value.value=l.items[0].volumeInfo.authors,f.value.value=l.items[0].volumeInfo.publisher,g.value.value=l.items[0].saleInfo.retailPrice?l.items[0].saleInfo.retailPrice.amount:null,h.value.value=l.items[0].volumeInfo.categories,b.value.value=l.items[0].volumeInfo.description,i.value.value=l.items[0].volumeInfo.imageLinks.thumbnail.replace("http://","https://").replace("img=1&zoom=1","img=1&zoom=2").replace("edge=curl",""),$.value.value=l.items[0].volumeInfo.maturityRating,L.value.value=l.items[0].saleInfo.buyLink,y({text:"引入成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}))}catch(a){console.error(a);const r=((t=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:t.message)||"查無此書";y({text:r,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),v.value.value="",p.value.value="",f.value.value="",g.value.value="",h.value.value="",b.value.value="",i.value.value=""}},q=R(async n=>{var t,a;console.log(n);try{const r=new FormData;for(const l in n)r.append(l,n[l]);if(i.value){console.log("Image URL:",i.value);const l=await fetch(i.value).then(U=>{if(!U.ok)throw new Error("無法獲取圖片");return U.blob()}),T=new File([l],"image.jpg",{type:l.type}),C=new FormData;C.append("image",T);const B=await k.post("/upload",C,{headers:{"Content-Type":"multipart/form-data"}});B.data.secure_url&&r.append("imageUrl",B.data.secure_url)}await k.post("/books",r),y({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(r){console.log(r);const l=((a=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";y({text:l,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}});return(n,t)=>(D(),z(le,null,{default:s(()=>[e(V,null,{default:s(()=>[e(d,{cols:"12"},{default:s(()=>[se]),_:1})]),_:1}),e(P,null,{default:s(()=>[e(V,null,{default:s(()=>[e(d,null,{default:s(()=>[e(m,{class:"mx-auto mt-5",modelValue:c.value,"onUpdate:modelValue":t[0]||(t[0]=a=>c.value=a),density:"comfortable","menu-icon":"",placeholder:"請輸入書籍名稱或13碼的isbn進行搜尋",rounded:"",theme:"light",variant:"solo",style:N({width:S.value?"100%":"500px"}),"onClick:append":_,onKeydown:E(_,["enter"])},{"prepend-inner":s(()=>[e(K,{href:"#icon-magnify"})]),_:1},8,["modelValue","style"])]),_:1})]),_:1})]),_:1}),e(V,null,{default:s(()=>[e(d,{class:"d-flex justify-center",cols:"12"},{default:s(()=>[e(te,{disabled:I.value,onSubmit:H(o(q),["prevent"])},{default:s(()=>[e(F,null,{default:s(()=>[e(V,{class:"flex justify-center align-center"},{default:s(()=>[e(d,null,{default:s(()=>[e(F,{class:"d-flex justify-center align-center",outlined:""}),e(Z,{src:o(i).value.value,width:"300px",cover:"",readonly:""},null,8,["src"])]),_:1}),e(d,{class:"me-2"},{default:s(()=>[e(G),e(m,{label:"書本名稱",modelValue:o(v).value.value,"onUpdate:modelValue":t[1]||(t[1]=a=>o(v).value.value=a),width:300,"error-messages":o(v).errorMessage.value},null,8,["modelValue","error-messages"]),e(m,{label:"作者",modelValue:o(p).value.value,"onUpdate:modelValue":t[2]||(t[2]=a=>o(p).value.value=a),"error-messages":o(p).errorMessage.value},null,8,["modelValue","error-messages"]),e(m,{label:"出版者",modelValue:o(f).value.value,"onUpdate:modelValue":t[3]||(t[3]=a=>o(f).value.value=a),"error-messages":o(f).errorMessage.value},null,8,["modelValue","error-messages"]),e(m,{label:"價格",modelValue:o(g).value.value,"onUpdate:modelValue":t[4]||(t[4]=a=>o(g).value.value=a),"error-messages":o(g).errorMessage.value},null,8,["modelValue","error-messages"]),e(m,{label:"分類",modelValue:o(h).value.value,"onUpdate:modelValue":t[5]||(t[5]=a=>o(h).value.value=a)},null,8,["modelValue"]),e(oe,{label:"簡介",modelValue:o(b).value.value,"onUpdate:modelValue":t[6]||(t[6]=a=>o(b).value.value=a),"error-messages":o(b).errorMessage.value},null,8,["modelValue","error-messages"]),e(J)]),_:1})]),_:1})]),_:1}),e(V,{class:"text-center mb-5",cols:"12"},{default:s(()=>[e(d,null,{default:s(()=>[e(P),e(O,{color:"green",type:"submit",loading:I.value},{default:s(()=>[Q("送出")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1})]),_:1}))}};export{fe as default};
