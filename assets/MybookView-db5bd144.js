var B=(D,w,c)=>new Promise((P,p)=>{var I=n=>{try{i(c.next(n))}catch($){p($)}},h=n=>{try{i(c.throw(n))}catch($){p($)}},i=n=>n.done?P(n.value):Promise.resolve(n.value).then(I,h);i((c=c.apply(D,w)).next())});import{O as k,r as v,G as T,H as d,a2 as z,E as G,F as E,I as f,ac as O,aw as X,ai as q,ax as J,ay as Q,a0 as W,a8 as Y,R as Z,a9 as m,ar as ee,ab as te}from"./vue-vendor-5ccff89c.js";import{u as ae,a as se}from"./index-183e0965.js";import"./vendor-913c4e2a.js";const H=55,ue={__name:"MybookView",setup(D){const{apiAuth:w}=se(),c=ae(),P=k(),p=v(10),I=v([{key:"createdAt",order:"desc"}]),h=v(1),i=v([]),n=v(null),$=t=>{var a;return((a=t==null?void 0:t.result)==null?void 0:a.image)||(t==null?void 0:t.image)||""},N=t=>{var e;const r=(((e=t==null?void 0:t.result)==null?void 0:e.reviews)||(t==null?void 0:t.reviews)||[]).find(l=>l.user.$oid===c.value||l.user===c.value);return(r==null?void 0:r.rating)||0},K=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"result.title"},{title:"作者",align:"center",sortable:!0,key:"result.authors"},{title:"出版者",align:"center",sortable:!0,key:"result.publisher"},{title:"分類",align:"center",sortable:!0,key:"result.categories"},{title:"評分(1-5)",align:"center",sortable:!0,key:"result.rating"},{title:"書評",align:"center",sortable:!1,key:"result.review",value:t=>{var e;const r=(((e=t==null?void 0:t.result)==null?void 0:e.reviews)||(t==null?void 0:t.reviews)||[]).find(l=>l.user.$oid===c.value||l.user===c.value);if(r){const l=r.comment,o=[];for(let u=0;u<l.length;u+=H)o.push(l.substring(u,u+H));return o.join(`
`)}else return"未提供書評"}}],R=v(!0),_=v(0),V=v(""),M=t=>B(this,null,function*(){if(!(!t||t.length===0))try{console.log("準備清理無效的 favorite 記錄:",t);const a=t.map(r=>w.delete(`/users/favorite/${r}`).catch(e=>(console.warn(`清理 favorite ${r} 失敗:`,e),null)));yield Promise.all(a)}catch(a){console.error("清理 favorite 記錄時發生錯誤:",a)}}),C=()=>B(this,null,function*(){var t,a,r,e;R.value=!0,n.value=null;try{console.log("開始載入使用者喜愛書籍...");const{data:l}=yield w.get("/users/favorite");console.log("獲取 favorite IDs:",l);const o=l.result||l;if(!o||o.length===0){i.value=[],_.value=0;return}console.log(`找到 ${o.length} 本喜愛書籍`);const u=[],L=[];for(const s of o){console.log(`嘗試獲取書籍 ID: ${s}`);const A=[`/books/${s}`,`/book/${s}`,`/books/detail/${s}`,`/api/books/${s}`];let b=null,x=!1;for(const y of A)try{const g=yield w.get(y);console.log(`成功使用端點 ${y}:`,g.data),b=g.data,x=!0;break}catch(g){if(((t=g.response)==null?void 0:t.status)===404){console.log(`書籍 ${s} 不存在 (404)`);continue}console.log(`端點 ${y} 失敗:`,(a=g.response)==null?void 0:a.status)}x&&b?u.push(b):(console.warn(`書籍 ${s} 不存在，加入清理列表`),L.push(s))}console.log(`有效書籍: ${u.length}, 無效書籍: ${L.length}`),L.length>0&&(yield M(L));let S=u;V.value&&(S=u.filter(s=>{var y,g;const A=((y=s==null?void 0:s.result)==null?void 0:y.title)||(s==null?void 0:s.title)||"",b=((g=s==null?void 0:s.result)==null?void 0:g.authors)||(s==null?void 0:s.authors)||"",x=V.value.toLowerCase();return A.toLowerCase().includes(x)||b.toLowerCase().includes(x)}));const F=(h.value-1)*p.value,j=F+p.value;i.value=S.slice(F,j),_.value=S.length,console.log(`最終顯示書籍數量: ${i.value.length}`)}catch(l){console.error("載入失敗:",l);const o=((e=(r=l==null?void 0:l.response)==null?void 0:r.data)==null?void 0:e.message)||"載入喜愛書籍失敗";P({text:o,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"red",location:"bottom"}}),i.value=[],_.value=0}R.value=!1});C();const U=()=>{h.value=1,C()};return(t,a)=>{const r=G("RouterLink");return E(),T(z,null,{default:d(()=>[f(te,null,{default:d(()=>[f(O,{cols:"12"},{default:d(()=>[f(X,{"items-per-page":p.value,"onUpdate:itemsPerPage":[a[2]||(a[2]=e=>p.value=e),C],"sort-by":I.value,"onUpdate:sortBy":[a[3]||(a[3]=e=>I.value=e),C],page:h.value,"onUpdate:page":[a[4]||(a[4]=e=>h.value=e),C],items:i.value,headers:K,loading:R.value,"items-length":_.value,search:V.value,hover:""},{top:d(()=>[f(q,{label:"搜尋","append-icon":"mdi-magnify",modelValue:V.value,"onUpdate:modelValue":a[0]||(a[0]=e=>V.value=e),"onClick:append":U,onKeydown:J(U,["enter"])},null,8,["modelValue"]),n.value?(E(),T(Q,{key:0,class:"mt-2",type:"warning",dismissible:"","onClick:close":a[1]||(a[1]=e=>n.value=null)},{default:d(()=>[W(Y(n.value),1)]),_:1})):Z("",!0)]),"item.image":d(({item:e})=>{var l,o,u;return[f(r,{class:"text-primary text-decoration-none",to:"/books/"+(((l=e==null?void 0:e.result)==null?void 0:l._id)||(e==null?void 0:e._id)||((o=e==null?void 0:e.result)==null?void 0:o.id)||(e==null?void 0:e.id)),title:((u=e==null?void 0:e.result)==null?void 0:u.title)||(e==null?void 0:e.title)||""},{default:d(()=>[f(m,{src:$(e),width:"80",height:"80",cover:""},null,8,["src"])]),_:2},1032,["to","title"])]}),"item.starRating":d(({item:e})=>[f(ee,{value:N(e),readonly:"",color:"#4d4637 darken-3",size:"20"},null,8,["value"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1})}}};export{ue as default};
