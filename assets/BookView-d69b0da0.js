import{p as K,m as O,a as Q,g as X,u as ee,c as e,W as N,x as y,U as j,a2 as H,af as E,A as te,Y as L,$ as t,ay as ae,a1 as R,az as oe,a4 as x,V as le,ar as T,a9 as F,a6 as k,a7 as $,ae as r,ab as p,ax as D,a8 as P,a5 as se,as as z,ap as ne,aA as ue,Z as re}from"./index-dba75805.js";import{u as ie}from"./vee-validate.esm-5adf7a3b.js";import{V as ce}from"./VContainer-a0d4f55d.js";import{V as m}from"./VRow-b83b2e6f.js";import{V as u}from"./VCol-527d0490.js";import{V as M}from"./VForm-2b770e7b.js";import{V as A}from"./VRating-369c78d2.js";import{V as q}from"./VTextarea-b02da8fb.js";import{b as de,V as me,a as fe,c as pe}from"./VList-43338d37.js";import"./VDivider-80fd5883.js";const ve=K({start:Boolean,end:Boolean,...O(),...Q()},"VListItemAction"),_e=X()({name:"VListItemAction",props:ve(),setup(c,v){let{slots:g}=v;return ee(()=>e(c.tag,{class:["v-list-item-action",{"v-list-item-action--start":c.start,"v-list-item-action--end":c.end},c.class],style:c.style},g)),{}}});function ge(c){const{apiAuth:v}=E(),g=N(),d=y(!1),w=j(),h=H();return{isFavorite:d,checkFavoriteStatus:async()=>{try{const{data:i}=await v.get("/users/favorite",{params:{bookId:c}});d.value=i.result.includes(c)}catch(i){console.error(i),d.value=!1}},addFavorite:async()=>{if(!g.isLogin){h.push("/login");return}d.value=!d.value;try{const{data:i}=await v.post("/users/favorite",{bookId:c,isFavorite:d.value});g.favorite=i.result,w({text:d.value?"已加入我的最愛":"已移除我的最愛",showCloseButton:!1,snackbarProps:{timeout:2e3,color:d.value?"green":"red",location:"bottom"}})}catch(i){console.error(i),i.response&&i.response.status===401?h.push("/login"):w({text:"發生錯誤，請稍後再試",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}}}const he=r("span",null,"加入購物車",-1),be=r("h3",null,"出版者:",-1),Ve=r("h3",null,"價格:",-1),ke=r("h3",null,"分類:",-1),ye=r("h3",null,"簡介:",-1),we=["innerHTML"],Ce={key:1},xe=r("h3",null,"新增書評:",-1),Fe=r("h3",null,"書評:",-1),Be=r("h3",null,"編輯書評",-1),ze={__name:"BookView",setup(c){const v=oe(),g=H(),{api:d,apiAuth:w}=E(),h=y(!1),C=y(!1),_=j(),i=N(),b=y({usersId:"",rating:0,comment:""}),B=y(!1),{handleSubmit:I}=ie({initialValues:{usersId:"",rating:0,comment:""}}),l=y({_id:"",image:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",buyLink:"",description:"",reviews:[]}),f=y([]),{isFavorite:S,checkFavoriteStatus:W,addFavorite:Y}=ge(v.params.id),Z=()=>{B.value=!1},U=I(async s=>{var a,o;if(console.log(b.value),!i.isLogin){g.push("/login"),_({text:"請先登入",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}});return}try{const{data:n}=await w.post(`/books/${v.params.id}/reviews`,{rating:b.value.rating,conmment:b.value.comment});n&&n.result&&l.value.reviews.push(n.result),_({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(n){console.log(n);const V=((o=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:o.message)||"發生錯誤，請稍後再試";_({text:V,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),G=I(async s=>{var a,o;try{console.log(f.value),console.log("Form values:",s);const n=new FormData;for(const V in s)n.append(V,f.value[V]||s[V]);B.value===""&&await w.patch(`/books/${f.value.bookId}/reviews/${f.value.id}`,n),console.log("FormData entries:",...n.entries()),_({text:"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(n){console.log(n);const V=((o=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:o.message)||"發生錯誤，請稍後再試";_({text:V,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}Z()});console.log(f.value),te(async()=>{try{const{data:s}=await d.get(`/books/${v.params.id}`);l.value._id=s.result._id,l.value.image=s.result.image,l.value.title=s.result.title,l.value.authors=s.result.authors,l.value.publisher=s.result.publisher,l.value.retailPrice=s.result.retailPrice,l.value.categories=s.result.categories,l.value.buyLink=s.result.buyLink;let a=s.result.description.replace(/(※|★|◆|✓|●|▓|▌|￭|──|【)/g,"<br>$1");a=a.replace(/(】)/g,"$1<br>"),a=a.replace(new RegExp("(?<=──[^,]*?)(?=,)","g"),"<br>$1"),l.value.description=a,l.value.reviews=s.result.reviews,document.title=`書評網 | ${l.value.title}`,await W()}catch(s){console.log(s)}});const J=async()=>{var s,a;if(!i.isLogin){g.push("/login");return}try{const{data:o}=await w.patch("/users/cart",{book:l.value._id,quantity:1});i.cart=o.result,_({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(o){const n=((a=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";_({text:n,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}};return(s,a)=>(x(),L(R,null,[e(ce,null,{default:t(()=>[e(m,null,{default:t(()=>[e(u,{cols:"12",md:"3",style:{position:"sticky"},top:"0"},{default:t(()=>[e(le,{src:l.value.image},null,8,["src"]),e(T,null,{default:t(()=>[e(m,{class:"justify-center align-center"},{default:t(()=>[e(u,{cols:"6"},{default:t(()=>[e(F,{color:k(S)?"red":"blue",onClick:k(Y)},{prepend:t(()=>[e($,{href:k(S)?"#icon-heart-minus":"#icon-heart-plus"},null,8,["href"])]),default:t(()=>[r("span",null,p(k(S)?"取消最愛":"加入最愛"),1)]),_:1},8,["color","onClick"])]),_:1}),e(u,{cols:"6"},{default:t(()=>[e(F,{onClick:J,color:"primary"},{prepend:t(()=>[e($,{href:"#icon-cart"})]),default:t(()=>[he]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(u,{cols:"12",md:"9"},{default:t(()=>[r("h1",null,p(l.value.title),1),r("h2",null,p(l.value.authors),1),e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[be]),_:1}),e(u,null,{default:t(()=>[r("p",null,p(l.value.publisher),1)]),_:1})]),_:1}),e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[Ve]),_:1}),e(u,null,{default:t(()=>[r("p",null,"$"+p(l.value.retailPrice),1)]),_:1})]),_:1}),e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[ke]),_:1}),e(u,null,{default:t(()=>[r("p",null,p(l.value.categories),1)]),_:1})]),_:1}),e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[ye,C.value?(x(),L("p",{key:0,innerHTML:l.value.description},null,8,we)):(x(),L("p",Ce,p(l.value.description.substring(0,500)),1))]),_:1}),e(u,{class:"text-center"},{default:t(()=>[e(F,{color:(C.value,"#4d4637"),onClick:a[0]||(a[0]=o=>C.value=!C.value)},{prepend:t(()=>[e($,{href:C.value?"#icon-chevron-up":"#icon-chevron-down"},null,8,["href"])]),_:1},8,["color"])]),_:1})]),_:1}),e(m,null,{default:t(()=>[e(u,{cols:"12"},{default:t(()=>[xe,e(M,{disabled:h.value,onSubmit:D(k(U),["prevent"])},{default:t(()=>[e(A,{modelValue:b.value.rating,"onUpdate:modelValue":a[1]||(a[1]=o=>b.value.rating=o),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(q,{modelValue:b.value.comment,"onUpdate:modelValue":a[2]||(a[2]=o=>b.value.comment=o),label:"你的書評",required:""},null,8,["modelValue"]),e(F,{color:"#4d4637",type:"submit",loading:h.value},{default:t(()=>[P("提交")]),_:1},8,["loading"])]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1}),e(m,null,{default:t(()=>[e(u,{cols:"12"},{default:t(()=>[Fe,e(de,null,{default:t(()=>[(x(!0),L(R,null,se(l.value.reviews,o=>(x(),re(me,{key:o._id},{default:t(()=>[e(z,null,{default:t(()=>[e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[e(fe,{style:{fontSize:"30px"}},{default:t(()=>[P(p(o.user.account),1)]),_:2},1024)]),_:2},1024),e(u,{cols:"auto"},{default:t(()=>[e(_e,null,{default:t(()=>[e(A,{modelValue:o.rating,"onUpdate:modelValue":n=>o.rating=n,color:"#4d4637 darken-3",size:"25",readonly:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[e(pe,{class:"mb-5",style:{fontSize:"20px"}},{default:t(()=>[P(p(o.comment),1)]),_:2},1024)]),_:2},1024),e(u,{class:"d-flex justify-end"})]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(ae,{modelValue:B.value,"onUpdate:modelValue":a[6]||(a[6]=o=>B.value=o),"max-width":"290"},{default:t(()=>[e(M,{disabled:h.value,onSubmit:D(k(U),["prevent"])},{default:t(()=>[e(z,null,{default:t(()=>[e(ne,null,{default:t(()=>[Be]),_:1}),e(ue,null,{default:t(()=>[e(A,{modelValue:f.value.rating,"onUpdate:modelValue":a[3]||(a[3]=o=>f.value.rating=o),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(q,{modelValue:f.value.comment,"onUpdate:modelValue":a[4]||(a[4]=o=>f.value.comment=o),label:"你的書評",required:""},null,8,["modelValue"])]),_:1}),e(T,null,{default:t(()=>[e(F,{color:"#4d4637",onClick:a[5]||(a[5]=o=>k(G)(s.review)),loading:h.value},{default:t(()=>[P("修正")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64))}};export{ze as default};
