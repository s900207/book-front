import{J as Y,r as c,d as Q,w as X,D as V,G as t,a0 as Z,F as y,H as l,a8 as h,a9 as v,a5 as $,a3 as A,ad as f,ar as ee,av as ae,ah as le,ai as te,u as r,ac as S,M as D,a6 as oe,$ as se,Y as x,aw as re,a1 as R,a7 as ue,ax as ne,am as ie,ab as me}from"./vue-vendor-DZ6ShR-l.js";import{b as de,e as _,i as ce,u as pe,h as i,a as ve}from"./vendor-fvIX-KvJ.js";import{a as fe}from"./index-Mk3cYYfI.js";const he={__name:"ImportView",setup(ge){const{apiAuth:N}=fe(),u=Y(),z=c(!1),g=c(!1),p=c(""),m=c(""),d=c(null),n=c(""),b=c(!1),I=Q(()=>n.value==="upload"&&d.value?URL.createObjectURL(d.value):n.value==="api"&&m.value?m.value:null),E=de({title:_().required("缺少商品名稱"),publisher:_().required("缺少出版者"),retailPrice:ce().typeError("書籍價格格式錯誤").required("缺少書籍價格").min(0,"書籍價格不能小於 0"),description:_().required("缺少簡介")}),{handleSubmit:L,resetForm:j}=pe({validationSchema:E,initialValues:{title:"",authors:"",publisher:"",retailPrice:"",categories:"",description:"",image:"",maturityRating:""}}),w=i("title"),k=i("authors"),C=i("publisher"),P=i("retailPrice"),M=i("categories"),U=i("description"),F=i("image"),G=i("maturityRating");X(b,o=>{G.value.value=o?"MATURE":"NOT_MATURE"});const O=o=>{const e=o.target.files[0];if(e){if(!["image/jpeg","image/png","image/jpg"].includes(e.type)){u({text:"只支援 JPG 和 PNG 格式",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),o.target.value="";return}if(e.size>1024*1024){u({text:"檔案大小不能超過 1MB",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),o.target.value="";return}d.value=e,n.value="upload",u({text:"圖片選取成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}},B=()=>{d.value=null,m.value="",n.value="",F.value.value="",document.querySelector('input[type="file"]')&&(document.querySelector('input[type="file"]').value="")},J=()=>{j(),B(),p.value="",b.value=!1},K=(o,e=null)=>{const a=new FormData;return Object.keys(o).forEach(s=>{o[s]!==null&&o[s]!==void 0&&o[s]!==""&&a.append(s,o[s])}),e&&a.append("image",e),a},H=L(async o=>{g.value=!0;try{let e;const a={};n.value==="upload"&&d.value?(console.log("準備提交含用戶圖片的資料..."),e=K(o,d.value),a["Content-Type"]="multipart/form-data"):(console.log("準備提交 JSON 資料..."),e={...o,image:n.value==="api"&&m.value?m.value:""},a["Content-Type"]="application/json"),console.log("準備提交數據:",e);const s=await N.post("/books",e,{headers:a});console.log("書籍創建成功:",s.data),u({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),J()}catch(e){console.error("提交失敗:",e),console.error("錯誤詳情:",e.response?.data);const a=e?.response?.data?.message||"發生錯誤，請稍後再試";u({text:a,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}finally{g.value=!1}}),T=async()=>{if(p.value.trim())try{const o=/^\d{10}(\d{3})?$/.test(p.value),e=encodeURIComponent(p.value.trim()),{data:a}=await ve.get(`https://www.googleapis.com/books/v1/volumes?q=${o?"isbn":"intitle"}:${e}`);if(console.log("Google Books API 回應:",a),a&&a.items&&a.items.length>0){const s=a.items[0].volumeInfo,q=a.items[0].saleInfo;w.value.value=s.title||"",k.value.value=s.authors?s.authors.join(", "):"",C.value.value=s.publisher||"",P.value.value=q.retailPrice?q.retailPrice.amount:"",M.value.value=s.categories?s.categories.join(", "):"",U.value.value=s.description||"";const W=s.maturityRating||"";b.value=W==="MATURE",s.imageLinks&&s.imageLinks.thumbnail?(m.value=s.imageLinks.thumbnail.replace("http://","https://").replace("img=1&zoom=1","img=2").replace("edge=curl",""),n.value="api",F.value.value=m.value,d.value=null,document.querySelector('input[type="file"]')&&(document.querySelector('input[type="file"]').value="")):B(),u({text:"引入成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}else u({text:"查無此書",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}catch(o){console.error("搜尋書籍錯誤:",o);const e=o?.response?.data?.message||"查無此書";u({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),j(),B()}};return(o,e)=>(y(),V(Z,null,{default:t(()=>[l(h,null,{default:t(()=>[l(v,{cols:"12"},{default:t(()=>e[9]||(e[9]=[$("h1",{class:"text-center"},"引入書籍",-1)])),_:1,__:[9]})]),_:1}),l(A,null,{default:t(()=>[l(h,null,{default:t(()=>[l(v,null,{default:t(()=>[l(f,{class:"mx-auto mt-5",modelValue:p.value,"onUpdate:modelValue":e[0]||(e[0]=a=>p.value=a),density:"comfortable","menu-icon":"",placeholder:"請輸入書籍名稱或13碼的isbn進行搜尋","prepend-inner-icon":"mdi-magnify",rounded:"",theme:"light",variant:"solo",style:ae({width:z.value?"100%":"500px"}),"onClick:append":T,onKeydown:ee(T,["enter"])},null,8,["modelValue","style"])]),_:1})]),_:1})]),_:1}),l(h,null,{default:t(()=>[l(v,{class:"d-flex justify-center",cols:"12"},{default:t(()=>[l(le,{disabled:g.value,onSubmit:te(r(H),["prevent"])},{default:t(()=>[l(S,null,{default:t(()=>[l(h,{class:"flex justify-center align-center"},{default:t(()=>[l(v,null,{default:t(()=>[l(S,{class:"d-flex justify-center align-center flex-column ml-4",outlined:"",style:{"min-height":"500px","min-width":"400px"}},{default:t(()=>[I.value?(y(),V(oe,{key:0,src:I.value,width:"350px",height:"500px",cover:""},null,8,["src"])):(y(),V(se,{key:1,class:"mb-3",size:"100",color:"grey-lighten-2"},{default:t(()=>e[10]||(e[10]=[x("mdi-image-outline",-1)])),_:1,__:[10]})),n.value==="upload"?(y(),V(re,{key:2,class:"mb-3",color:"green",size:"small"},{default:t(()=>e[11]||(e[11]=[x("上傳圖片",-1)])),_:1,__:[11]})):D("",!0),l(R,{class:"mt-1",color:"primary","prepend-icon":"mdi-upload",onClick:e[1]||(e[1]=a=>o.$refs.fileInput.click()),disabled:g.value},{default:t(()=>e[12]||(e[12]=[x("上傳自己的圖片",-1)])),_:1,__:[12]},8,["disabled"]),$("input",{ref:"fileInput",type:"file",accept:"image/*",style:{display:"none"},onChange:O},null,544),I.value?(y(),V(R,{key:3,class:"mt-2",color:"error",variant:"text",size:"small",onClick:B},{default:t(()=>e[13]||(e[13]=[x("清除圖片",-1)])),_:1,__:[13]})):D("",!0)]),_:1})]),_:1}),l(v,{class:"me-5 mt-5"},{default:t(()=>[l(ue),l(f,{label:"書本名稱",modelValue:r(w).value.value,"onUpdate:modelValue":e[2]||(e[2]=a=>r(w).value.value=a),width:300,"error-messages":r(w).errorMessage.value},null,8,["modelValue","error-messages"]),l(f,{label:"作者",modelValue:r(k).value.value,"onUpdate:modelValue":e[3]||(e[3]=a=>r(k).value.value=a),"error-messages":r(k).errorMessage.value},null,8,["modelValue","error-messages"]),l(f,{label:"出版者",modelValue:r(C).value.value,"onUpdate:modelValue":e[4]||(e[4]=a=>r(C).value.value=a),"error-messages":r(C).errorMessage.value},null,8,["modelValue","error-messages"]),l(f,{label:"價格",modelValue:r(P).value.value,"onUpdate:modelValue":e[5]||(e[5]=a=>r(P).value.value=a),"error-messages":r(P).errorMessage.value},null,8,["modelValue","error-messages"]),l(f,{label:"分類",modelValue:r(M).value.value,"onUpdate:modelValue":e[6]||(e[6]=a=>r(M).value.value=a)},null,8,["modelValue"]),l(S,{class:"pa-1 mb-6",outlined:"",style:{"background-color":"rgba(0,0,0,0.04)"}},{default:t(()=>[l(ne,{label:"成人內容 (18+)",modelValue:b.value,"onUpdate:modelValue":e[7]||(e[7]=a=>b.value=a),"hide-details":""},null,8,["modelValue"])]),_:1}),l(ie,{label:"簡介",modelValue:r(U).value.value,"onUpdate:modelValue":e[8]||(e[8]=a=>r(U).value.value=a),"error-messages":r(U).errorMessage.value},null,8,["modelValue","error-messages"]),l(me)]),_:1})]),_:1}),l(h,{class:"text-center mb-5",cols:"12"},{default:t(()=>[l(v,null,{default:t(()=>[l(A),l(R,{color:"green",type:"submit",loading:g.value},{default:t(()=>e[14]||(e[14]=[x("送出",-1)])),_:1,__:[14]},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1})]),_:1}))}};export{he as default};
