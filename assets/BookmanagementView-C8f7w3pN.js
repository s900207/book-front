import{J as H,r,D as y,G as l,a0 as K,F as V,H as t,a8 as q,a9 as k,at as G,a1 as x,Y as u,a6 as A,ad as p,ar as J,ak as M,ac as C,a7 as R,ap as T,ah as Y,a5 as _,M as Z,au as Q,$ as h,as as W,Z as X,am as ee,ab as ae,a3 as te}from"./vue-vendor-DZ6ShR-l.js";import{_ as le,a as oe}from"./index-Mk3cYYfI.js";import"./vendor-fvIX-KvJ.js";const se={class:"text-center"},re={__name:"BookmanagementView",setup(ue){const{apiAuth:c}=oe(),m=H(),w=r(10),v=r([{key:"createdAt",order:"desc"}]),g=r(1),P=r([]),j=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"title"},{title:"作者",align:"center",sortable:!0,key:"authors"},{title:"出版者",align:"center",sortable:!0,key:"publisher"},{title:"價格",align:"center",sortable:!0,key:"retailPrice"},{title:"分類",align:"center",sortable:!0,key:"categories"},{title:"編輯",align:"center",sortable:!1,key:"edit"},{title:"刪除",align:"center",sortable:!1,key:"delete"}],U=r(!0),I=r(0),f=r(""),b=r(!1),s=r({_id:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",description:"",image:""}),n=r(null),i=r(""),B=r(!1),D=()=>i.value?i.value:s.value.image||"",S=()=>{const a=document.querySelector('input[type="file"]');a&&a.click()},$=a=>{const e=a.target.files[0];e&&(n.value=e,i.value&&URL.revokeObjectURL(i.value),i.value=URL.createObjectURL(e))},d=async()=>{U.value=!0;try{const{data:a}=await c.get("/books/all",{params:{page:g.value,itemsPerPage:w.value,sortBy:v.value[0]?.key||"createdAt",sortOrder:v.value[0]?.order==="asc"?1:-1,search:f.value}});P.value.splice(0,P.value.length,...a.result.data),I.value=a.result.total}catch(a){console.log(a);const e=a?.response?.data?.message||"發生錯誤，請稍後再試";m({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}U.value=!1};d();const O=async a=>{if(console.log(a),!a._id){console.error("沒有書籍 ID");return}try{await c.delete(`/books/${a._id}`),m({text:"書籍已成功刪除",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),d()}catch(e){console.log(e);const o=e?.response?.data?.message||"刪除書籍時發生錯誤，請稍後再試";m({text:o,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}},L=()=>{g.value=1,d()},N=a=>{s.value={...a,image:a.image||""},b.value=!0,n.value=null,i.value=""},F=()=>{b.value=!1,n.value=null,i.value&&(URL.revokeObjectURL(i.value),i.value="");const a=document.querySelector('input[type="file"]');a&&(a.value="")},z=async()=>{B.value=!0;try{if(n.value){const a=new FormData;a.append("image",n.value),a.append("title",s.value.title),a.append("authors",s.value.authors),a.append("publisher",s.value.publisher),a.append("retailPrice",s.value.retailPrice),a.append("categories",s.value.categories),a.append("description",s.value.description),await c.patch(`/books/${s.value._id}`,a,{headers:{"Content-Type":"multipart/form-data"}})}else{const a={title:s.value.title,authors:s.value.authors,publisher:s.value.publisher,retailPrice:parseFloat(s.value.retailPrice)||0,categories:s.value.categories,description:s.value.description};await c.patch(`/books/${s.value._id}`,a)}m({text:"書籍已成功更新",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),d(),F()}catch(a){console.error("更新書籍失敗:",a);let e="更新書籍時發生錯誤，請稍後再試";a?.response?.status===404?e="找不到書籍":a?.response?.status===400?e=a?.response?.data?.message||"ID 格式錯誤":a?.response?.data?.message&&(e=a.response.data.message),m({text:e,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"red",location:"bottom"}})}B.value=!1};return(a,e)=>(V(),y(K,null,{default:l(()=>[t(q,null,{default:l(()=>[t(k,{cols:"12"},{default:l(()=>[t(G,{"items-per-page":w.value,"onUpdate:itemsPerPage":[e[1]||(e[1]=o=>w.value=o),d],"sort-by":v.value,"onUpdate:sortBy":[e[2]||(e[2]=o=>v.value=o),d],page:g.value,"onUpdate:page":[e[3]||(e[3]=o=>g.value=o),d],items:P.value,headers:j,loading:U.value,"items-length":I.value,search:f.value,hover:""},{top:l(()=>[t(p,{label:"搜尋","append-icon":"mdi-magnify",modelValue:f.value,"onUpdate:modelValue":e[0]||(e[0]=o=>f.value=o),"onClick:append":L,onKeydown:J(L,["enter"])},null,8,["modelValue"])]),"item.image":l(({item:o})=>[t(A,{src:o.image,width:"80",height:"80",cover:""},null,8,["src"])]),"item.edit":l(({item:o})=>[t(x,{onClick:E=>N(o)},{default:l(()=>e[11]||(e[11]=[u("編輯",-1)])),_:2,__:[11]},1032,["onClick"])]),"item.delete":l(({item:o})=>[t(x,{onClick:E=>O(o)},{default:l(()=>e[12]||(e[12]=[u("刪除",-1)])),_:2,__:[12]},1032,["onClick"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"]),t(M,{modelValue:b.value,"onUpdate:modelValue":e[10]||(e[10]=o=>b.value=o),persistent:"","max-width":"700px"},{default:l(()=>[t(C,null,{default:l(()=>[t(R,null,{default:l(()=>e[13]||(e[13]=[u("編輯書籍",-1)])),_:1,__:[13]}),t(T,null,{default:l(()=>[t(Y,{ref:"editForm"},{default:l(()=>[t(q,null,{default:l(()=>[t(k,{cols:"12",md:"6"},{default:l(()=>[t(p,{modelValue:s.value.title,"onUpdate:modelValue":e[4]||(e[4]=o=>s.value.title=o),label:"書名",required:""},null,8,["modelValue"]),t(p,{modelValue:s.value.authors,"onUpdate:modelValue":e[5]||(e[5]=o=>s.value.authors=o),label:"作者",required:""},null,8,["modelValue"]),t(p,{modelValue:s.value.publisher,"onUpdate:modelValue":e[6]||(e[6]=o=>s.value.publisher=o),label:"出版者",required:""},null,8,["modelValue"]),t(p,{modelValue:s.value.retailPrice,"onUpdate:modelValue":e[7]||(e[7]=o=>s.value.retailPrice=o),label:"價格",required:"",type:"number"},null,8,["modelValue"]),t(p,{modelValue:s.value.categories,"onUpdate:modelValue":e[8]||(e[8]=o=>s.value.categories=o),label:"分類",required:""},null,8,["modelValue"])]),_:1}),t(k,{cols:"12",md:"6"},{default:l(()=>[t(C,{outlined:""},{default:l(()=>[t(R,null,{default:l(()=>e[14]||(e[14]=[u("書籍圖片",-1)])),_:1,__:[14]}),t(T,null,{default:l(()=>[D()?(V(),y(C,{key:0,class:"image-upload-area mb-3 d-flex align-center justify-center",onClick:S,hover:""},{default:l(()=>[t(A,{class:"mx-auto",src:D(),"max-height":"200","max-width":"100%",contain:""},null,8,["src"]),t(Q,{class:"align-center justify-center hover-overlay","model-value":!1,style:{position:"absolute",top:"0",left:"0",right:"0",bottom:"0",background:"rgba(0,0,0,0.5)",opacity:"0",transition:"opacity 0.3s"}},{default:l(()=>[t(h,{color:"white",size:"48"},{default:l(()=>e[15]||(e[15]=[u("mdi-camera",-1)])),_:1,__:[15]}),e[16]||(e[16]=_("div",{style:{color:"white","margin-top":"8px"}},"點擊更換圖片",-1))]),_:1,__:[16]})]),_:1})):(V(),y(C,{key:1,class:"image-upload-area mb-3 d-flex align-center justify-center",onClick:S,hover:""},{default:l(()=>[_("div",se,[t(h,{size:"64",color:"grey"},{default:l(()=>e[17]||(e[17]=[u("mdi-camera-plus",-1)])),_:1,__:[17]}),e[18]||(e[18]=_("div",{class:"mt-2 text-grey"},"點擊上傳圖片",-1))])]),_:1})),_("input",{ref:"fileInput",type:"file",accept:"image/*",style:{display:"none"},onChange:$},null,544),n.value?(V(),y(W,{key:2,class:"mt-3",type:"info",variant:"tonal"},{default:l(()=>[t(h,{class:"mr-2"},{default:l(()=>e[19]||(e[19]=[u("mdi-file-image",-1)])),_:1,__:[19]}),u("已選擇: "+X(n.value.name),1)]),_:1})):Z("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),t(k,{cols:"12"},{default:l(()=>[t(ee,{modelValue:s.value.description,"onUpdate:modelValue":e[9]||(e[9]=o=>s.value.description=o),label:"簡介",rows:"5"},null,8,["modelValue"])]),_:1})]),_:1},512)]),_:1}),t(ae,null,{default:l(()=>[t(te),t(x,{color:"blue darken-1",variant:"text",onClick:F},{default:l(()=>e[20]||(e[20]=[u("取消",-1)])),_:1,__:[20]}),t(x,{color:"blue darken-1",variant:"text",onClick:z,loading:B.value},{default:l(()=>e[21]||(e[21]=[u("保存",-1)])),_:1,__:[21]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}))}},pe=le(re,[["__scopeId","data-v-9e024360"]]);export{pe as default};
