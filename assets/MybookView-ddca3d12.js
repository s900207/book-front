import{Y as K,X as M,x as c,$ as B,a0 as i,a4 as X,a5 as R,c as g,at as j,aC as k,a8 as z,aa as Y,a1 as q,V as G,ab as J}from"./index-6851ac4d.js";import{V as O}from"./VContainer-622fefbb.js";import{V as Q}from"./VCol-b84c0405.js";import{V as W}from"./VDataTable-92cf24c1.js";import{V as Z}from"./VAlert-87eb0801.js";import{V as ee}from"./VRating-941bbe27.js";import{V as te}from"./VRow-4fc3757b.js";import"./VList-60964e8e.js";import"./VDivider-1adb3401.js";import"./VChip-12f9ec26.js";import"./VSelectionControl-b27dd453.js";const D=55,de={__name:"MybookView",setup(ae){const{apiAuth:x}=J(),w=K(),U=M(),V=c(10),P=c([{key:"createdAt",order:"desc"}]),$=c(1),v=c([]),C=c(null),T=t=>{var a;return((a=t==null?void 0:t.result)==null?void 0:a.image)||(t==null?void 0:t.image)||""},F=t=>{var e;const r=(((e=t==null?void 0:t.result)==null?void 0:e.reviews)||(t==null?void 0:t.reviews)||[]).find(l=>l.user.$oid===w.value||l.user===w.value);return(r==null?void 0:r.rating)||0},N=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"result.title"},{title:"作者",align:"center",sortable:!0,key:"result.authors"},{title:"出版者",align:"center",sortable:!0,key:"result.publisher"},{title:"分類",align:"center",sortable:!0,key:"result.categories"},{title:"評分(1-5)",align:"center",sortable:!0,key:"result.rating"},{title:"書評",align:"center",sortable:!1,key:"result.review",value:t=>{var e;const r=(((e=t==null?void 0:t.result)==null?void 0:e.reviews)||(t==null?void 0:t.reviews)||[]).find(l=>l.user.$oid===w.value||l.user===w.value);if(r){const l=r.comment,o=[];for(let n=0;n<l.length;n+=D)o.push(l.substring(n,n+D));return o.join(`
`)}else return"未提供書評"}}],_=c(!0),m=c(0),d=c(""),E=async t=>{if(!(!t||t.length===0))try{console.log("準備清理無效的 favorite 記錄:",t);const a=t.map(r=>x.delete(`/users/favorite/${r}`).catch(e=>(console.warn(`清理 favorite ${r} 失敗:`,e),null)));await Promise.all(a)}catch(a){console.error("清理 favorite 記錄時發生錯誤:",a)}},f=async()=>{var t,a,r,e;_.value=!0,C.value=null;try{console.log("開始載入使用者喜愛書籍...");const{data:l}=await x.get("/users/favorite");console.log("獲取 favorite IDs:",l);const o=l.result||l;if(!o||o.length===0){v.value=[],m.value=0;return}console.log(`找到 ${o.length} 本喜愛書籍`);const n=[],b=[];for(const s of o){console.log(`嘗試獲取書籍 ID: ${s}`);const L=[`/books/${s}`,`/book/${s}`,`/books/detail/${s}`,`/api/books/${s}`];let h=null,y=!1;for(const p of L)try{const u=await x.get(p);console.log(`成功使用端點 ${p}:`,u.data),h=u.data,y=!0;break}catch(u){if(((t=u.response)==null?void 0:t.status)===404){console.log(`書籍 ${s} 不存在 (404)`);continue}console.log(`端點 ${p} 失敗:`,(a=u.response)==null?void 0:a.status)}y&&h?n.push(h):(console.warn(`書籍 ${s} 不存在，加入清理列表`),b.push(s))}console.log(`有效書籍: ${n.length}, 無效書籍: ${b.length}`),b.length>0&&await E(b);let I=n;d.value&&(I=n.filter(s=>{var p,u;const L=((p=s==null?void 0:s.result)==null?void 0:p.title)||(s==null?void 0:s.title)||"",h=((u=s==null?void 0:s.result)==null?void 0:u.authors)||(s==null?void 0:s.authors)||"",y=d.value.toLowerCase();return L.toLowerCase().includes(y)||h.toLowerCase().includes(y)}));const A=($.value-1)*V.value,H=A+V.value;v.value=I.slice(A,H),m.value=I.length,console.log(`最終顯示書籍數量: ${v.value.length}`)}catch(l){console.error("載入失敗:",l);const o=((e=(r=l==null?void 0:l.response)==null?void 0:r.data)==null?void 0:e.message)||"載入喜愛書籍失敗";U({text:o,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"red",location:"bottom"}}),v.value=[],m.value=0}_.value=!1};f();const S=()=>{$.value=1,f()};return(t,a)=>{const r=X("RouterLink");return R(),B(O,null,{default:i(()=>[g(te,null,{default:i(()=>[g(Q,{cols:"12"},{default:i(()=>[g(W,{"items-per-page":V.value,"onUpdate:itemsPerPage":[a[2]||(a[2]=e=>V.value=e),f],"sort-by":P.value,"onUpdate:sortBy":[a[3]||(a[3]=e=>P.value=e),f],page:$.value,"onUpdate:page":[a[4]||(a[4]=e=>$.value=e),f],items:v.value,headers:N,loading:_.value,"items-length":m.value,search:d.value,hover:""},{top:i(()=>[g(j,{label:"搜尋","append-icon":"mdi-magnify",modelValue:d.value,"onUpdate:modelValue":a[0]||(a[0]=e=>d.value=e),"onClick:append":S,onKeydown:k(S,["enter"])},null,8,["modelValue"]),C.value?(R(),B(Z,{key:0,class:"mt-2",type:"warning",dismissible:"","onClick:close":a[1]||(a[1]=e=>C.value=null)},{default:i(()=>[z(Y(C.value),1)]),_:1})):q("",!0)]),"item.image":i(({item:e})=>{var l,o,n;return[g(r,{class:"text-primary text-decoration-none",to:"/books/"+(((l=e==null?void 0:e.result)==null?void 0:l._id)||(e==null?void 0:e._id)||((o=e==null?void 0:e.result)==null?void 0:o.id)||(e==null?void 0:e.id)),title:((n=e==null?void 0:e.result)==null?void 0:n.title)||(e==null?void 0:e.title)||""},{default:i(()=>[g(G,{src:T(e),width:"80",height:"80",cover:""},null,8,["src"])]),_:2},1032,["to","title"])]}),"item.starRating":i(({item:e})=>[g(ee,{value:F(e),readonly:"",color:"#4d4637 darken-3",size:"20"},null,8,["value"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1})}}};export{de as default};
