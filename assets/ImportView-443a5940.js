import{U as L,x as w,Z as T,$ as s,af as j,a4 as z,c as e,au as i,bH as A,aB as N,a7 as E,aa as _,ax as K,a6 as o,as as B,V as D,ap as H,ar as Z,a9 as G,a8 as J,ae as O,bI as Q}from"./index-c02dc459.js";import{c as W,a as x,d as X}from"./index.esm-3d8b24aa.js";import{u as Y,a as u}from"./vee-validate.esm-b2d216ef.js";import{V as ee}from"./VContainer-978ba718.js";import{V as m}from"./VCol-26eba535.js";import{V}from"./VRow-7d675e66.js";import{V as ae}from"./VForm-630e0d3b.js";import{V as le}from"./VTextarea-961d6650.js";const te=O("h1",{class:"text-center"},"引入書籍",-1),ve={__name:"ImportView",setup(oe){const{apiAuth:P}=j(),y=L(),U=w(!1),k=w(!1),d=w(""),S=W({title:x().required("缺少商品名稱"),publisher:x().required("缺少出版者"),retailPrice:X().typeError("商品價格格式錯誤").required("缺少商品價格").min(0,"商品價格不能小於 0"),description:x().required("缺少簡介")}),{handleSubmit:F}=Y({validationSchema:S,initialValues:{title:"",authors:"",publisher:"",retailPrice:"",categories:"",description:"",image:"",maturityRating:"",buyLink:""}}),c=u("title"),v=u("authors"),p=u("publisher"),f=u("retailPrice"),h=u("categories"),g=u("description"),b=u("image"),M=u("maturityRating"),$=u("buyLink"),I=async()=>{var n,t;if(d.value.trim())try{const l=/^\d{10}(\d{3})?$/.test(d.value),r=encodeURIComponent(d.value.trim()),{data:a}=await Q.get(`https://www.googleapis.com/books/v1/volumes?q=${l?"isbn":"intitle"}:${r}`);console.log(a),a&&a.items&&a.items.length>0&&(c.value.value=a.items[0].volumeInfo.title,v.value.value=a.items[0].volumeInfo.authors,p.value.value=a.items[0].volumeInfo.publisher,f.value.value=a.items[0].saleInfo.retailPrice?a.items[0].saleInfo.retailPrice.amount:null,h.value.value=a.items[0].volumeInfo.categories,g.value.value=a.items[0].volumeInfo.description,b.value.value=a.items[0].volumeInfo.imageLinks.thumbnail.replace("http://","https://").replace("img=1&zoom=1","img=1&zoom=2").replace("edge=curl",""),M.value.value=a.items[0].volumeInfo.maturityRating,$.value.value=a.items[0].saleInfo.buyLink,y({text:"引入成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}))}catch(l){console.error(l);const r=((t=(n=l==null?void 0:l.response)==null?void 0:n.data)==null?void 0:t.message)||"查無此書";y({text:r,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),c.value.value="",v.value.value="",p.value.value="",f.value.value="",h.value.value="",g.value.value="",b.value.value=""}},R=F(async n=>{var t,l;console.log(n);try{const r=new FormData;for(const a in n)r.append(a,n[a]);if(b.value){const a=await fetch(b.value).then(C=>{if(!C.ok)throw new Error("無法獲取圖片");return C.blob()}),q=new File([a],"image.jpg",{type:a.type});r.append("image",q)}for(const a of r.entries())console.log(a[0]+": "+a[1]);await P.post("/books",r,{headers:{"Content-Type":"multipart/form-data"}}),y({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(r){console.log(r);const a=((l=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:l.message)||"發生錯誤，請稍後再試";y({text:a,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}});return(n,t)=>(z(),T(ee,null,{default:s(()=>[e(V,null,{default:s(()=>[e(m,{cols:"12"},{default:s(()=>[te]),_:1})]),_:1}),e(_,null,{default:s(()=>[e(V,null,{default:s(()=>[e(m,null,{default:s(()=>[e(i,{class:"mx-auto mt-5",modelValue:d.value,"onUpdate:modelValue":t[0]||(t[0]=l=>d.value=l),density:"comfortable","menu-icon":"",placeholder:"請輸入書籍名稱或13碼的isbn進行搜尋",rounded:"",theme:"light",variant:"solo",style:A({width:U.value?"100%":"500px"}),"onClick:append":I,onKeydown:N(I,["enter"])},{"prepend-inner":s(()=>[e(E,{href:"#icon-magnify"})]),_:1},8,["modelValue","style"])]),_:1})]),_:1})]),_:1}),e(V,null,{default:s(()=>[e(m,{class:"d-flex justify-center",cols:"12"},{default:s(()=>[e(ae,{disabled:k.value,onSubmit:K(o(R),["prevent"])},{default:s(()=>[e(B,null,{default:s(()=>[e(V,{class:"flex justify-center align-center"},{default:s(()=>[e(m,null,{default:s(()=>[e(B,{class:"d-flex justify-center align-center",outlined:""}),e(D,{src:o(b).value.value,width:"300px",cover:"",readonly:""},null,8,["src"])]),_:1}),e(m,{class:"me-2"},{default:s(()=>[e(H),e(i,{label:"書本名稱",modelValue:o(c).value.value,"onUpdate:modelValue":t[1]||(t[1]=l=>o(c).value.value=l),width:300,"error-messages":o(c).errorMessage.value},null,8,["modelValue","error-messages"]),e(i,{label:"作者",modelValue:o(v).value.value,"onUpdate:modelValue":t[2]||(t[2]=l=>o(v).value.value=l),"error-messages":o(v).errorMessage.value},null,8,["modelValue","error-messages"]),e(i,{label:"出版者",modelValue:o(p).value.value,"onUpdate:modelValue":t[3]||(t[3]=l=>o(p).value.value=l),"error-messages":o(p).errorMessage.value},null,8,["modelValue","error-messages"]),e(i,{label:"價格",modelValue:o(f).value.value,"onUpdate:modelValue":t[4]||(t[4]=l=>o(f).value.value=l),"error-messages":o(f).errorMessage.value},null,8,["modelValue","error-messages"]),e(i,{label:"分類",modelValue:o(h).value.value,"onUpdate:modelValue":t[5]||(t[5]=l=>o(h).value.value=l)},null,8,["modelValue"]),e(le,{label:"簡介",modelValue:o(g).value.value,"onUpdate:modelValue":t[6]||(t[6]=l=>o(g).value.value=l),"error-messages":o(g).errorMessage.value},null,8,["modelValue","error-messages"]),e(Z)]),_:1})]),_:1})]),_:1}),e(V,{class:"text-center mb-5",cols:"12"},{default:s(()=>[e(m,null,{default:s(()=>[e(_),e(G,{color:"green",type:"submit",loading:k.value},{default:s(()=>[J("送出")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1})]),_:1}))}};export{ve as default};
