import{_ as A,s as H,t as M,w as T,P as U,H as L,r as E,i as f,V as Q}from"./index-BztlkOgS.js";import{b as _,e as S,H as R,a1 as p,a2 as o,ac as Z,a3 as v,j as l,a8 as G,l as c,a6 as k,Z as x,u as C}from"./vue-vendor-DIljl67C.js";import{r as J,s as K,t as O}from"./icons-BFoqPsYi.js";import{V as W}from"./VContainer-SQJYyrIl.js";import{V as w}from"./VCol-PEBWolzp.js";import{V as X}from"./VDivider-m7GLFw2H.js";import{V as Y}from"./VDataTable-CyYGtjtm.js";import"./vuetify-vendor-BSJ2BONf.js";import"./VList-BeUcNFmC.js";import"./VChip-BiEoPDoi.js";import"./VSelectionControl-DZgMmC-H.js";const tt={class:"d-flex align-center justify-center"},et={class:"mx-3"},at={__name:"CartView",setup(ot){const{apiAuth:g}=T(),V=H(),u=M(),y=Z(),s=_([]),d=_(!1),r=_(!1),b=_(!1),z=[{title:"書本圖片",key:"book.image",align:"center",sortable:!1},{title:"書本名稱",key:"book.title"},{title:"單價",key:"book.retailPrice",align:"center"},{title:"數量",key:"quantity",align:"center",sortable:!1},{title:"小計",key:"total",align:"center",sortable:!1},{title:"操作",key:"action",align:"center",sortable:!1}],D=S(()=>s.value.reduce((a,t)=>a+t.quantity*t.book.retailPrice,0)),P=S(()=>s.value.length>0&&!d.value&&!r.value),m=(a,t="發生錯誤，請稍後再試")=>{const e=a?.response?.data?.message||t;V({text:e,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"red",location:"bottom"}})},h=a=>{V({text:a,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})},q=async(a,t)=>{if(!u.isLogin){y.push("/login");return}const e=s.value.find(n=>n.book._id===a);if(!e){m(null,"找不到指定的商品");return}const i=e.quantity+t;if(i<=0){await B(a,e.quantity);return}r.value=!0;try{const{data:n}=await g.patch("/users/cart",{book:a,quantity:t});u.cart=n.result;const $=s.value.findIndex(j=>j.book._id===a);$!==-1&&(s.value[$].quantity=i);const I=t>0?"商品數量已增加":"商品數量已減少";h(I)}catch(n){m(n,"更新數量失敗")}finally{r.value=!1}},B=async(a,t)=>{if(!u.isLogin){y.push("/login");return}r.value=!0;try{const{data:e}=await g.patch("/users/cart",{book:a,quantity:-t});u.cart=e.result;const i=s.value.findIndex(n=>n.book._id===a);i!==-1&&s.value.splice(i,1),h("商品已從購物車移除")}catch(e){m(e,"移除商品失敗")}finally{r.value=!1}},N=async()=>{if(P.value){b.value=!0;try{await g.post("/orders"),u.cart=0,s.value=[],h("結帳成功！"),y.push("/orders")}catch(a){m(a,"結帳失敗")}finally{b.value=!1}}},F=async()=>{if(!u.isLogin){V({text:"請先登入才能查看購物車",showCloseButton:!1,snackbarProps:{timeout:3e3,color:"warning",location:"bottom"}}),y.push("/login");return}d.value=!0;try{const{data:a}=await g.get("/users/cart");s.value=[...a.result]}catch(a){m(a,"載入購物車失敗")}finally{d.value=!1}};return R(()=>{F()}),(a,t)=>(v(),p(W,null,{default:o(()=>[l(w,{cols:"12"},{default:o(()=>t[0]||(t[0]=[c("h1",null,"購物車",-1)])),_:1,__:[0]}),l(X),l(w,{cols:"12"},{default:o(()=>[d.value?(v(),p(U,{key:0,indeterminate:"",color:"primary"})):s.value.length===0?(v(),p(L,{key:1,class:"text-center pa-8"},{default:o(()=>[l(E,{size:"64",color:"grey"},{default:o(()=>t[1]||(t[1]=[k("mdi-cart-outline",-1)])),_:1,__:[1]}),t[3]||(t[3]=c("h3",{class:"mt-4 mb-2"},"購物車是空的",-1)),t[4]||(t[4]=c("p",{class:"text-grey"},"還沒有添加任何商品到購物車",-1)),l(f,{color:"primary",to:"/"},{default:o(()=>t[2]||(t[2]=[k("繼續購物",-1)])),_:1,__:[2]})]),_:1,__:[3,4]})):(v(),p(Y,{key:2,items:s.value,headers:z,loading:d.value},{"item.book.image":o(({item:e})=>[l(Q,{src:e.book.image,alt:"Book Image","max-height":"100","max-width":"60"},null,8,["src"])]),"item.quantity":o(({item:e})=>[c("div",tt,[l(f,{variant:"text",icon:C(K),color:"red",size:"small",disabled:r.value,onClick:i=>q(e.book._id,-1)},null,8,["icon","disabled","onClick"]),c("span",et,x(e.quantity),1),l(f,{variant:"text",icon:C(O),color:"green",size:"small",disabled:r.value,onClick:i=>q(e.book._id,1)},null,8,["icon","disabled","onClick"])])]),"item.action":o(({item:e})=>[l(f,{variant:"text",icon:C(J),color:"red",disabled:r.value,onClick:i=>B(e.book._id,e.quantity)},null,8,["icon","disabled","onClick"])]),"item.book.retailPrice":o(({item:e})=>[k("$"+x(e.book.retailPrice),1)]),"item.total":o(({item:e})=>[k("$"+x((e.book.retailPrice*e.quantity).toFixed(2)),1)]),_:2},1032,["items","loading"]))]),_:1}),s.value.length>0?(v(),p(w,{key:0,class:"text-center",cols:"12"},{default:o(()=>[l(L,{class:"pa-4"},{default:o(()=>[c("h3",null,"總金額: $"+x(D.value.toFixed(2)),1),l(f,{class:"mt-4",color:"green",size:"large",disabled:!P.value||b.value,loading:b.value,onClick:N},{default:o(()=>t[5]||(t[5]=[k("結帳",-1)])),_:1,__:[5]},8,["disabled","loading"])]),_:1})]),_:1})):G("",!0)]),_:1}))}},vt=A(at,[["__scopeId","data-v-183a6fea"]]);export{vt as default};
