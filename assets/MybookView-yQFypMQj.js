import{b as o,a1 as _,a2 as i,aa as j,a3 as x,j as u,a8 as F,ag as H,a6 as K,Z as X}from"./vue-vendor-DIljl67C.js";import{t as Z,s as q,w as E,V as G,I}from"./index-Dgshs8fK.js";import{V as J}from"./VContainer-DbX2Rh5J.js";import{V as O}from"./VRow-DwH8bsee.js";import{V as Q}from"./VCol-DTDbqipV.js";import{V as W}from"./VDataTable-CbrdD3SI.js";import{V as Y}from"./VRating-CKUySymp.js";import{V as z}from"./VAlert-yH1biBER.js";import"./vuetify-vendor-BSJ2BONf.js";import"./VList-CFJAGnQ1.js";import"./VDivider-CBVbG1b6.js";import"./VChip-Bjmy39e2.js";import"./VSelectionControl-Dpd8An-8.js";const L=55,ge={__name:"MybookView",setup(ee){const{apiAuth:V}=E(),m=Z(),A=q(),g=o(10),B=o([{key:"createdAt",order:"desc"}]),f=o(1),d=o([]),h=o(null),y=new Map,k=o(!1),U=t=>t?.result?.image||t?.image||"",D=t=>(t?.result?.reviews||t?.reviews||[]).find(e=>e.user.$oid===m.value||e.user===m.value)?.rating||0,S=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"result.title"},{title:"作者",align:"center",sortable:!0,key:"result.authors"},{title:"出版者",align:"center",sortable:!0,key:"result.publisher"},{title:"分類",align:"center",sortable:!0,key:"result.categories"},{title:"評分(1-5)",align:"center",sortable:!0,key:"result.rating"},{title:"書評",align:"center",sortable:!1,key:"result.review",value:t=>{const a=(t?.result?.reviews||t?.reviews||[]).find(e=>e.user.$oid===m.value||e.user===m.value);if(a){const e=a.comment,l=[];for(let n=0;n<e.length;n+=L)l.push(e.substring(n,n+L));return l.join(`
`)}else return"未提供書評"}}],C=o(!0),w=o(0),v=o(""),T=async t=>{if(y.has(t))return y.get(t);try{const a=(await V.get(`/books/${t}`)).data;return y.set(t,a),a}catch(s){if(s.response?.status===404)return y.set(t,null),null;throw s}},$=async(t,s=3)=>{const a=[],e=[];for(let l=0;l<t.length;l+=s){const R=t.slice(l,l+s).map(async r=>{try{const c=await T(r);return{bookId:r,book:c,valid:c!==null}}catch(c){return console.warn(`獲取書籍 ${r} 失敗:`,c),{bookId:r,book:null,valid:!1}}}),b=await Promise.all(R);for(const r of b)r.valid&&r.book?a.push(r.book):e.push(r.bookId);l+s<t.length&&await new Promise(r=>setTimeout(r,100))}return{validBooks:a,invalidIds:e}},M=async t=>{if(!(!t||t.length===0||k.value)){k.value=!0;try{const s=t.map(async a=>{try{return await V.delete(`/users/favorite/${a}`),{bookId:a,success:!0}}catch(e){return e.response?.status===404?{bookId:a,success:!0,alreadyRemoved:!0}:{bookId:a,success:!1,error:e}}});await Promise.all(s)}catch{}finally{k.value=!1}}},p=async()=>{C.value=!0,h.value=null;try{const{data:t}=await V.get("/users/favorite");console.log("獲取 favorite IDs:",t);const s=t.result||t;if(!s||s.length===0){d.value=[],w.value=0;return}const{validBooks:a,invalidIds:e}=await $(s);e.length>0&&setTimeout(()=>M(e),0);let l=a;if(v.value){const b=v.value.toLowerCase();l=a.filter(r=>{const c=r?.result?.title||r?.title||"",N=r?.result?.authors||r?.authors||"";return c.toLowerCase().includes(b)||N.toLowerCase().includes(b)})}const n=(f.value-1)*g.value,R=n+g.value;d.value=l.slice(n,R),w.value=l.length}catch(t){console.error("載入失敗:",t);const s=t?.response?.data?.message||"載入喜愛書籍失敗";A({text:s,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"red",location:"bottom"}}),d.value=[],w.value=0}finally{C.value=!1}},P=()=>{f.value=1,p()};return p(),(t,s)=>{const a=j("RouterLink");return x(),_(J,null,{default:i(()=>[u(O,null,{default:i(()=>[u(Q,{cols:"12"},{default:i(()=>[u(W,{"items-per-page":g.value,"onUpdate:itemsPerPage":[s[2]||(s[2]=e=>g.value=e),p],"sort-by":B.value,"onUpdate:sortBy":[s[3]||(s[3]=e=>B.value=e),p],page:f.value,"onUpdate:page":[s[4]||(s[4]=e=>f.value=e),p],items:d.value,headers:S,loading:C.value,"items-length":w.value,search:v.value,hover:""},{top:i(()=>[u(I,{label:"搜尋","append-icon":"mdi-magnify",modelValue:v.value,"onUpdate:modelValue":s[0]||(s[0]=e=>v.value=e),"onClick:append":P,onKeydown:H(P,["enter"])},null,8,["modelValue"]),h.value?(x(),_(z,{key:0,class:"mt-2",type:"warning",dismissible:"","onClick:close":s[1]||(s[1]=e=>h.value=null)},{default:i(()=>[K(X(h.value),1)]),_:1})):F("",!0)]),"item.image":i(({item:e})=>[u(a,{class:"text-primary text-decoration-none",to:"/books/"+(e?.result?._id||e?._id||e?.result?.id||e?.id),title:e?.result?.title||e?.title||""},{default:i(()=>[u(G,{src:U(e),width:"80",height:"80",cover:""},null,8,["src"])]),_:2},1032,["to","title"])]),"item.starRating":i(({item:e})=>[u(Y,{value:D(e),readonly:"",color:"#4d4637 darken-3",size:"20"},null,8,["value"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1})}}};export{ge as default};
