import{p as Q,m as W,a as ee,g as te,u as ae,c as e,Z as j,x as y,Y as H,X as E,ab as J,aw as oe,A as le,a0 as C,a1 as S,a3 as t,ax as se,a5 as D,V as ne,ao as R,J as x,a7 as k,a8 as F,aa as v,an as c,a2 as T,a4 as ue,av as U,a6 as re,ap as M,al as ie,ay as ce}from"./index-ac5a01e2.js";import{u as de}from"./vee-validate.esm-48e9a1ee.js";import{V as me}from"./VContainer-ff6f7ae5.js";import{V as p}from"./VRow-9c0b56d7.js";import{V as u}from"./VCol-af345920.js";import{V as N}from"./VForm-8726e331.js";import{V as $}from"./VRating-42573fd6.js";import{V as q}from"./VTextarea-e7d29501.js";import{b as pe,V as ve,a as fe,c as ge}from"./VList-0900aa65.js";import"./VDivider-5684f045.js";const _e=Q({start:Boolean,end:Boolean,...W(),...ee()},"VListItemAction"),z=te()({name:"VListItemAction",props:_e(),setup(d,f){let{slots:_}=f;return ae(()=>e(d.tag,{class:["v-list-item-action",{"v-list-item-action--start":d.start,"v-list-item-action--end":d.end},d.class],style:d.style},_)),{}}});function be(d){const{apiAuth:f}=J(),_=j(),m=y(!1),w=H(),b=E();return{isFavorite:m,checkFavoriteStatus:async()=>{try{const{data:r}=await f.get("/users/favorite",{params:{bookId:d}});m.value=r.result.includes(d)}catch(r){console.error(r),m.value=!1}},addFavorite:async()=>{if(!_.isLogin){b.push("/login");return}m.value=!m.value;try{const{data:r}=await f.post("/users/favorite",{bookId:d,isFavorite:m.value});_.favorite=r.result,w({text:m.value?"已加入我的最愛":"已移除我的最愛",showCloseButton:!1,snackbarProps:{timeout:2e3,color:m.value?"green":"red",location:"bottom"}})}catch(r){console.error(r),r.response&&r.response.status===401?b.push("/login"):w({text:"發生錯誤，請稍後再試",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}}}const Ve=c("h3",null,"出版者:",-1),he=c("h3",null,"價格:",-1),ke=c("h3",null,"分類:",-1),ye=c("h3",null,"簡介:",-1),we=["innerHTML"],Ce={key:1},xe=c("h3",null,"新增書評:",-1),Fe=c("h3",null,"書評:",-1),Le=c("h3",null,"編輯書評",-1),Me={__name:"BookView",setup(d){const f=oe(),_=E(),{api:m,apiAuth:w}=J(),b=y(!1),L=y(!1),g=H(),r=j(),V=y({usersId:"",rating:0,comment:""}),B=y(!1),{handleSubmit:I}=de({initialValues:{usersId:"",rating:0,comment:""}}),l=y({_id:"",image:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",buyLink:"",description:"",reviews:[]}),i=y([]),{isFavorite:P,checkFavoriteStatus:X,addFavorite:Y}=be(f.params.id),Z=()=>{B.value=!1},A=I(async s=>{var a,o;if(console.log(V.value),!r.isLogin){_.push("/login"),g({text:"請先登入",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}});return}try{const{data:n}=await w.post(`/books/${f.params.id}/reviews`,{rating:V.value.rating,conmment:V.value.comment});n&&n.result&&l.value.reviews.push(n.result),g({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(n){console.log(n);const h=((o=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:o.message)||"發生錯誤，請稍後再試";g({text:h,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),G=s=>{if(s){const a=l.value.reviews.find(o=>o._id===s);i.value.id=a._id,i.value.rating=a.rating,i.value.comment=a.comment,i.value.bookId=l.value._id,console.log(i.value.bookId)}B.value=!0},K=I(async s=>{var a,o;try{console.log(i.value),console.log("Form values:",s);const n=new FormData;for(const h in s)n.append(h,i.value[h]||s[h]);B.value===""&&await w.patch(`/books/${i.value.bookId}/reviews/${i.value.id}`,n),console.log("FormData entries:",...n.entries()),g({text:"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(n){console.log(n);const h=((o=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:o.message)||"發生錯誤，請稍後再試";g({text:h,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}Z()});console.log(i.value),le(async()=>{try{const{data:s}=await m.get(`/books/${f.params.id}`);l.value._id=s.result._id,l.value.image=s.result.image,l.value.title=s.result.title,l.value.authors=s.result.authors,l.value.publisher=s.result.publisher,l.value.retailPrice=s.result.retailPrice,l.value.categories=s.result.categories,l.value.buyLink=s.result.buyLink;let a=s.result.description.replace(/(※|★|◆|✓|●|▓|▌|￭|──|【)/g,"<br>$1");a=a.replace(/(】)/g,"$1<br>"),a=a.replace(new RegExp("(?<=──[^,]*?)(?=,)","g"),"<br>$1"),l.value.description=a,l.value.reviews=s.result.reviews,document.title=`書評網 | ${l.value.title}`,r.isLogin&&(P.value=await X())}catch(s){console.log(s)}});const O=async()=>{var s,a;if(!r.isLogin){_.push("/login");return}try{const{data:o}=await w.patch("/users/cart",{book:l.value._id,quantity:1});r.cart=o.result,g({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(o){const n=((a=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";g({text:n,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}};return(s,a)=>(C(),S(D,null,[e(me,null,{default:t(()=>[e(p,null,{default:t(()=>[e(u,{cols:"12",md:"3",style:{position:"sticky"},top:"0"},{default:t(()=>[e(ne,{src:l.value.image},null,8,["src"]),e(R,null,{default:t(()=>[e(p,{class:"justify-center align-center"},{default:t(()=>[e(u,{cols:"6"},{default:t(()=>[e(x,{"prepend-icon":k(P)?"mdi-heart-minus":"mdi-heart-plus",color:k(P)?"red":"blue",onClick:k(Y)},{default:t(()=>[F(v(k(P)?"取消最愛":"加入最愛"),1)]),_:1},8,["prepend-icon","color","onClick"])]),_:1}),e(u,{cols:"6"},{default:t(()=>[e(x,{color:"primary","prepend-icon":"mdi-cart",onClick:O},{default:t(()=>[F("加入購物車")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(u,{cols:"12",md:"9"},{default:t(()=>[c("h1",null,v(l.value.title),1),c("h2",null,v(l.value.authors),1),e(p,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[Ve]),_:1}),e(u,null,{default:t(()=>[c("p",null,v(l.value.publisher),1)]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[he]),_:1}),e(u,null,{default:t(()=>[c("p",null,"$"+v(l.value.retailPrice),1)]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[ke]),_:1}),e(u,null,{default:t(()=>[c("p",null,v(l.value.categories),1)]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[ye,L.value?(C(),S("p",{key:0,innerHTML:l.value.description},null,8,we)):(C(),S("p",Ce,v(l.value.description.substring(0,500)),1))]),_:1}),e(u,{class:"text-center"},{default:t(()=>[l.value.description.length>100?(C(),T(x,{key:0,color:"#4d4637",onClick:a[0]||(a[0]=o=>L.value=!L.value),icon:L.value?"mdi-chevron-up":"mdi-chevron-down"},null,8,["icon"])):ue("",!0)]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(u,{cols:"12"},{default:t(()=>[xe,e(N,{disabled:b.value,onSubmit:U(k(A),["prevent"])},{default:t(()=>[e($,{modelValue:V.value.rating,"onUpdate:modelValue":a[1]||(a[1]=o=>V.value.rating=o),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(q,{modelValue:V.value.comment,"onUpdate:modelValue":a[2]||(a[2]=o=>V.value.comment=o),label:"你的書評",required:""},null,8,["modelValue"]),e(x,{color:"#4d4637",type:"submit",loading:b.value},{default:t(()=>[F("提交")]),_:1},8,["loading"])]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(u,{cols:"12"},{default:t(()=>[Fe,e(pe,null,{default:t(()=>[(C(!0),S(D,null,re(l.value.reviews,o=>(C(),T(ve,{key:o._id},{default:t(()=>[e(M,null,{default:t(()=>[e(p,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[e(fe,{style:{fontSize:"30px"}},{default:t(()=>[F(v(o.user.account),1)]),_:2},1024)]),_:2},1024),e(u,{cols:"auto"},{default:t(()=>[e(z,null,{default:t(()=>[e($,{modelValue:o.rating,"onUpdate:modelValue":n=>o.rating=n,color:"#4d4637 darken-3",size:"25",readonly:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),e(p,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[e(ge,{class:"mb-5",style:{fontSize:"20px"}},{default:t(()=>[F(v(o.comment),1)]),_:2},1024)]),_:2},1024),e(u,{class:"d-flex justify-end"},{default:t(()=>[e(z,null,{default:t(()=>[e(x,{icon:"mdi-pencil",color:"#4d4637",onClick:()=>G(o._id)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(se,{modelValue:B.value,"onUpdate:modelValue":a[6]||(a[6]=o=>B.value=o),"max-width":"290"},{default:t(()=>[e(N,{disabled:b.value,onSubmit:U(k(A),["prevent"])},{default:t(()=>[e(M,null,{default:t(()=>[e(ie,null,{default:t(()=>[Le]),_:1}),e(ce,null,{default:t(()=>[e($,{modelValue:i.value.rating,"onUpdate:modelValue":a[3]||(a[3]=o=>i.value.rating=o),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(q,{modelValue:i.value.comment,"onUpdate:modelValue":a[4]||(a[4]=o=>i.value.comment=o),label:"你的書評",required:""},null,8,["modelValue"])]),_:1}),e(R,null,{default:t(()=>[e(x,{color:"#4d4637",onClick:a[5]||(a[5]=o=>k(K)(s.review)),loading:b.value},{default:t(()=>[F("修正")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64))}};export{Me as default};
