import{e as M,l as j,m as J,n as O,b as c,H as Q,a1 as T,a2 as d,aa as W,a3 as A,j as h,a8 as ee,ag as te,u as ae,a6 as se,Z as re}from"./vue-vendor-DIljl67C.js";import{u as le,n as ne,e as oe,b as ie,o as ue,_ as ce,t as de,w as ve,V as ge,I as pe}from"./index-BukUmwCl.js";import{j as me}from"./icons-C5frdmYn.js";import{V as fe}from"./VContainer-CadW4Yhc.js";import{V as he}from"./VRow-RvhGQClm.js";import{V as be}from"./VCol-0vCj-r-e.js";import{V as ye}from"./VDataTable-B4yvCMaK.js";import{V as we}from"./VRating-cHAL74zM.js";import{g as ke,p as Ve,d as Ce,R as xe,E as Be,f as _e,m as Pe}from"./vuetify-vendor-BSJ2BONf.js";import{V as Le}from"./VAlert-CXwjoNWY.js";import"./VList-DmhBqPma.js";import"./VDivider-B42yIG-m.js";import"./VChip-BngVARYO.js";import"./VSelectionControl-DNcjOMSU.js";const Re={actions:"button@2",article:"heading, paragraph",avatar:"avatar",button:"button",card:"image, heading","card-avatar":"image, list-item-avatar",chip:"chip","date-picker":"list-item, heading, divider, date-picker-options, date-picker-days, actions","date-picker-options":"text, avatar@2","date-picker-days":"avatar@28",divider:"divider",heading:"heading",image:"image","list-item":"text","list-item-avatar":"avatar, text","list-item-two-line":"sentences","list-item-avatar-two-line":"avatar, sentences","list-item-three-line":"paragraph","list-item-avatar-three-line":"avatar, paragraph",ossein:"ossein",paragraph:"text@3",sentences:"text@2",subtitle:"text",table:"table-heading, table-thead, table-tbody, table-tfoot","table-heading":"chip, text","table-thead":"heading@6","table-tbody":"table-row-divider@6","table-row-divider":"table-row, divider","table-row":"text@6","table-tfoot":"text@2, avatar@2",text:"text"};function Se(s){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];return j("div",{class:O(["v-skeleton-loader__bone",`v-skeleton-loader__${s}`])},[n])}function $(s){const[n,l]=s.split("@");return Array.from({length:l}).map(()=>B(n))}function B(s){let n=[];if(!s)return n;const l=Re[s];if(s!==l){if(s.includes(","))return D(s);if(s.includes("@"))return $(s);l.includes(",")?n=D(l):l.includes("@")?n=$(l):l&&n.push(B(l))}return[Se(s,n)]}function D(s){return s.replace(/\s/g,"").split(",").map(B)}const Te=Ve({boilerplate:Boolean,color:String,loading:Boolean,loadingText:{type:String,default:"$vuetify.loading"},type:{type:[String,Array],default:"ossein"},...ue(),...ie(),...Pe()},"VSkeletonLoader"),Ae=ke()({name:"VSkeletonLoader",props:Te(),setup(s,n){let{slots:l}=n;const{backgroundColorClasses:b,backgroundColorStyles:y}=le(()=>s.color),{dimensionStyles:C}=ne(s),{elevationClasses:v}=oe(s),{themeClasses:w}=Ce(s),{t:g}=xe(),p=M(()=>B(Be(s.type).join(",")));return _e(()=>{const m=!l.default||s.loading,f=s.boilerplate||!m?{}:{ariaLive:"polite",ariaLabel:g(s.loadingText),role:"alert"};return j("div",J({class:["v-skeleton-loader",{"v-skeleton-loader--boilerplate":s.boilerplate},w.value,b.value,v.value],style:[y.value,m?C.value:{}]},f),[m?p.value:l.default?.()])}),{}}}),U=55,L=3,E=100,$e={__name:"MybookView",setup(s,{expose:n}){const{apiAuth:l}=ve(),b=de(),y=c(10),C=c([{key:"createdAt",order:"desc"}]),v=c(1),w=c([]),g=c([]),p=c(null),m=c(!1),f=c(""),k=new Map,_=c(!1),F=M(()=>f.value?R().length:g.value.length),H=a=>a?.result?.image||a?.image||"/placeholder-book.jpg",N=a=>(a?.result?.reviews||a?.reviews||[]).find(e=>e.user?.$oid===b.value||e.user===b.value)?.rating||0,z=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"result.title"},{title:"作者",align:"center",sortable:!0,key:"result.authors"},{title:"出版者",align:"center",sortable:!0,key:"result.publisher"},{title:"分類",align:"center",sortable:!0,key:"result.categories"},{title:"評分(1-5)",align:"center",sortable:!1,key:"starRating"},{title:"書評",align:"center",sortable:!1,key:"result.review",value:a=>{const r=(a?.result?.reviews||a?.reviews||[]).find(e=>e.user?.$oid===b.value||e.user===b.value);if(r?.comment){const e=r.comment,u=[];for(let o=0;o<e.length;o+=U)u.push(e.substring(o,o+U));return u.join(`
`)}return"未提供書評"}}],K=async(a,t=2)=>{if(k.has(a))return k.get(a);let r=null;for(let e=0;e<=t;e++)try{const o=(await l.get(`/books/${a}`)).data;return k.set(a,o),o}catch(u){if(r=u,u.response?.status===404)return k.set(a,null),null;e<t&&await new Promise(o=>setTimeout(o,E*(e+1)))}return console.warn(`獲取書籍 ${a} 失敗 (已重試 ${t} 次):`,r),k.set(a,null),null},Y=async a=>{const t=[],r=[];try{for(let e=0;e<a.length;e+=L){const o=a.slice(e,e+L).map(async i=>{try{const x=await K(i);return{bookId:i,book:x,valid:x!==null}}catch(x){return console.warn(`批次處理書籍 ${i} 失敗:`,x),{bookId:i,book:null,valid:!1}}}),I=await Promise.all(o);for(const i of I)i.valid&&i.book?t.push(i.book):r.push(i.bookId);e+L<a.length&&await new Promise(i=>setTimeout(i,E))}}catch(e){console.error("批次獲取書籍時發生錯誤:",e),p.value="載入書籍時發生錯誤，請稍後重試"}return{validBooks:t,invalidIds:r}},Z=async a=>{if(!(!a?.length||_.value)){_.value=!0;try{const t=a.map(async r=>{try{return await l.delete(`/users/favorite/${r}`),{bookId:r,success:!0}}catch(e){return e.response?.status===404?{bookId:r,success:!0,alreadyRemoved:!0}:(console.warn(`清理收藏 ${r} 失敗:`,e),{bookId:r,success:!1,error:e})}});await Promise.all(t)}catch(t){console.error("清理無效收藏時發生錯誤:",t)}finally{_.value=!1}}},R=()=>{if(!f.value)return g.value;const a=f.value.toLowerCase();return g.value.filter(t=>{const r=t?.result?.title||t?.title||"",e=t?.result?.authors||t?.authors||"",u=t?.result?.publisher||t?.publisher||"",o=t?.result?.categories||t?.categories||"";return r.toLowerCase().includes(a)||e.toLowerCase().includes(a)||u.toLowerCase().includes(a)||o.toLowerCase().includes(a)})},V=()=>{const a=R(),t=(v.value-1)*y.value,r=t+y.value;w.value=a.slice(t,r)},S=async()=>{if(!m.value){m.value=!0,p.value=null;try{const{data:a}=await l.get("/users/favorite"),t=a?.result||a||[];if(!t.length){g.value=[],w.value=[];return}const{validBooks:r,invalidIds:e}=await Y(t);g.value=r,V(),e.length>0&&setTimeout(()=>Z(e),0)}catch(a){console.error("載入收藏失敗:",a),p.value=a?.response?.data?.message||"載入喜愛書籍失敗",g.value=[],w.value=[]}finally{m.value=!1}}},P=()=>{v.value=1,V()},X=()=>{V()},q=()=>{v.value=1,V()},G=()=>{v.value=1,V()};return Q(()=>{S()}),n({tableLoadItems:S,tableApplySearch:P}),(a,t)=>{const r=W("RouterLink");return A(),T(fe,null,{default:d(()=>[h(he,null,{default:d(()=>[h(be,{cols:"12"},{default:d(()=>[h(ye,{"items-per-page":y.value,"onUpdate:itemsPerPage":[t[2]||(t[2]=e=>y.value=e),q],"sort-by":C.value,"onUpdate:sortBy":[t[3]||(t[3]=e=>C.value=e),G],page:v.value,"onUpdate:page":[t[4]||(t[4]=e=>v.value=e),X],items:w.value,headers:z,loading:m.value,"items-length":F.value,search:f.value,hover:""},{top:d(()=>[h(pe,{label:"搜尋","append-icon":ae(me),modelValue:f.value,"onUpdate:modelValue":t[0]||(t[0]=e=>f.value=e),"onClick:append":P,onKeydown:te(P,["enter"])},null,8,["append-icon","modelValue"]),p.value?(A(),T(Le,{key:0,class:"mt-2",type:"error",dismissible:"","onClick:close":t[1]||(t[1]=e=>p.value=null)},{default:d(()=>[se(re(p.value),1)]),_:1})):ee("",!0)]),"item.image":d(({item:e})=>[h(r,{class:"text-primary text-decoration-none",to:"/books/"+(e?.result?._id||e?._id||e?.result?.id||e?.id),title:e?.result?.title||e?.title||""},{default:d(()=>[h(ge,{src:H(e),width:"80",height:"80",cover:"",alt:e?.result?.title||e?.title||"書籍圖片"},{placeholder:d(()=>[h(Ae,{type:"image"})]),_:2},1032,["src","alt"])]),_:2},1032,["to","title"])]),"item.starRating":d(({item:e})=>[h(we,{"model-value":N(e),readonly:"",color:"#4d4637 darken-3",size:"20"},null,8,["model-value"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1})}}},Ie=ce($e,[["__scopeId","data-v-858f7ae3"]]);export{Ie as default};
