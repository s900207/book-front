import{p as E,m as J,a as K,g as Q,u as W,c as e,ak as X,K as Z,x as f,L as G,M as O,A as Y,P as p,Q as w,S as l,al as ee,U as I,a0 as le,V as te,J as _,Z as b,aj as r,$ as c,R,T as ae,ai as T,X as x,W as oe,ac as U,aa as se,am as ue,an as ne}from"./index-eceac6c8.js";import{u as ie,V as A}from"./vee-validate.esm-e8aa8c4e.js";import{V as re}from"./VContainer-5159a744.js";import{V as d,a as u}from"./VRow-66aaf290.js";import{V as L}from"./VRating-512818bc.js";import{V as F}from"./VTextarea-e555db9c.js";import{b as de,V as ce,a as me,c as fe}from"./VList-c30061fd.js";import"./VDivider-9d481733.js";const ve=E({start:Boolean,end:Boolean,...J(),...K()},"VListItemAction"),D=Q()({name:"VListItemAction",props:ve(),setup(v,h){let{slots:C}=h;return W(()=>e(v.tag,{class:["v-list-item-action",{"v-list-item-action--start":v.start,"v-list-item-action--end":v.end},v.class],style:v.style},C)),{}}}),pe=r("h3",null,"出版者:",-1),_e=r("h3",null,"價格:",-1),ge=r("h3",null,"分類:",-1),Ve=r("h3",null,"簡介:",-1),be=["innerHTML"],he={key:1},ke=r("h3",null,"新增書評:",-1),ye=r("h3",null,"書評:",-1),we=r("h3",null,"編輯書評",-1),Re={__name:"BookView",setup(v){const h=X(),C=Z(),{api:M,apiAuth:B}=le(),k=f(!1),y=f(!1),g=G(),N=O(),m=f({usersId:"",rating:0,comment:""}),V=f(!1),P=f(!1),{handleSubmit:S}=ie({initialValues:{usersId:"",rating:0,comment:""}}),o=f({_id:"",image:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",buyLink:"",description:"",reviews:[]}),n=f([]),j=()=>{V.value=!1},$=S(async s=>{var t,a;if(console.log(m.value),!N.isLogin){C.push("/login"),g({text:"請先登入",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}});return}try{const{data:i}=await B.post(`/books/${h.params.id}/reviews`,{rating:m.value.rating,conmment:m.value.comment});i&&i.result&&o.value.reviews.push(i.result),g({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(i){console.log(i);const H=((a=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";g({text:H,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),z=s=>{if(s){const t=o.value.reviews.find(a=>a._id===s);n.value.id=t._id,n.value.rating=t.rating,n.value.comment=t.comment,n.value.bookId=o.value._id}V.value=!0},q=S(async()=>{var s,t;console.log(n.value);try{V.value===""&&await B.patch(`/books/${n.value.bookId}/reviews/${n.value.id}`,n.value),g({text:"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(a){console.log(a);const i=((t=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:t.message)||"發生錯誤，請稍後再試";g({text:i,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}j()});return Y(async()=>{try{const{data:s}=await M.get(`/books/${h.params.id}`);o.value._id=s.result._id,o.value.image=s.result.image,o.value.title=s.result.title,o.value.authors=s.result.authors,o.value.publisher=s.result.publisher,o.value.retailPrice=s.result.retailPrice,o.value.categories=s.result.categories,o.value.buyLink=s.result.buyLink;let t=s.result.description.replace(/(※|★|◆|【)/g,"<br>$1");t=t.replace(/(】)/g,"$1<br>"),t=t.replace(new RegExp("(?<=──[^,]*?)(?=,)","g"),"<br>$1"),o.value.description=t,o.value.reviews=s.result.reviews,document.title=`書評網 | ${o.value.title}`}catch(s){console.log(s)}}),(s,t)=>(p(),w(I,null,[e(re,null,{default:l(()=>[e(d,null,{default:l(()=>[e(u,{cols:"12",md:"3",style:{position:"sticky"},top:"0"},{default:l(()=>[e(te,{src:o.value.image},null,8,["src"]),e(u,{class:"d-flex justify-space-between"},{default:l(()=>[e(_,{class:"mt-5",color:"#4d4637",dark:"",href:o.value.buyLink,target:"_blank"},{default:l(()=>[b("購買介面")]),_:1},8,["href"]),e(_,{class:"text-right",icon:P.value?"mdi-heart-minus":"mdi-heart-plus",color:P.value?"red":"blue",onClick:s.addFavorite},null,8,["icon","color","onClick"])]),_:1})]),_:1}),e(u,{cols:"12",md:"9"},{default:l(()=>[r("h1",null,c(o.value.title),1),r("h2",null,c(o.value.authors),1),e(d,null,{default:l(()=>[e(u,{cols:"auto"},{default:l(()=>[pe]),_:1}),e(u,null,{default:l(()=>[r("p",null,c(o.value.publisher),1)]),_:1})]),_:1}),e(d,null,{default:l(()=>[e(u,{cols:"auto"},{default:l(()=>[_e]),_:1}),e(u,null,{default:l(()=>[r("p",null,"$"+c(o.value.retailPrice),1)]),_:1})]),_:1}),e(d,null,{default:l(()=>[e(u,{cols:"auto"},{default:l(()=>[ge]),_:1}),e(u,null,{default:l(()=>[r("p",null,c(o.value.categories),1)]),_:1})]),_:1}),e(d,null,{default:l(()=>[e(u,{cols:"auto"},{default:l(()=>[Ve,y.value?(p(),w("p",{key:0,innerHTML:o.value.description},null,8,be)):(p(),w("p",he,c(o.value.description.substring(0,500)),1))]),_:1}),e(u,{class:"text-center"},{default:l(()=>[o.value.description.length>100?(p(),R(_,{key:0,color:"#4d4637",onClick:t[0]||(t[0]=a=>y.value=!y.value),icon:y.value?"mdi-chevron-up":"mdi-chevron-down"},null,8,["icon"])):ae("",!0)]),_:1})]),_:1}),e(d,null,{default:l(()=>[e(u,{cols:"12"},{default:l(()=>[ke,e(A,{disabled:k.value,onSubmit:T(x($),["prevent"])},{default:l(()=>[e(L,{modelValue:m.value.rating,"onUpdate:modelValue":t[1]||(t[1]=a=>m.value.rating=a),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(F,{modelValue:m.value.comment,"onUpdate:modelValue":t[2]||(t[2]=a=>m.value.comment=a),label:"你的書評",required:""},null,8,["modelValue"]),e(_,{color:"#4d4637",type:"submit",loading:k.value},{default:l(()=>[b("提交")]),_:1},8,["loading"])]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1}),e(d,null,{default:l(()=>[e(u,{cols:"12"},{default:l(()=>[ye,e(de,null,{default:l(()=>[(p(!0),w(I,null,oe(o.value.reviews,a=>(p(),R(ce,{key:a._id},{default:l(()=>[e(U,null,{default:l(()=>[e(d,null,{default:l(()=>[e(u,{cols:"auto"},{default:l(()=>[e(me,{style:{fontSize:"30px"}},{default:l(()=>[b(c(a.user.account),1)]),_:2},1024)]),_:2},1024),e(u,{cols:"auto"},{default:l(()=>[e(D,null,{default:l(()=>[e(L,{modelValue:a.rating,"onUpdate:modelValue":i=>a.rating=i,color:"#4d4637 darken-3",size:"25",readonly:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),e(d,null,{default:l(()=>[e(u,{cols:"auto"},{default:l(()=>[e(fe,{class:"mb-5",style:{fontSize:"20px"}},{default:l(()=>[b(c(a.comment),1)]),_:2},1024)]),_:2},1024),e(u,{class:"d-flex justify-end"},{default:l(()=>[e(D,null,{default:l(()=>[e(_,{icon:"mdi-pencil",color:"#4d4637",onClick:()=>z(a._id)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(ee,{modelValue:V.value,"onUpdate:modelValue":t[6]||(t[6]=a=>V.value=a),"max-width":"290"},{default:l(()=>[e(A,{disabled:k.value,onSubmit:T(x($),["prevent"])},{default:l(()=>[e(U,null,{default:l(()=>[e(se,null,{default:l(()=>[we]),_:1}),e(ue,null,{default:l(()=>[e(L,{modelValue:n.value.rating,"onUpdate:modelValue":t[3]||(t[3]=a=>n.value.rating=a),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(F,{modelValue:n.value.comment,"onUpdate:modelValue":t[4]||(t[4]=a=>n.value.comment=a),label:"你的書評",required:""},null,8,["modelValue"])]),_:1}),e(ne,null,{default:l(()=>[e(_,{color:"#4d4637",onClick:t[5]||(t[5]=a=>x(q)(s.review)),loading:k.value},{default:l(()=>[b("修正")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64))}};export{Re as default};
