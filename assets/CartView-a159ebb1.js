import{U as q,W as $,x as y,o as C,A as I,Z as S,$ as o,af as A,a2 as D,a3 as L,a4 as N,c as a,V as R,a8 as u,ab as d,ae as g,a9 as k,a7 as f}from"./index-b9765595.js";import{V as T}from"./VContainer-8f91ee8f.js";import{V as h}from"./VCol-433e162c.js";import{V as U}from"./VDivider-afab63db.js";import{V as M}from"./VDataTable-b19580de.js";import"./VList-2dca65f5.js";import"./VSelectionControl-d7f38952.js";const W=g("h1",null,"購物車",-1),Z={class:"btn-container"},O={__name:"CartView",setup(j){const{apiAuth:m}=A(),r=q(),b=$(),v=D(),l=y([]),x=[{align:"center",sortable:!1,value:"name"},{title:"書本圖片",key:"book.image"},{title:"書本名稱",key:"book.title",align:"center"},{title:"單價",key:"book.retailPrice",align:"left"},{title:"數量",key:"quantity",align:"center"},{title:"總價",key:"total",value:s=>s.book.retailPrice*s.quantity},{title:"操作",key:"action",align:"center"}],V=C(()=>l.value.reduce((s,n)=>s+n.quantity*n.book.retailPrice,0)),_=async(s,n)=>{var e,t;if(!b.isLogin){v.push("/login");return}try{const{data:c}=await m.patch("/users/cart",{book:s,quantity:n});b.cart=c.result,r({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}});const i=l.value.findIndex(P=>P.book._id===s);l.value[i].quantity+=n,l.value[i].quantity<=0&&l.value.splice(i,1)}catch(c){const i=((t=(e=c==null?void 0:c.response)==null?void 0:e.data)==null?void 0:t.message)||"發生錯誤，請稍後再試";r({text:i,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}},w=C(()=>l.value.length>0),p=y(!1),B=async()=>{var s,n;p.value=!0;try{await m.post("/orders"),b.cart=0,v.push("/orders"),r({text:"結帳成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(e){const t=((n=(s=e==null?void 0:e.response)==null?void 0:s.data)==null?void 0:n.message)||"發生錯誤，請稍後再試";r({text:t,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}p.value=!1};return I(async()=>{var s,n;try{const{data:e}=await m.get("/users/cart");l.value.push(...e.result)}catch(e){const t=((n=(s=e==null?void 0:e.response)==null?void 0:s.data)==null?void 0:n.message)||"發生錯誤，請稍後再試";r({text:t,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),(s,n)=>{const e=L("RouterLink");return N(),S(T,null,{default:o(()=>[a(h,{cols:"12"},{default:o(()=>[W]),_:1}),a(U),a(h,{cols:"12"},{default:o(()=>[a(M,{items:l.value,headers:x},{"item.book.image":o(({item:t})=>[a(e,{to:"/books/"+t.book._id},{default:o(()=>[a(R,{src:t.book.image,alt:"Book Image","max-height":"100","max-width":"60"},null,8,["src"])]),_:2},1032,["to"])]),"item.book.title":o(({item:t})=>[a(e,{class:"no-underline",to:"/books/"+t.book._id},{default:o(()=>[u(d(t.book.title),1)]),_:2},1032,["to"])]),"item.book.retailPrice":o(({item:t})=>[u("$ "+d(t.book.retailPrice),1)]),"item.quantity":o(({item:t})=>[g("div",Z,[a(k,{class:"custom-btn",variant:"text",color:"red",onClick:c=>_(t.book._id,-1)},{default:o(()=>[a(f,{href:"#icon-minus"})]),_:2},1032,["onClick"]),u(d(t.quantity),1),a(k,{class:"custom-btn",variant:"text",color:"green",onClick:c=>_(t.book._id,1)},{default:o(()=>[a(f,{href:"#icon-plus"})]),_:2},1032,["onClick"])])]),"item.action":o(({item:t})=>[a(k,{class:"custom-btn",variant:"text",color:"red",onClick:c=>_(t.book._id,t.quantity*-1)},{default:o(()=>[a(f,{href:"#icon-delete"})]),_:2},1032,["onClick"])]),_:2},1032,["items"])]),_:1}),a(h,{class:"text-center",cols:"12"},{default:o(()=>[g("p",null,"總金額: $ "+d(V.value),1),a(k,{color:"green",disabled:!w.value,loading:p.value,onClick:B},{default:o(()=>[u("結帳")]),_:1},8,["disabled","loading"])]),_:1})]),_:1})}}};export{O as default};
