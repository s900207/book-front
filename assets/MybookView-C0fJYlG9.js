var D=(R,w,c)=>new Promise((P,p)=>{var x=n=>{try{i(c.next(n))}catch($){p($)}},h=n=>{try{i(c.throw(n))}catch($){p($)}},i=n=>n.done?P(n.value):Promise.resolve(n.value).then(x,h);i((c=c.apply(R,w)).next())});import{J as k,r as d,D as T,G as v,a0 as q,E as z,F as E,H as f,a8 as G,a9 as J,aq as X,al as Y,a6 as Z,M as O,ad as Q,ar as W,as as m,Y as ee,Z as te}from"./vue-vendor-CO2Qqhmb.js";import{u as ae,a as se}from"./index-BzE3j7FH.js";/* empty css                   */import"./vendor-oObasS19.js";const H=55,ce={__name:"MybookView",setup(R){const{apiAuth:w}=se(),c=ae(),P=k(),p=d(10),x=d([{key:"createdAt",order:"desc"}]),h=d(1),i=d([]),n=d(null),$=t=>{var a;return((a=t==null?void 0:t.result)==null?void 0:a.image)||(t==null?void 0:t.image)||""},M=t=>{var e;const r=(((e=t==null?void 0:t.result)==null?void 0:e.reviews)||(t==null?void 0:t.reviews)||[]).find(l=>l.user.$oid===c.value||l.user===c.value);return(r==null?void 0:r.rating)||0},N=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"result.title"},{title:"作者",align:"center",sortable:!0,key:"result.authors"},{title:"出版者",align:"center",sortable:!0,key:"result.publisher"},{title:"分類",align:"center",sortable:!0,key:"result.categories"},{title:"評分(1-5)",align:"center",sortable:!0,key:"result.rating"},{title:"書評",align:"center",sortable:!1,key:"result.review",value:t=>{var e;const r=(((e=t==null?void 0:t.result)==null?void 0:e.reviews)||(t==null?void 0:t.reviews)||[]).find(l=>l.user.$oid===c.value||l.user===c.value);if(r){const l=r.comment,o=[];for(let u=0;u<l.length;u+=H)o.push(l.substring(u,u+H));return o.join(`
`)}else return"未提供書評"}}],S=d(!0),I=d(0),V=d(""),K=t=>D(null,null,function*(){if(!(!t||t.length===0))try{console.log("準備清理無效的 favorite 記錄:",t);const a=t.map(r=>w.delete(`/users/favorite/${r}`).catch(e=>(console.warn(`清理 favorite ${r} 失敗:`,e),null)));yield Promise.all(a)}catch(a){console.error("清理 favorite 記錄時發生錯誤:",a)}}),C=()=>D(null,null,function*(){var t,a,r,e;S.value=!0,n.value=null;try{console.log("開始載入使用者喜愛書籍...");const{data:l}=yield w.get("/users/favorite");console.log("獲取 favorite IDs:",l);const o=l.result||l;if(!o||o.length===0){i.value=[],I.value=0;return}console.log(`找到 ${o.length} 本喜愛書籍`);const u=[],L=[];for(const s of o){console.log(`嘗試獲取書籍 ID: ${s}`);const B=[`/books/${s}`,`/book/${s}`,`/books/detail/${s}`,`/api/books/${s}`];let b=null,_=!1;for(const y of B)try{const g=yield w.get(y);console.log(`成功使用端點 ${y}:`,g.data),b=g.data,_=!0;break}catch(g){if(((t=g.response)==null?void 0:t.status)===404){console.log(`書籍 ${s} 不存在 (404)`);continue}console.log(`端點 ${y} 失敗:`,(a=g.response)==null?void 0:a.status)}_&&b?u.push(b):(console.warn(`書籍 ${s} 不存在，加入清理列表`),L.push(s))}console.log(`有效書籍: ${u.length}, 無效書籍: ${L.length}`),L.length>0&&(yield K(L));let A=u;V.value&&(A=u.filter(s=>{var y,g;const B=((y=s==null?void 0:s.result)==null?void 0:y.title)||(s==null?void 0:s.title)||"",b=((g=s==null?void 0:s.result)==null?void 0:g.authors)||(s==null?void 0:s.authors)||"",_=V.value.toLowerCase();return B.toLowerCase().includes(_)||b.toLowerCase().includes(_)}));const F=(h.value-1)*p.value,j=F+p.value;i.value=A.slice(F,j),I.value=A.length,console.log(`最終顯示書籍數量: ${i.value.length}`)}catch(l){console.error("載入失敗:",l);const o=((e=(r=l==null?void 0:l.response)==null?void 0:r.data)==null?void 0:e.message)||"載入喜愛書籍失敗";P({text:o,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"red",location:"bottom"}}),i.value=[],I.value=0}S.value=!1});C();const U=()=>{h.value=1,C()};return(t,a)=>{const r=z("RouterLink");return E(),T(q,null,{default:v(()=>[f(G,null,{default:v(()=>[f(J,{cols:"12"},{default:v(()=>[f(X,{"items-per-page":p.value,"onUpdate:itemsPerPage":[a[2]||(a[2]=e=>p.value=e),C],"sort-by":x.value,"onUpdate:sortBy":[a[3]||(a[3]=e=>x.value=e),C],page:h.value,"onUpdate:page":[a[4]||(a[4]=e=>h.value=e),C],items:i.value,headers:N,loading:S.value,"items-length":I.value,search:V.value,hover:""},{top:v(()=>[f(Q,{label:"搜尋","append-icon":"mdi-magnify",modelValue:V.value,"onUpdate:modelValue":a[0]||(a[0]=e=>V.value=e),"onClick:append":U,onKeydown:W(U,["enter"])},null,8,["modelValue"]),n.value?(E(),T(m,{key:0,class:"mt-2",type:"warning",dismissible:"","onClick:close":a[1]||(a[1]=e=>n.value=null)},{default:v(()=>[ee(te(n.value),1)]),_:1})):O("",!0)]),"item.image":v(({item:e})=>{var l,o,u;return[f(r,{class:"text-primary text-decoration-none",to:"/books/"+(((l=e==null?void 0:e.result)==null?void 0:l._id)||(e==null?void 0:e._id)||((o=e==null?void 0:e.result)==null?void 0:o.id)||(e==null?void 0:e.id)),title:((u=e==null?void 0:e.result)==null?void 0:u.title)||(e==null?void 0:e.title)||""},{default:v(()=>[f(Z,{src:$(e),width:"80",height:"80",cover:""},null,8,["src"])]),_:2},1032,["to","title"])]}),"item.starRating":v(({item:e})=>[f(Y,{value:M(e),readonly:"",color:"#4d4637 darken-3",size:"20"},null,8,["value"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1})}}};export{ce as default};
