import{r as b,J as j,R as q,aj as Z,k as K,L as S,H as t,G as l,a0 as O,ak as ee,Q as D,F as V,a8 as c,a9 as u,a6 as te,ab as U,a1 as w,u as g,Y as y,Z as m,a5 as i,D as R,M as le,ah as T,ai as I,al as L,am as A,T as oe,U as ae,W as se,ac as M,X as ue,an as N,ao as ne,a7 as re,ap as ie}from"./vue-vendor-DZ6ShR-l.js";import{u as de}from"./vendor-fvIX-KvJ.js";import{u as z,a as H}from"./index-Mk3cYYfI.js";function ce(F){const{apiAuth:_}=H(),h=z(),d=b(!1),k=j(),f=q();return{isFavorite:d,checkFavoriteStatus:async()=>{try{const{data:r}=await _.get("/users/favorite",{params:{bookId:F}});d.value=r.result.includes(F)}catch(r){console.error(r),d.value=!1}},addFavorite:async()=>{if(!h.isLogin){f.push("/login");return}d.value=!d.value;try{const{data:r}=await _.post("/users/favorite",{bookId:F,isFavorite:d.value});h.favorite=r.result,k({text:d.value?"已加入我的最愛":"已移除我的最愛",showCloseButton:!1,snackbarProps:{timeout:2e3,color:d.value?"green":"red",location:"bottom"}})}catch(r){console.error(r),r.response&&r.response.status===401?f.push("/login"):k({text:"發生錯誤，請稍後再試",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}}}const me=["innerHTML"],ve={key:1},be={__name:"BookView",setup(F){const _=Z(),h=q(),{api:d,apiAuth:k}=H(),f=b(!1),C=b(!1),v=j(),r=z(),p=b({usersId:"",rating:0,comment:""}),x=b(!1),{handleSubmit:P}=de({initialValues:{usersId:"",rating:0,comment:""}}),s=b({_id:"",image:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",buyLink:"",description:"",reviews:[]}),n=b([]),{isFavorite:B,checkFavoriteStatus:E,addFavorite:G}=ce(_.params.id),J=()=>{x.value=!1},$=P(async a=>{if(console.log(p.value),!r.isLogin){h.push("/login"),v({text:"請先登入",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}});return}try{const{data:e}=await k.post(`/books/${_.params.id}/reviews`,{rating:p.value.rating,conmment:p.value.comment});e&&e.result&&s.value.reviews.push(e.result),v({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(e){console.log(e);const o=e?.response?.data?.message||"發生錯誤，請稍後再試";v({text:o,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),Q=a=>{if(a){const e=s.value.reviews.find(o=>o._id===a);n.value.id=e._id,n.value.rating=e.rating,n.value.comment=e.comment,n.value.bookId=s.value._id,console.log(n.value.bookId)}x.value=!0},W=P(async a=>{try{console.log(n.value),console.log("Form values:",a);const e=new FormData;for(const o in a)e.append(o,n.value[o]||a[o]);x.value===""&&await k.patch(`/books/${n.value.bookId}/reviews/${n.value.id}`,e),console.log("FormData entries:",...e.entries()),v({text:"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(e){console.log(e);const o=e?.response?.data?.message||"發生錯誤，請稍後再試";v({text:o,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}J()});console.log(n.value),K(async()=>{try{const{data:a}=await d.get(`/books/${_.params.id}`);s.value._id=a.result._id,s.value.image=a.result.image,s.value.title=a.result.title,s.value.authors=a.result.authors,s.value.publisher=a.result.publisher,s.value.retailPrice=a.result.retailPrice,s.value.categories=a.result.categories,s.value.buyLink=a.result.buyLink;let e=a.result.description.replace(/(※|★|◆|✓|●|▓|▌|￭|──|【)/g,"<br>$1");e=e.replace(/(】)/g,"$1<br>"),e=e.replace(new RegExp("(?<=──[^,]*?)(?=,)","g"),"<br>$1"),s.value.description=e,s.value.reviews=a.result.reviews,document.title=`書評網 | ${s.value.title}`,await E()}catch(a){console.log(a)}});const X=async()=>{if(!r.isLogin){h.push("/login");return}try{const{data:a}=await k.patch("/users/cart",{book:s.value._id,quantity:1});r.cart=a.result,v({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(a){const e=a?.response?.data?.message||"發生錯誤，請稍後再試";v({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}};return(a,e)=>(V(),S(D,null,[t(O,null,{default:l(()=>[t(c,null,{default:l(()=>[t(u,{cols:"12",md:"3",style:{position:"sticky"},top:"0"},{default:l(()=>[t(te,{src:s.value.image},null,8,["src"]),t(U,null,{default:l(()=>[t(c,{class:"justify-center align-center"},{default:l(()=>[t(u,{cols:"6"},{default:l(()=>[t(w,{"prepend-icon":g(B)?"mdi-heart-minus":"mdi-heart-plus",color:g(B)?"red":"blue",onClick:g(G)},{default:l(()=>[y(m(g(B)?"取消最愛":"加入最愛"),1)]),_:1},8,["prepend-icon","color","onClick"])]),_:1}),t(u,{cols:"6"},{default:l(()=>[t(w,{color:"primary","prepend-icon":"mdi-cart",onClick:X},{default:l(()=>e[7]||(e[7]=[y("加入購物車",-1)])),_:1,__:[7]})]),_:1})]),_:1})]),_:1})]),_:1}),t(u,{cols:"12",md:"9"},{default:l(()=>[i("h1",null,m(s.value.title),1),i("h2",null,m(s.value.authors),1),t(c,null,{default:l(()=>[t(u,{cols:"auto"},{default:l(()=>e[8]||(e[8]=[i("h3",null,"出版者:",-1)])),_:1,__:[8]}),t(u,null,{default:l(()=>[i("p",null,m(s.value.publisher),1)]),_:1})]),_:1}),t(c,null,{default:l(()=>[t(u,{cols:"auto"},{default:l(()=>e[9]||(e[9]=[i("h3",null,"價格:",-1)])),_:1,__:[9]}),t(u,null,{default:l(()=>[i("p",null,"$"+m(s.value.retailPrice),1)]),_:1})]),_:1}),t(c,null,{default:l(()=>[t(u,{cols:"auto"},{default:l(()=>e[10]||(e[10]=[i("h3",null,"分類:",-1)])),_:1,__:[10]}),t(u,null,{default:l(()=>[i("p",null,m(s.value.categories),1)]),_:1})]),_:1}),t(c,null,{default:l(()=>[t(u,{cols:"auto"},{default:l(()=>[e[11]||(e[11]=i("h3",null,"簡介:",-1)),C.value?(V(),S("p",{key:0,innerHTML:s.value.description},null,8,me)):(V(),S("p",ve,m(s.value.description.substring(0,500)),1))]),_:1,__:[11]}),t(u,{class:"text-center"},{default:l(()=>[s.value.description.length>100?(V(),R(w,{key:0,color:"#4d4637",onClick:e[0]||(e[0]=o=>C.value=!C.value),icon:C.value?"mdi-chevron-up":"mdi-chevron-down"},null,8,["icon"])):le("",!0)]),_:1})]),_:1}),t(c,null,{default:l(()=>[t(u,{cols:"12"},{default:l(()=>[e[13]||(e[13]=i("h3",null,"新增書評:",-1)),t(T,{disabled:f.value,onSubmit:I(g($),["prevent"])},{default:l(()=>[t(L,{modelValue:p.value.rating,"onUpdate:modelValue":e[1]||(e[1]=o=>p.value.rating=o),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),t(A,{modelValue:p.value.comment,"onUpdate:modelValue":e[2]||(e[2]=o=>p.value.comment=o),label:"你的書評",required:""},null,8,["modelValue"]),t(w,{color:"#4d4637",type:"submit",loading:f.value},{default:l(()=>e[12]||(e[12]=[y("提交",-1)])),_:1,__:[12]},8,["loading"])]),_:1},8,["disabled","onSubmit"])]),_:1,__:[13]})]),_:1}),t(c,null,{default:l(()=>[t(u,{cols:"12"},{default:l(()=>[e[14]||(e[14]=i("h3",null,"書評:",-1)),t(oe,null,{default:l(()=>[(V(!0),S(D,null,ae(s.value.reviews,o=>(V(),R(se,{key:o._id},{default:l(()=>[t(M,null,{default:l(()=>[t(c,null,{default:l(()=>[t(u,{cols:"auto"},{default:l(()=>[t(ue,{style:{fontSize:"30px"}},{default:l(()=>[y(m(o.user.account),1)]),_:2},1024)]),_:2},1024),t(u,{cols:"auto"},{default:l(()=>[t(N,null,{default:l(()=>[t(L,{modelValue:o.rating,"onUpdate:modelValue":Y=>o.rating=Y,color:"#4d4637 darken-3",size:"25",readonly:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),t(c,null,{default:l(()=>[t(u,{cols:"auto"},{default:l(()=>[t(ne,{class:"mb-5",style:{fontSize:"20px"}},{default:l(()=>[y(m(o.comment),1)]),_:2},1024)]),_:2},1024),t(u,{class:"d-flex justify-end"},{default:l(()=>[t(N,null,{default:l(()=>[t(w,{icon:"mdi-pencil",color:"#4d4637",onClick:()=>Q(o._id)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1,__:[14]})]),_:1})]),_:1})]),_:1})]),_:1}),t(ee,{modelValue:x.value,"onUpdate:modelValue":e[6]||(e[6]=o=>x.value=o),"max-width":"290"},{default:l(()=>[t(T,{disabled:f.value,onSubmit:I(g($),["prevent"])},{default:l(()=>[t(M,null,{default:l(()=>[t(re,null,{default:l(()=>e[15]||(e[15]=[i("h3",null,"編輯書評",-1)])),_:1,__:[15]}),t(ie,null,{default:l(()=>[t(L,{modelValue:n.value.rating,"onUpdate:modelValue":e[3]||(e[3]=o=>n.value.rating=o),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),t(A,{modelValue:n.value.comment,"onUpdate:modelValue":e[4]||(e[4]=o=>n.value.comment=o),label:"你的書評",required:""},null,8,["modelValue"])]),_:1}),t(U,null,{default:l(()=>[t(w,{color:"#4d4637",onClick:e[5]||(e[5]=o=>g(W)(a.review)),loading:f.value},{default:l(()=>e[16]||(e[16]=[y("修正",-1)])),_:1,__:[16]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64))}};export{be as default};
