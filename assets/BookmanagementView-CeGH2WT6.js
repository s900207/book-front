import{y as ue,e as $,t as y,j as t,m as W,l as f,F as J,p as ie,b as i,a1 as U,a2 as r,a3 as F,a6 as V,ag as de,u as R,a8 as me,Z as ce}from"./vue-vendor-DIljl67C.js";import{_ as pe,s as ve,w as ge,i as L,V as M,I as C,J as fe,H as j,E as Z,N as Q,W as be,r as z,G as ye,v as Ve}from"./index-C9KdP_uT.js";import{j as ke,A as Pe,B as he,C as xe}from"./icons-C5frdmYn.js";import{V as we}from"./VContainer-CZYKgrN-.js";import{V as X}from"./VRow-9HzZIeh6.js";import{V as q}from"./VCol-BpxVe32F.js";import{c as Ce,a as De,b as Se,d as Be,u as Te,p as _e,e as Ie,f as Ue,g as Fe,h as Re,i as Le,j as je,k as Y,l as ee,m as ae,n as te,o as qe,q as Ae,r as Ee}from"./VDataTable-BxMvOZOz.js";import{g as He,p as Ne,l as Ge,f as Oe}from"./vuetify-vendor-BSJ2BONf.js";import{V as $e}from"./VDivider-Dc-frIgM.js";import{V as ze}from"./VForm-BRoSrFSW.js";import{V as Ke}from"./VAlert-ClVGeT2G.js";import{V as We}from"./VTextarea-PdDthxyk.js";import"./VList-CBNFvD2Q.js";import"./VChip-CHg4v0d5.js";import"./VSelectionControl-BR7s8xUQ.js";const Je=Ne({itemsLength:{type:[Number,String],required:!0},...Ee(),...Ae(),...qe()},"VDataTableServer"),Me=He()({name:"VDataTableServer",props:Je(),emits:{"update:modelValue":l=>!0,"update:page":l=>!0,"update:itemsPerPage":l=>!0,"update:sortBy":l=>!0,"update:options":l=>!0,"update:expanded":l=>!0,"update:groupBy":l=>!0},setup(l,k){let{attrs:b,slots:n}=k;const{groupBy:c}=Ce(l),{sortBy:d,multiSort:D,mustSort:A}=De(l),{page:g,itemsPerPage:P}=Se(l),{disableSort:h}=ue(l),x=$(()=>parseInt(l.itemsLength,10)),{columns:o,headers:p}=Be(l,{groupBy:c,showSelect:y(()=>l.showSelect),showExpand:y(()=>l.showExpand)}),{items:u}=Te(l,o),{toggleSort:w}=_e({sortBy:d,multiSort:D,mustSort:A,page:g}),{opened:S,isGroupOpen:B,toggleGroup:E,extractRows:v}=Ie({groupBy:c,sortBy:d,disableSort:h}),{pageCount:H,setItemsPerPage:T}=Ue({page:g,itemsPerPage:P,itemsLength:x}),{flatItems:_}=Fe(u,c,S),{isSelected:I,select:N,selectAll:a,toggleSelect:e,someSelected:s,allSelected:G}=Re(l,{allItems:u,currentPage:u}),{isExpanded:le,toggleExpand:oe}=Le(l),K=$(()=>v(u.value));je({page:g,itemsPerPage:P,sortBy:d,groupBy:c,search:y(()=>l.search)}),ie("v-data-table",{toggleSort:w,sortBy:d}),Ge({VDataTableRows:{hideNoData:y(()=>l.hideNoData),noDataText:y(()=>l.noDataText),loading:y(()=>l.loading),loadingText:y(()=>l.loadingText)}});const m=$(()=>({page:g.value,itemsPerPage:P.value,sortBy:d.value,pageCount:H.value,toggleSort:w,setItemsPerPage:T,someSelected:s.value,allSelected:G.value,isSelected:I,select:N,selectAll:a,toggleSelect:e,isExpanded:le,toggleExpand:oe,isGroupOpen:B,toggleGroup:E,items:K.value.map(O=>O.raw),internalItems:K.value,groupedItems:_.value,columns:o.value,headers:p.value}));Oe(()=>{const O=Y.filterProps(l),se=ee.filterProps(l),re=ae.filterProps(l),ne=te.filterProps(l);return t(te,W({class:["v-data-table",{"v-data-table--loading":l.loading},l.class],style:l.style},ne,{fixedHeader:l.fixedHeader||l.sticky}),{top:()=>n.top?.(m.value),default:()=>n.default?n.default(m.value):f(J,null,[n.colgroup?.(m.value),!l.hideDefaultHeader&&f("thead",{key:"thead",class:"v-data-table__thead",role:"rowgroup"},[t(ee,se,n)]),n.thead?.(m.value),!l.hideDefaultBody&&f("tbody",{class:"v-data-table__tbody",role:"rowgroup"},[n["body.prepend"]?.(m.value),n.body?n.body(m.value):t(ae,W(b,re,{items:_.value}),n),n["body.append"]?.(m.value)]),n.tbody?.(m.value),n.tfoot?.(m.value)]),bottom:()=>n.bottom?n.bottom(m.value):!l.hideDefaultFooter&&f(J,null,[t($e,null,null),t(Y,O,{prepend:n["footer.prepend"]})])})})}}),Ze={class:"text-center"},Qe={__name:"BookmanagementView",setup(l){const{apiAuth:k}=ge(),b=ve(),n=i(10),c=i([{key:"createdAt",order:"desc"}]),d=i(1),D=i([]),A=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"title"},{title:"作者",align:"center",sortable:!0,key:"authors"},{title:"出版者",align:"center",sortable:!0,key:"publisher"},{title:"價格",align:"center",sortable:!0,key:"retailPrice"},{title:"分類",align:"center",sortable:!0,key:"categories"},{title:"編輯",align:"center",sortable:!1,key:"edit"},{title:"刪除",align:"center",sortable:!1,key:"delete"}],g=i(!0),P=i(0),h=i(""),x=i(!1),o=i({_id:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",description:"",image:""}),p=i(null),u=i(""),w=i(!1),S=()=>u.value?u.value:o.value.image||"",B=()=>{const a=document.querySelector('input[type="file"]');a&&a.click()},E=a=>{const e=a.target.files[0];e&&(p.value=e,u.value&&URL.revokeObjectURL(u.value),u.value=URL.createObjectURL(e))},v=async()=>{g.value=!0;try{const{data:a}=await k.get("/books/all",{params:{page:d.value,itemsPerPage:n.value,sortBy:c.value[0]?.key||"createdAt",sortOrder:c.value[0]?.order==="asc"?1:-1,search:h.value}});D.value.splice(0,D.value.length,...a.result.data),P.value=a.result.total}catch(a){console.log(a);const e=a?.response?.data?.message||"發生錯誤，請稍後再試";b({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}g.value=!1};v();const H=async a=>{if(console.log(a),!a._id){console.error("沒有書籍 ID");return}try{await k.delete(`/books/${a._id}`),b({text:"書籍已成功刪除",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),v()}catch(e){console.log(e);const s=e?.response?.data?.message||"刪除書籍時發生錯誤，請稍後再試";b({text:s,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}},T=()=>{d.value=1,v()},_=a=>{o.value={...a,image:a.image||""},x.value=!0,p.value=null,u.value=""},I=()=>{x.value=!1,p.value=null,u.value&&(URL.revokeObjectURL(u.value),u.value="");const a=document.querySelector('input[type="file"]');a&&(a.value="")},N=async()=>{w.value=!0;try{if(p.value){const a=new FormData;a.append("image",p.value),a.append("title",o.value.title),a.append("authors",o.value.authors),a.append("publisher",o.value.publisher),a.append("retailPrice",o.value.retailPrice),a.append("categories",o.value.categories),a.append("description",o.value.description),await k.patch(`/books/${o.value._id}`,a,{headers:{"Content-Type":"multipart/form-data"}})}else{const a={title:o.value.title,authors:o.value.authors,publisher:o.value.publisher,retailPrice:parseFloat(o.value.retailPrice)||0,categories:o.value.categories,description:o.value.description};await k.patch(`/books/${o.value._id}`,a)}b({text:"書籍已成功更新",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),v(),I()}catch(a){console.error("更新書籍失敗:",a);let e="更新書籍時發生錯誤，請稍後再試";a?.response?.status===404?e="找不到書籍":a?.response?.status===400?e=a?.response?.data?.message||"ID 格式錯誤":a?.response?.data?.message&&(e=a.response.data.message),b({text:e,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"red",location:"bottom"}})}w.value=!1};return(a,e)=>(F(),U(we,null,{default:r(()=>[t(X,null,{default:r(()=>[t(q,{cols:"12"},{default:r(()=>[t(Me,{"items-per-page":n.value,"onUpdate:itemsPerPage":[e[1]||(e[1]=s=>n.value=s),v],"sort-by":c.value,"onUpdate:sortBy":[e[2]||(e[2]=s=>c.value=s),v],page:d.value,"onUpdate:page":[e[3]||(e[3]=s=>d.value=s),v],items:D.value,headers:A,loading:g.value,"items-length":P.value,search:h.value,hover:""},{top:r(()=>[t(C,{class:"mr-3",label:"搜尋","append-icon":R(ke),modelValue:h.value,"onUpdate:modelValue":e[0]||(e[0]=s=>h.value=s),"onClick:append":T,onKeydown:de(T,["enter"])},null,8,["append-icon","modelValue"])]),"item.image":r(({item:s})=>[t(M,{src:s.image,width:"80",height:"80",cover:""},null,8,["src"])]),"item.edit":r(({item:s})=>[t(L,{onClick:G=>_(s)},{default:r(()=>e[11]||(e[11]=[V("編輯",-1)])),_:2,__:[11]},1032,["onClick"])]),"item.delete":r(({item:s})=>[t(L,{onClick:G=>H(s)},{default:r(()=>e[12]||(e[12]=[V("刪除",-1)])),_:2,__:[12]},1032,["onClick"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"]),t(fe,{modelValue:x.value,"onUpdate:modelValue":e[10]||(e[10]=s=>x.value=s),persistent:"","max-width":"700px"},{default:r(()=>[t(j,null,{default:r(()=>[t(Z,null,{default:r(()=>e[13]||(e[13]=[V("編輯書籍",-1)])),_:1,__:[13]}),t(Q,null,{default:r(()=>[t(ze,{ref:"editForm"},{default:r(()=>[t(X,null,{default:r(()=>[t(q,{cols:"12",md:"6"},{default:r(()=>[t(C,{modelValue:o.value.title,"onUpdate:modelValue":e[4]||(e[4]=s=>o.value.title=s),label:"書名",required:""},null,8,["modelValue"]),t(C,{modelValue:o.value.authors,"onUpdate:modelValue":e[5]||(e[5]=s=>o.value.authors=s),label:"作者",required:""},null,8,["modelValue"]),t(C,{modelValue:o.value.publisher,"onUpdate:modelValue":e[6]||(e[6]=s=>o.value.publisher=s),label:"出版者",required:""},null,8,["modelValue"]),t(C,{modelValue:o.value.retailPrice,"onUpdate:modelValue":e[7]||(e[7]=s=>o.value.retailPrice=s),label:"價格",required:"",type:"number"},null,8,["modelValue"]),t(C,{modelValue:o.value.categories,"onUpdate:modelValue":e[8]||(e[8]=s=>o.value.categories=s),label:"分類",required:""},null,8,["modelValue"])]),_:1}),t(q,{cols:"12",md:"6"},{default:r(()=>[t(j,{outlined:""},{default:r(()=>[t(Z,null,{default:r(()=>e[14]||(e[14]=[V("書籍圖片",-1)])),_:1,__:[14]}),t(Q,null,{default:r(()=>[S()?(F(),U(j,{key:0,class:"image-upload-area mb-3 d-flex align-center justify-center",onClick:B,hover:""},{default:r(()=>[t(M,{class:"mx-auto",src:S(),"max-height":"200","max-width":"100%",contain:""},null,8,["src"]),t(be,{class:"align-center justify-center hover-overlay","model-value":!1,style:{position:"absolute",top:"0",left:"0",right:"0",bottom:"0",background:"rgba(0,0,0,0.5)",opacity:"0",transition:"opacity 0.3s"}},{default:r(()=>[t(z,{color:"white",size:"48",icon:R(Pe)},null,8,["icon"]),e[15]||(e[15]=f("div",{style:{color:"white","margin-top":"8px"}},"點擊更換圖片",-1))]),_:1,__:[15]})]),_:1})):(F(),U(j,{key:1,class:"image-upload-area mb-3 d-flex align-center justify-center",onClick:B,hover:""},{default:r(()=>[f("div",Ze,[t(z,{size:"64",color:"grey",icon:R(he)},null,8,["icon"]),e[16]||(e[16]=f("div",{class:"mt-2 text-grey"},"點擊上傳圖片",-1))])]),_:1})),f("input",{ref:"fileInput",type:"file",accept:"image/*",style:{display:"none"},onChange:E},null,544),p.value?(F(),U(Ke,{key:2,class:"mt-3",type:"info",variant:"tonal"},{default:r(()=>[t(z,{class:"mr-2",icon:R(xe)},null,8,["icon"]),V("已選擇: "+ce(p.value.name),1)]),_:1})):me("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),t(q,{cols:"12"},{default:r(()=>[t(We,{modelValue:o.value.description,"onUpdate:modelValue":e[9]||(e[9]=s=>o.value.description=s),label:"簡介",rows:"5"},null,8,["modelValue"])]),_:1})]),_:1},512)]),_:1}),t(ye,null,{default:r(()=>[t(Ve),t(L,{color:"blue darken-1",variant:"text",onClick:I},{default:r(()=>e[17]||(e[17]=[V("取消",-1)])),_:1,__:[17]}),t(L,{color:"blue darken-1",variant:"text",onClick:N,loading:w.value},{default:r(()=>e[18]||(e[18]=[V("保存",-1)])),_:1,__:[18]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}))}},pa=pe(Qe,[["__scopeId","data-v-29ab0f8b"]]);export{pa as default};
