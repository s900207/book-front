import{p as G,m as J,a as K,g as O,u as Q,c as e,W as M,x as h,U as q,a2 as N,af as j,A as X,Y as L,$ as t,ay as ee,a1 as I,az as te,a4 as w,V as ae,ar as U,a9 as C,a6 as k,a7 as F,ae as n,ab as f,ax as R,a8 as S,a5 as le,as as T,ap as oe,aA as se,Z as ue}from"./index-8e783504.js";import{u as ne}from"./vee-validate.esm-cd90b517.js";import{V as re}from"./VContainer-c9ccb8f1.js";import{V as m}from"./VRow-bbea9b98.js";import{V as u}from"./VCol-84ea66a4.js";import{V as z}from"./VForm-850a0232.js";import{V as P}from"./VRating-51b0b756.js";import{V as D}from"./VTextarea-610f8039.js";import{b as ie,V as de,a as ce,c as me}from"./VList-19d4c244.js";import"./VDivider-4e3b1cd2.js";const fe=G({start:Boolean,end:Boolean,...J(),...K()},"VListItemAction"),pe=O()({name:"VListItemAction",props:fe(),setup(d,p){let{slots:v}=p;return Q(()=>e(d.tag,{class:["v-list-item-action",{"v-list-item-action--start":d.start,"v-list-item-action--end":d.end},d.class],style:d.style},v)),{}}});function ve(d){const{apiAuth:p}=j(),v=M(),c=h(!1),y=q(),_=N();return{isFavorite:c,checkFavoriteStatus:async()=>{try{const{data:r}=await p.get("/users/favorite",{params:{bookId:d}});c.value=r.result.includes(d)}catch(r){console.error(r),c.value=!1}},addFavorite:async()=>{if(!v.isLogin){_.push("/login");return}c.value=!c.value;try{const{data:r}=await p.post("/users/favorite",{bookId:d,isFavorite:c.value});v.favorite=r.result,y({text:c.value?"已加入我的最愛":"已移除我的最愛",showCloseButton:!1,snackbarProps:{timeout:2e3,color:c.value?"green":"red",location:"bottom"}})}catch(r){console.error(r),r.response&&r.response.status===401?_.push("/login"):y({text:"發生錯誤，請稍後再試",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}}}const _e=n("span",null,"加入購物車",-1),ge=n("h3",null,"出版者:",-1),he=n("h3",null,"價格:",-1),Ve=n("h3",null,"分類:",-1),be=n("h3",null,"簡介:",-1),ke=["innerHTML"],ye={key:1},we=n("h3",null,"新增書評:",-1),Ce=n("h3",null,"書評:",-1),xe=n("h3",null,"編輯書評",-1),Te={__name:"BookView",setup(d){const p=te(),v=N(),{api:c,apiAuth:y}=j(),_=h(!1),V=h(!1),b=q(),r=M(),g=h({usersId:"",rating:0,comment:""}),A=h(!1),{handleSubmit:H}=ne({initialValues:{usersId:"",rating:0,comment:""}}),o=h({_id:"",image:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",buyLink:"",description:"",reviews:[]}),x=h([]),{isFavorite:B,checkFavoriteStatus:E,addFavorite:W}=ve(p.params.id),$=H(async s=>{var a,l;if(console.log(g.value),!r.isLogin){v.push("/login"),b({text:"請先登入",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}});return}try{const{data:i}=await y.post(`/books/${p.params.id}/reviews`,{rating:g.value.rating,conmment:g.value.comment});i&&i.result&&o.value.reviews.push(i.result),b({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(i){console.log(i);const Z=((l=(a=i==null?void 0:i.response)==null?void 0:a.data)==null?void 0:l.message)||"發生錯誤，請稍後再試";b({text:Z,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}});X(async()=>{try{const{data:s}=await c.get(`/books/${p.params.id}`);o.value._id=s.result._id,o.value.image=s.result.image,o.value.title=s.result.title,o.value.authors=s.result.authors,o.value.publisher=s.result.publisher,o.value.retailPrice=s.result.retailPrice,o.value.categories=s.result.categories,o.value.buyLink=s.result.buyLink;let a=s.result.description.replace(/(※|★|◆|✓|●|▓|▌|￭|──|【)/g,"<br>$1");a=a.replace(/(】)/g,"$1<br>"),a=a.replace(new RegExp("(?<=──[^,]*?)(?=,)","g"),"<br>$1"),o.value.description=a,o.value.reviews=s.result.reviews,document.title=`書評網 | ${o.value.title}`,await E()}catch(s){console.log(s)}});const Y=async()=>{var s,a;if(!r.isLogin){v.push("/login");return}try{const{data:l}=await y.patch("/users/cart",{book:o.value._id,quantity:1});r.cart=l.result,b({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(l){const i=((a=(s=l==null?void 0:l.response)==null?void 0:s.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";b({text:i,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}};return(s,a)=>(w(),L(I,null,[e(re,null,{default:t(()=>[e(m,null,{default:t(()=>[e(u,{cols:"12",md:"3",style:{position:"sticky"},top:"0"},{default:t(()=>[e(ae,{src:o.value.image},null,8,["src"]),e(U,null,{default:t(()=>[e(m,{class:"justify-center align-center"},{default:t(()=>[e(u,{cols:"6"},{default:t(()=>[e(C,{color:k(B)?"red":"blue",onClick:k(W)},{prepend:t(()=>[e(F,{href:k(B)?"#icon-heart-minus":"#icon-heart-plus"},null,8,["href"])]),default:t(()=>[n("span",null,f(k(B)?"取消最愛":"加入最愛"),1)]),_:1},8,["color","onClick"])]),_:1}),e(u,{cols:"6"},{default:t(()=>[e(C,{onClick:Y,color:"primary"},{prepend:t(()=>[e(F,{href:"#icon-cart"})]),default:t(()=>[_e]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(u,{cols:"12",md:"9"},{default:t(()=>[n("h1",null,f(o.value.title),1),n("h2",null,f(o.value.authors),1),e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[ge]),_:1}),e(u,null,{default:t(()=>[n("p",null,f(o.value.publisher),1)]),_:1})]),_:1}),e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[he]),_:1}),e(u,null,{default:t(()=>[n("p",null,"$"+f(o.value.retailPrice),1)]),_:1})]),_:1}),e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[Ve]),_:1}),e(u,null,{default:t(()=>[n("p",null,f(o.value.categories),1)]),_:1})]),_:1}),e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[be,V.value?(w(),L("p",{key:0,innerHTML:o.value.description},null,8,ke)):(w(),L("p",ye,f(o.value.description.substring(0,500)),1))]),_:1}),e(u,{class:"text-center"},{default:t(()=>[e(C,{color:(V.value,"#4d4637"),onClick:a[0]||(a[0]=l=>V.value=!V.value),icon:"",rounded:""},{default:t(()=>[n("template",null,[e(F,{href:V.value?"#icon-chevron-up":"#icon-chevron-down"},null,8,["href"])])]),_:1},8,["color"])]),_:1})]),_:1}),e(m,null,{default:t(()=>[e(u,{cols:"12"},{default:t(()=>[we,e(z,{disabled:_.value,onSubmit:R(k($),["prevent"])},{default:t(()=>[e(P,{modelValue:g.value.rating,"onUpdate:modelValue":a[1]||(a[1]=l=>g.value.rating=l),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(D,{modelValue:g.value.comment,"onUpdate:modelValue":a[2]||(a[2]=l=>g.value.comment=l),label:"你的書評",required:""},null,8,["modelValue"]),e(C,{color:"#4d4637",type:"submit",loading:_.value},{default:t(()=>[S("提交")]),_:1},8,["loading"])]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1}),e(m,null,{default:t(()=>[e(u,{cols:"12"},{default:t(()=>[Ce,e(ie,null,{default:t(()=>[(w(!0),L(I,null,le(o.value.reviews,l=>(w(),ue(de,{key:l._id},{default:t(()=>[e(T,null,{default:t(()=>[e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[e(ce,{style:{fontSize:"30px"}},{default:t(()=>[S(f(l.user.account),1)]),_:2},1024)]),_:2},1024),e(u,{cols:"auto"},{default:t(()=>[e(pe,null,{default:t(()=>[e(P,{modelValue:l.rating,"onUpdate:modelValue":i=>l.rating=i,color:"#4d4637 darken-3",size:"25",readonly:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[e(me,{class:"mb-5",style:{fontSize:"20px"}},{default:t(()=>[S(f(l.comment),1)]),_:2},1024)]),_:2},1024),e(u,{class:"d-flex justify-end"})]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(ee,{modelValue:A.value,"onUpdate:modelValue":a[6]||(a[6]=l=>A.value=l),"max-width":"290"},{default:t(()=>[e(z,{disabled:_.value,onSubmit:R(k($),["prevent"])},{default:t(()=>[e(T,null,{default:t(()=>[e(oe,null,{default:t(()=>[xe]),_:1}),e(se,null,{default:t(()=>[e(P,{modelValue:x.value.rating,"onUpdate:modelValue":a[3]||(a[3]=l=>x.value.rating=l),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(D,{modelValue:x.value.comment,"onUpdate:modelValue":a[4]||(a[4]=l=>x.value.comment=l),label:"你的書評",required:""},null,8,["modelValue"])]),_:1}),e(U,null,{default:t(()=>[e(C,{color:"#4d4637",onClick:a[5]||(a[5]=l=>s.editReviews(s.review)),loading:_.value},{default:t(()=>[S("修正")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64))}};export{Te as default};
