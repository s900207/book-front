import{e as F,l as x,m as Q,n as W,b as u,H as ee,a1 as A,a2 as i,aa as te,a3 as $,j as h,Z as D,a8 as ae,ag as se,u as re,a6 as le}from"./vue-vendor-DIljl67C.js";import{u as oe,n as ne,e as ie,b as ue,o as ce,_ as de,t as me,w as ve,V as ge,I as pe}from"./index-BAJis5Xm.js";import{j as fe}from"./icons-C5frdmYn.js";import{V as he}from"./VContainer-DDBVd8n7.js";import{V as be}from"./VRow-BqdxVVPV.js";import{V as ye}from"./VCol-BxmQ6D7W.js";import{V as we}from"./VDataTable-CQzIEx72.js";import{V as ke}from"./VRating-CeCibkGZ.js";import{g as _e,p as Ve,d as Ce,R as xe,E as Be,f as Pe,m as Re}from"./vuetify-vendor-BSJ2BONf.js";import{V as Se}from"./VAlert-CNzXzZDI.js";import"./VList-wBiDWP7Z.js";import"./VDivider-D2CwA7uV.js";import"./VChip-EoRlyKul.js";import"./VSelectionControl-DPda20hP.js";const Le={actions:"button@2",article:"heading, paragraph",avatar:"avatar",button:"button",card:"image, heading","card-avatar":"image, list-item-avatar",chip:"chip","date-picker":"list-item, heading, divider, date-picker-options, date-picker-days, actions","date-picker-options":"text, avatar@2","date-picker-days":"avatar@28",divider:"divider",heading:"heading",image:"image","list-item":"text","list-item-avatar":"avatar, text","list-item-two-line":"sentences","list-item-avatar-two-line":"avatar, sentences","list-item-three-line":"paragraph","list-item-avatar-three-line":"avatar, paragraph",ossein:"ossein",paragraph:"text@3",sentences:"text@2",subtitle:"text",table:"table-heading, table-thead, table-tbody, table-tfoot","table-heading":"chip, text","table-thead":"heading@6","table-tbody":"table-row-divider@6","table-row-divider":"table-row, divider","table-row":"text@6","table-tfoot":"text@2, avatar@2",text:"text"};function Te(s){let o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];return x("div",{class:W(["v-skeleton-loader__bone",`v-skeleton-loader__${s}`])},[o])}function U(s){const[o,l]=s.split("@");return Array.from({length:l}).map(()=>B(o))}function B(s){let o=[];if(!s)return o;const l=Le[s];if(s!==l){if(s.includes(","))return E(s);if(s.includes("@"))return U(s);l.includes(",")?o=E(l):l.includes("@")?o=U(l):l&&o.push(B(l))}return[Te(s,o)]}function E(s){return s.replace(/\s/g,"").split(",").map(B)}const Ae=Ve({boilerplate:Boolean,color:String,loading:Boolean,loadingText:{type:String,default:"$vuetify.loading"},type:{type:[String,Array],default:"ossein"},...ce(),...ue(),...Re()},"VSkeletonLoader"),$e=_e()({name:"VSkeletonLoader",props:Ae(),setup(s,o){let{slots:l}=o;const{backgroundColorClasses:c,backgroundColorStyles:b}=oe(()=>s.color),{dimensionStyles:V}=ne(s),{elevationClasses:d}=ie(s),{themeClasses:y}=Ce(s),{t:m}=xe(),v=F(()=>B(Be(s.type).join(",")));return Pe(()=>{const g=!l.default||s.loading,p=s.boilerplate||!g?{}:{ariaLive:"polite",ariaLabel:m(s.loadingText),role:"alert"};return x("div",Q({class:["v-skeleton-loader",{"v-skeleton-loader--boilerplate":s.boilerplate},y.value,c.value,d.value],style:[b.value,g?V.value:{}]},p),[g?v.value:l.default?.()])}),{}}}),De={class:"text-left pa-2",style:{"max-width":"300px"}},Ue={class:"text-body-2 mb-0"},M=100,S=3,j=100,Ee={__name:"MybookView",setup(s,{expose:o}){const{apiAuth:l}=ve(),c=me(),b=u(10),V=u([{key:"createdAt",order:"desc"}]),d=u(1),y=u([]),m=u([]),v=u(null),g=u(!1),p=u(""),k=new Map,P=u(!1),H=F(()=>p.value?L().length:m.value.length),N=a=>a?.result?.image||a?.image||"/placeholder-book.jpg",z=a=>(a?.result?.reviews||a?.reviews||[]).find(e=>e.user?._id===c._id||e.user?.$oid===c._id||e.user===c._id)?.rating||0,K=a=>{const r=(a?.result?.reviews||a?.reviews||[]).find(e=>e.user?._id===c._id||e.user?.$oid===c._id||e.user===c._id);if(r?.comment){const e=r.comment.toString();return e.length>M?e.substring(0,M)+"...":e}return"尚未撰寫書評"},Y=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"result.title"},{title:"作者",align:"center",sortable:!0,key:"result.authors"},{title:"出版者",align:"center",sortable:!0,key:"result.publisher"},{title:"分類",align:"center",sortable:!0,key:"result.categories"},{title:"我的評分",align:"center",sortable:!1,key:"starRating"},{title:"我的書評",align:"center",sortable:!1,key:"userReview"}],Z=async(a,t=2)=>{if(k.has(a))return k.get(a);let r=null;for(let e=0;e<=t;e++)try{const f=(await l.get(`/books/${a}`)).data;return k.set(a,f),f}catch(w){if(r=w,w.response?.status===404)return k.set(a,null),null;e<t&&await new Promise(f=>setTimeout(f,j*(e+1)))}return console.warn(`獲取書籍 ${a} 失敗 (已重試 ${t} 次):`,r),k.set(a,null),null},X=async a=>{const t=[],r=[];try{for(let e=0;e<a.length;e+=S){const f=a.slice(e,e+S).map(async n=>{try{const C=await Z(n);return{bookId:n,book:C,valid:C!==null}}catch(C){return console.warn(`批次處理書籍 ${n} 失敗:`,C),{bookId:n,book:null,valid:!1}}}),O=await Promise.all(f);for(const n of O)n.valid&&n.book?t.push(n.book):r.push(n.bookId);e+S<a.length&&await new Promise(n=>setTimeout(n,j))}}catch(e){console.error("批次獲取書籍時發生錯誤:",e),v.value="載入書籍時發生錯誤，請稍後重試"}return{validBooks:t,invalidIds:r}},q=async a=>{if(!(!a?.length||P.value)){P.value=!0;try{const t=a.map(async r=>{try{return await l.delete(`/users/favorite/${r}`),{bookId:r,success:!0}}catch(e){return e.response?.status===404?{bookId:r,success:!0,alreadyRemoved:!0}:(console.warn(`清理收藏 ${r} 失敗:`,e),{bookId:r,success:!1,error:e})}});await Promise.all(t)}catch(t){console.error("清理無效收藏時發生錯誤:",t)}finally{P.value=!1}}},L=()=>{if(!p.value)return m.value;const a=p.value.toLowerCase();return m.value.filter(t=>{const r=t?.result?.title||t?.title||"",e=t?.result?.authors||t?.authors||"",w=t?.result?.publisher||t?.publisher||"",f=t?.result?.categories||t?.categories||"";return r.toLowerCase().includes(a)||e.toLowerCase().includes(a)||w.toLowerCase().includes(a)||f.toLowerCase().includes(a)})},_=()=>{const a=L(),t=(d.value-1)*b.value,r=t+b.value;y.value=a.slice(t,r)},T=async()=>{if(!g.value){g.value=!0,v.value=null;try{const{data:a}=await l.get("/users/favorite"),t=a?.result||a||[];if(!t.length){m.value=[],y.value=[];return}const{validBooks:r,invalidIds:e}=await X(t);m.value=r,_(),e.length>0&&setTimeout(()=>q(e),0)}catch(a){console.error("載入收藏失敗:",a),v.value=a?.response?.data?.message||"載入喜愛書籍失敗",m.value=[],y.value=[]}finally{g.value=!1}}},R=()=>{d.value=1,_()},G=()=>{_()},I=()=>{d.value=1,_()},J=()=>{d.value=1,_()};return ee(()=>{T()}),o({tableLoadItems:T,tableApplySearch:R}),(a,t)=>{const r=te("RouterLink");return $(),A(he,null,{default:i(()=>[h(be,null,{default:i(()=>[h(ye,{cols:"12"},{default:i(()=>[h(we,{"items-per-page":b.value,"onUpdate:itemsPerPage":[t[2]||(t[2]=e=>b.value=e),I],"sort-by":V.value,"onUpdate:sortBy":[t[3]||(t[3]=e=>V.value=e),J],page:d.value,"onUpdate:page":[t[4]||(t[4]=e=>d.value=e),G],items:y.value,headers:Y,loading:g.value,"items-length":H.value,search:p.value,hover:""},{top:i(()=>[h(pe,{class:"mr-3",label:"搜尋","append-icon":re(fe),modelValue:p.value,"onUpdate:modelValue":t[0]||(t[0]=e=>p.value=e),"onClick:append":R,onKeydown:se(R,["enter"])},null,8,["append-icon","modelValue"]),v.value?($(),A(Se,{key:0,class:"mt-2",type:"error",dismissible:"","onClick:close":t[1]||(t[1]=e=>v.value=null)},{default:i(()=>[le(D(v.value),1)]),_:1})):ae("",!0)]),"item.image":i(({item:e})=>[h(r,{class:"text-primary text-decoration-none",to:"/books/"+(e?.result?._id||e?._id||e?.result?.id||e?.id),title:e?.result?.title||e?.title||""},{default:i(()=>[h(ge,{src:N(e),width:"80",height:"80",cover:"",alt:e?.result?.title||e?.title||"書籍圖片"},{placeholder:i(()=>[h($e,{type:"image"})]),_:2},1032,["src","alt"])]),_:2},1032,["to","title"])]),"item.starRating":i(({item:e})=>[h(ke,{"model-value":z(e),readonly:"",color:"#4d4637 darken-3",size:"20"},null,8,["model-value"])]),"item.userReview":i(({item:e})=>[x("div",De,[x("p",Ue,D(K(e)),1)])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1})}}},Oe=de(Ee,[["__scopeId","data-v-c92c0024"]]);export{Oe as default};
