var oe=Object.defineProperty,se=Object.defineProperties;var ue=Object.getOwnPropertyDescriptors;var E=Object.getOwnPropertySymbols;var re=Object.prototype.hasOwnProperty,ne=Object.prototype.propertyIsEnumerable;var O=(m,i,t)=>i in m?oe(m,i,{enumerable:!0,configurable:!0,writable:!0,value:t}):m[i]=t,G=(m,i)=>{for(var t in i||(i={}))re.call(i,t)&&O(m,t,i[t]);if(E)for(var t of E(i))ne.call(i,t)&&O(m,t,i[t]);return m},J=(m,i)=>se(m,ue(i));var q=(m,i,t)=>new Promise((j,g)=>{var b=c=>{try{p(t.next(c))}catch(f){g(f)}},v=c=>{try{p(t.throw(c))}catch(f){g(f)}},p=c=>c.done?j(c.value):Promise.resolve(c.value).then(b,v);p((t=t.apply(m,i)).next())});import{O as ie,r as y,j as ce,w as me,G as k,H as o,a2 as de,F as w,I as l,ac as h,ab as C,ai as x,L as pe,ax as ve,a5 as K,an as fe,ao as ge,u,af as A,a9 as be,_ as Ve,a0 as P,aB as ye,R as H,a3 as $,M as W,aa as he,aC as xe,as as ke,ae as we}from"./vue-vendor-5ccff89c.js";import{b as Ce,e as N,i as Pe,u as Be,h as V,a as Ie}from"./vendor-913c4e2a.js";import{a as Ue}from"./index-183e0965.js";const _e=W("h1",{class:"text-center"},"引入書籍",-1),Fe={__name:"ImportView",setup(m){const{apiAuth:i}=Ue(),t=ie(),j=y(!1),g=y(!1),b=y(""),v=y(""),p=y(null),c=y(""),f=y(!1),F=ce(()=>c.value==="upload"&&p.value?URL.createObjectURL(p.value):c.value==="api"&&v.value?v.value:null),Q=Ce({title:N().required("缺少商品名稱"),publisher:N().required("缺少出版者"),retailPrice:Pe().typeError("書籍價格格式錯誤").required("缺少書籍價格").min(0,"書籍價格不能小於 0"),description:N().required("缺少簡介")}),{handleSubmit:X,resetForm:z}=Be({validationSchema:Q,initialValues:{title:"",authors:"",publisher:"",retailPrice:"",categories:"",description:"",image:"",maturityRating:""}}),B=V("title"),I=V("authors"),U=V("publisher"),_=V("retailPrice"),T=V("categories"),M=V("description"),D=V("image"),Y=V("maturityRating");me(f,s=>{Y.value.value=s?"MATURE":"NOT_MATURE"});const Z=s=>{const e=s.target.files[0];if(e){if(!["image/jpeg","image/png","image/jpg"].includes(e.type)){t({text:"只支援 JPG 和 PNG 格式",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),s.target.value="";return}if(e.size>1024*1024){t({text:"檔案大小不能超過 1MB",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),s.target.value="";return}p.value=e,c.value="upload",t({text:"圖片選取成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}},S=()=>{p.value=null,v.value="",c.value="",D.value.value="",document.querySelector('input[type="file"]')&&(document.querySelector('input[type="file"]').value="")},ee=()=>{z(),S(),b.value="",f.value=!1},ae=(s,e=null)=>{const a=new FormData;return Object.keys(s).forEach(d=>{s[d]!==null&&s[d]!==void 0&&s[d]!==""&&a.append(d,s[d])}),e&&a.append("image",e),a},le=X(s=>q(this,null,function*(){var e,a,d;g.value=!0;try{let r;const n={};c.value==="upload"&&p.value?(console.log("準備提交含用戶圖片的資料..."),r=ae(s,p.value),n["Content-Type"]="multipart/form-data"):(console.log("準備提交 JSON 資料..."),r=J(G({},s),{image:c.value==="api"&&v.value?v.value:""}),n["Content-Type"]="application/json"),console.log("準備提交數據:",r);const R=yield i.post("/books",r,{headers:n});console.log("書籍創建成功:",R.data),t({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),ee()}catch(r){console.error("提交失敗:",r),console.error("錯誤詳情:",(e=r.response)==null?void 0:e.data);const n=((d=(a=r==null?void 0:r.response)==null?void 0:a.data)==null?void 0:d.message)||"發生錯誤，請稍後再試";t({text:n,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}finally{g.value=!1}})),L=()=>q(this,null,function*(){var s,e;if(b.value.trim())try{const a=/^\d{10}(\d{3})?$/.test(b.value),d=encodeURIComponent(b.value.trim()),{data:r}=yield Ie.get(`https://www.googleapis.com/books/v1/volumes?q=${a?"isbn":"intitle"}:${d}`);if(console.log("Google Books API 回應:",r),r&&r.items&&r.items.length>0){const n=r.items[0].volumeInfo,R=r.items[0].saleInfo;B.value.value=n.title||"",I.value.value=n.authors?n.authors.join(", "):"",U.value.value=n.publisher||"",_.value.value=R.retailPrice?R.retailPrice.amount:"",T.value.value=n.categories?n.categories.join(", "):"",M.value.value=n.description||"";const te=n.maturityRating||"";f.value=te==="MATURE",n.imageLinks&&n.imageLinks.thumbnail?(v.value=n.imageLinks.thumbnail.replace("http://","https://").replace("img=1&zoom=1","img=2").replace("edge=curl",""),c.value="api",D.value.value=v.value,p.value=null,document.querySelector('input[type="file"]')&&(document.querySelector('input[type="file"]').value="")):S(),t({text:"引入成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}else t({text:"查無此書",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}catch(a){console.error("搜尋書籍錯誤:",a);const d=((e=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:e.message)||"查無此書";t({text:d,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),z(),S()}});return(s,e)=>(w(),k(de,null,{default:o(()=>[l(C,null,{default:o(()=>[l(h,{cols:"12"},{default:o(()=>[_e]),_:1})]),_:1}),l(K,null,{default:o(()=>[l(C,null,{default:o(()=>[l(h,null,{default:o(()=>[l(x,{class:"mx-auto mt-5",modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=a=>b.value=a),density:"comfortable","menu-icon":"",placeholder:"請輸入書籍名稱或13碼的isbn進行搜尋","prepend-inner-icon":"mdi-magnify",rounded:"",theme:"light",variant:"solo",style:pe({width:j.value?"100%":"500px"}),"onClick:append":L,onKeydown:ve(L,["enter"])},null,8,["modelValue","style"])]),_:1})]),_:1})]),_:1}),l(C,null,{default:o(()=>[l(h,{class:"d-flex justify-center",cols:"12"},{default:o(()=>[l(fe,{disabled:g.value,onSubmit:ge(u(le),["prevent"])},{default:o(()=>[l(A,null,{default:o(()=>[l(C,{class:"flex justify-center align-center"},{default:o(()=>[l(h,null,{default:o(()=>[l(A,{class:"d-flex justify-center align-center flex-column ml-4",outlined:"",style:{"min-height":"500px","min-width":"400px"}},{default:o(()=>[F.value?(w(),k(be,{key:0,src:F.value,width:"350px",height:"500px",cover:""},null,8,["src"])):(w(),k(Ve,{key:1,class:"mb-3",size:"100",color:"grey-lighten-2"},{default:o(()=>[P("mdi-image-outline")]),_:1})),c.value==="upload"?(w(),k(ye,{key:2,class:"mb-3",color:"green",size:"small"},{default:o(()=>[P("上傳圖片")]),_:1})):H("",!0),l($,{class:"mt-1",color:"primary","prepend-icon":"mdi-upload",onClick:e[1]||(e[1]=a=>s.$refs.fileInput.click()),disabled:g.value},{default:o(()=>[P("上傳自己的圖片")]),_:1},8,["disabled"]),W("input",{ref:"fileInput",type:"file",accept:"image/*",style:{display:"none"},onChange:Z},null,544),F.value?(w(),k($,{key:3,class:"mt-2",color:"error",variant:"text",size:"small",onClick:S},{default:o(()=>[P("清除圖片")]),_:1})):H("",!0)]),_:1})]),_:1}),l(h,{class:"me-5 mt-5"},{default:o(()=>[l(he),l(x,{label:"書本名稱",modelValue:u(B).value.value,"onUpdate:modelValue":e[2]||(e[2]=a=>u(B).value.value=a),width:300,"error-messages":u(B).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"作者",modelValue:u(I).value.value,"onUpdate:modelValue":e[3]||(e[3]=a=>u(I).value.value=a),"error-messages":u(I).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"出版者",modelValue:u(U).value.value,"onUpdate:modelValue":e[4]||(e[4]=a=>u(U).value.value=a),"error-messages":u(U).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"價格",modelValue:u(_).value.value,"onUpdate:modelValue":e[5]||(e[5]=a=>u(_).value.value=a),"error-messages":u(_).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"分類",modelValue:u(T).value.value,"onUpdate:modelValue":e[6]||(e[6]=a=>u(T).value.value=a)},null,8,["modelValue"]),l(A,{class:"pa-1 mb-6",outlined:"",style:{"background-color":"rgba(0,0,0,0.04)"}},{default:o(()=>[l(xe,{label:"成人內容 (18+)",modelValue:f.value,"onUpdate:modelValue":e[7]||(e[7]=a=>f.value=a),"hide-details":""},null,8,["modelValue"])]),_:1}),l(ke,{label:"簡介",modelValue:u(M).value.value,"onUpdate:modelValue":e[8]||(e[8]=a=>u(M).value.value=a),"error-messages":u(M).errorMessage.value},null,8,["modelValue","error-messages"]),l(we)]),_:1})]),_:1}),l(C,{class:"text-center mb-5",cols:"12"},{default:o(()=>[l(h,null,{default:o(()=>[l(K),l($,{color:"green",type:"submit",loading:g.value},{default:o(()=>[P("送出")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1})]),_:1}))}};export{Fe as default};
