import{j as t,P as W,n as X,b as k,ac as M,af as Y,H as ee,a7 as P,a2 as o,F as I,a3 as w,u as i,a6 as C,Z as p,l as d,a1 as D,a8 as te,ae as U,ad as oe}from"./vue-vendor-DIljl67C.js";import{u as le}from"./vee-validate-7KorKqsb.js";import{m as ae,t as q,s as N,w as j,J as se,V as ne,G as A,i as h,H as R,E as re,K as ue}from"./index--M2WR1kr.js";import{h as ie,i as de,c as ce,q as me,r as fe,s as pe}from"./icons-C5frdmYn.js";import{V as ve}from"./VContainer-B--mYzB2.js";import{V as f}from"./VRow-D5jAqACE.js";import{V as n}from"./VCol-bB1PHq-U.js";import{V as T}from"./VForm-MCqC4UVC.js";import{V as L}from"./VRating-K48Asw-M.js";import{V as H}from"./VTextarea-Cp_tIBTm.js";import{V as ge,a as be,b as Ve,c as _e}from"./VList-BRKCNeM-.js";import{g as ke,p as ye,f as we,a as Ce}from"./vuetify-vendor-BSJ2BONf.js";import"./VDivider-5f0YQV19.js";const he=ye({start:Boolean,end:Boolean,...Ce(),...ae()},"VListItemAction"),z=ke()({name:"VListItemAction",props:he(),setup(c,v){let{slots:b}=v;return we(()=>t(c.tag,{class:X(["v-list-item-action",{"v-list-item-action--start":c.start,"v-list-item-action--end":c.end},c.class]),style:W(c.style)},b)),{}}});function xe(c){const{apiAuth:v}=j(),b=q(),m=k(!1),y=N(),V=M();return{isFavorite:m,checkFavoriteStatus:async()=>{try{const{data:u}=await v.get("/users/favorite",{params:{bookId:c}});m.value=u.result.includes(c)}catch(u){console.error(u),m.value=!1}},addFavorite:async()=>{if(!b.isLogin){V.push("/login");return}m.value=!m.value;try{const{data:u}=await v.post("/users/favorite",{bookId:c,isFavorite:m.value});b.favorite=u.result,y({text:m.value?"已加入我的最愛":"已移除我的最愛",showCloseButton:!1,snackbarProps:{timeout:2e3,color:m.value?"green":"red",location:"bottom"}})}catch(u){console.error(u),u.response&&u.response.status===401?V.push("/login"):y({text:"發生錯誤，請稍後再試",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}}}const Fe=["innerHTML"],Pe={key:1},qe={__name:"BookView",setup(c){const v=Y(),b=M(),{api:m,apiAuth:y}=j(),V=k(!1),x=k(!1),g=N(),u=q(),_=k({usersId:"",rating:0,comment:""}),F=k(!1),{handleSubmit:S}=le({initialValues:{usersId:"",rating:0,comment:""}}),s=k({_id:"",image:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",buyLink:"",description:"",reviews:[]}),r=k([]),{isFavorite:B,checkFavoriteStatus:E,addFavorite:G}=xe(v.params.id),J=()=>{F.value=!1},$=S(async a=>{if(console.log(_.value),!u.isLogin){b.push("/login"),g({text:"請先登入",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}});return}try{const{data:e}=await y.post(`/books/${v.params.id}/reviews`,{rating:_.value.rating,conmment:_.value.comment});e&&e.result&&s.value.reviews.push(e.result),g({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(e){console.log(e);const l=e?.response?.data?.message||"發生錯誤，請稍後再試";g({text:l,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),K=a=>{if(a){const e=s.value.reviews.find(l=>l._id===a);r.value.id=e._id,r.value.rating=e.rating,r.value.comment=e.comment,r.value.bookId=s.value._id,console.log(r.value.bookId)}F.value=!0},Z=S(async a=>{try{console.log(r.value),console.log("Form values:",a);const e=new FormData;for(const l in a)e.append(l,r.value[l]||a[l]);F.value===""&&await y.patch(`/books/${r.value.bookId}/reviews/${r.value.id}`,e),console.log("FormData entries:",...e.entries()),g({text:"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(e){console.log(e);const l=e?.response?.data?.message||"發生錯誤，請稍後再試";g({text:l,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}J()});console.log(r.value),ee(async()=>{try{const{data:a}=await m.get(`/books/${v.params.id}`);s.value._id=a.result._id,s.value.image=a.result.image,s.value.title=a.result.title,s.value.authors=a.result.authors,s.value.publisher=a.result.publisher,s.value.retailPrice=a.result.retailPrice,s.value.categories=a.result.categories,s.value.buyLink=a.result.buyLink;let e=a.result.description.replace(/(※|★|◆|✓|●|▓|▌|￭|──|【)/g,"<br>$1");e=e.replace(/(】)/g,"$1<br>"),e=e.replace(new RegExp("(?<=──[^,]*?)(?=,)","g"),"<br>$1"),s.value.description=e,s.value.reviews=a.result.reviews,document.title=`書評網 | ${s.value.title}`,await E()}catch(a){console.log(a)}});const O=async()=>{if(!u.isLogin){b.push("/login");return}try{const{data:a}=await y.patch("/users/cart",{book:s.value._id,quantity:1});u.cart=a.result,g({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(a){const e=a?.response?.data?.message||"發生錯誤，請稍後再試";g({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}};return(a,e)=>(w(),P(I,null,[t(ve,null,{default:o(()=>[t(f,null,{default:o(()=>[t(n,{cols:"12",md:"3",style:{position:"sticky"},top:"0"},{default:o(()=>[t(ne,{src:s.value.image},null,8,["src"]),t(A,null,{default:o(()=>[t(f,{class:"justify-center align-center"},{default:o(()=>[t(n,{cols:"6"},{default:o(()=>[t(h,{"prepend-icon":i(B)?i(ie):i(de),color:i(B)?"red":"blue",onClick:i(G)},{default:o(()=>[C(p(i(B)?"取消最愛":"加入最愛"),1)]),_:1},8,["prepend-icon","color","onClick"])]),_:1}),t(n,{cols:"6"},{default:o(()=>[t(h,{color:"primary","prepend-icon":i(ce),onClick:O},{default:o(()=>e[7]||(e[7]=[C("加入購物車",-1)])),_:1,__:[7]},8,["prepend-icon"])]),_:1})]),_:1})]),_:1})]),_:1}),t(n,{cols:"12",md:"9"},{default:o(()=>[d("h1",null,p(s.value.title),1),d("h2",null,p(s.value.authors),1),t(f,null,{default:o(()=>[t(n,{cols:"auto"},{default:o(()=>e[8]||(e[8]=[d("h3",null,"出版者:",-1)])),_:1,__:[8]}),t(n,null,{default:o(()=>[d("p",null,p(s.value.publisher),1)]),_:1})]),_:1}),t(f,null,{default:o(()=>[t(n,{cols:"auto"},{default:o(()=>e[9]||(e[9]=[d("h3",null,"價格:",-1)])),_:1,__:[9]}),t(n,null,{default:o(()=>[d("p",null,"$"+p(s.value.retailPrice),1)]),_:1})]),_:1}),t(f,null,{default:o(()=>[t(n,{cols:"auto"},{default:o(()=>e[10]||(e[10]=[d("h3",null,"分類:",-1)])),_:1,__:[10]}),t(n,null,{default:o(()=>[d("p",null,p(s.value.categories),1)]),_:1})]),_:1}),t(f,null,{default:o(()=>[t(n,{cols:"auto"},{default:o(()=>[e[11]||(e[11]=d("h3",null,"簡介:",-1)),x.value?(w(),P("p",{key:0,innerHTML:s.value.description},null,8,Fe)):(w(),P("p",Pe,p(s.value.description.substring(0,500)),1))]),_:1,__:[11]}),t(n,{class:"text-center"},{default:o(()=>[s.value.description.length>100?(w(),D(h,{key:0,color:"#4d4637",onClick:e[0]||(e[0]=l=>x.value=!x.value),icon:x.value?i(me):i(fe)},null,8,["icon"])):te("",!0)]),_:1})]),_:1}),t(f,null,{default:o(()=>[t(n,{cols:"12"},{default:o(()=>[e[13]||(e[13]=d("h3",null,"新增書評:",-1)),t(T,{disabled:V.value,onSubmit:U(i($),["prevent"])},{default:o(()=>[t(L,{modelValue:_.value.rating,"onUpdate:modelValue":e[1]||(e[1]=l=>_.value.rating=l),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),t(H,{modelValue:_.value.comment,"onUpdate:modelValue":e[2]||(e[2]=l=>_.value.comment=l),label:"你的書評",required:""},null,8,["modelValue"]),t(h,{color:"#4d4637",type:"submit",loading:V.value},{default:o(()=>e[12]||(e[12]=[C("提交",-1)])),_:1,__:[12]},8,["loading"])]),_:1},8,["disabled","onSubmit"])]),_:1,__:[13]})]),_:1}),t(f,null,{default:o(()=>[t(n,{cols:"12"},{default:o(()=>[e[14]||(e[14]=d("h3",null,"書評:",-1)),t(ge,null,{default:o(()=>[(w(!0),P(I,null,oe(s.value.reviews,l=>(w(),D(be,{key:l._id},{default:o(()=>[t(R,null,{default:o(()=>[t(f,null,{default:o(()=>[t(n,{cols:"auto"},{default:o(()=>[t(Ve,{style:{fontSize:"30px"}},{default:o(()=>[C(p(l.user.account),1)]),_:2},1024)]),_:2},1024),t(n,{cols:"auto"},{default:o(()=>[t(z,null,{default:o(()=>[t(L,{modelValue:l.rating,"onUpdate:modelValue":Q=>l.rating=Q,color:"#4d4637 darken-3",size:"25",readonly:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),t(f,null,{default:o(()=>[t(n,{cols:"auto"},{default:o(()=>[t(_e,{class:"mb-5",style:{fontSize:"20px"}},{default:o(()=>[C(p(l.comment),1)]),_:2},1024)]),_:2},1024),t(n,{class:"d-flex justify-end"},{default:o(()=>[t(z,null,{default:o(()=>[t(h,{icon:i(pe),color:"#4d4637",onClick:()=>K(l._id)},null,8,["icon","onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1,__:[14]})]),_:1})]),_:1})]),_:1})]),_:1}),t(se,{modelValue:F.value,"onUpdate:modelValue":e[6]||(e[6]=l=>F.value=l),"max-width":"290"},{default:o(()=>[t(T,{disabled:V.value,onSubmit:U(i($),["prevent"])},{default:o(()=>[t(R,null,{default:o(()=>[t(re,null,{default:o(()=>e[15]||(e[15]=[d("h3",null,"編輯書評",-1)])),_:1,__:[15]}),t(ue,null,{default:o(()=>[t(L,{modelValue:r.value.rating,"onUpdate:modelValue":e[3]||(e[3]=l=>r.value.rating=l),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),t(H,{modelValue:r.value.comment,"onUpdate:modelValue":e[4]||(e[4]=l=>r.value.comment=l),label:"你的書評",required:""},null,8,["modelValue"])]),_:1}),t(A,null,{default:o(()=>[t(h,{color:"#4d4637",onClick:e[5]||(e[5]=l=>i(Z)(a.review)),loading:V.value},{default:o(()=>e[16]||(e[16]=[C("修正",-1)])),_:1,__:[16]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64))}};export{qe as default};
