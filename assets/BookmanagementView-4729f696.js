var ae=Object.defineProperty,te=Object.defineProperties;var le=Object.getOwnPropertyDescriptors;var z=Object.getOwnPropertySymbols;var oe=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var E=(r,u,n)=>u in r?ae(r,u,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[u]=n,H=(r,u)=>{for(var n in u||(u={}))oe.call(u,n)&&E(r,n,u[n]);if(z)for(var n of z(u))se.call(u,n)&&E(r,n,u[n]);return r},K=(r,u)=>te(r,le(u));var U=(r,u,n)=>new Promise((_,f)=>{var V=m=>{try{w(n.next(m))}catch(k){f(k)}},x=m=>{try{w(n.throw(m))}catch(k){f(k)}},w=m=>m.done?_(m.value):Promise.resolve(m.value).then(V,x);w((n=n.apply(r,u)).next())});import{O as ne,r as p,G as S,H as l,a2 as ie,F as D,I as t,ac as L,az as ue,ai as h,ax as re,a9 as G,a3 as F,a0 as v,ap as de,af as A,aa as M,at as J,an as ce,ab as Q,aA as pe,_ as T,M as R,ay as me,a8 as ve,R as ge,as as fe,ae as be,a5 as ye,ag as Ve,ah as ke}from"./vue-vendor-5ccff89c.js";import{_ as he,a as _e}from"./index-79ded718.js";import"./vendor-1de8772a.js";const W=r=>(Ve("data-v-9e024360"),r=r(),ke(),r),xe=W(()=>R("div",{style:{color:"white","margin-top":"8px"}},"點擊更換圖片",-1)),we={class:"text-center"},Ce=W(()=>R("div",{class:"mt-2 text-grey"},"點擊上傳圖片",-1)),Pe={__name:"BookmanagementView",setup(r){const{apiAuth:u}=_e(),n=ne(),_=p(10),f=p([{key:"createdAt",order:"desc"}]),V=p(1),x=p([]),w=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"title"},{title:"作者",align:"center",sortable:!0,key:"authors"},{title:"出版者",align:"center",sortable:!0,key:"publisher"},{title:"價格",align:"center",sortable:!0,key:"retailPrice"},{title:"分類",align:"center",sortable:!0,key:"categories"},{title:"編輯",align:"center",sortable:!1,key:"edit"},{title:"刪除",align:"center",sortable:!1,key:"delete"}],m=p(!0),k=p(0),C=p(""),P=p(!1),o=p({_id:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",description:"",image:""}),b=p(null),g=p(""),q=p(!1),j=()=>g.value?g.value:o.value.image||"",O=()=>{const i=document.querySelector('input[type="file"]');i&&i.click()},X=i=>{const a=i.target.files[0];a&&(b.value=a,g.value&&URL.revokeObjectURL(g.value),g.value=URL.createObjectURL(a))},y=()=>U(this,null,function*(){var i,a,e,d;m.value=!0;try{const{data:c}=yield u.get("/books/all",{params:{page:V.value,itemsPerPage:_.value,sortBy:((i=f.value[0])==null?void 0:i.key)||"createdAt",sortOrder:((a=f.value[0])==null?void 0:a.order)==="asc"?1:-1,search:C.value}});x.value.splice(0,x.value.length,...c.result.data),k.value=c.result.total}catch(c){console.log(c);const B=((d=(e=c==null?void 0:c.response)==null?void 0:e.data)==null?void 0:d.message)||"發生錯誤，請稍後再試";n({text:B,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}m.value=!1});y();const Y=i=>U(this,null,function*(){var a,e;if(console.log(i),!i._id){console.error("沒有書籍 ID");return}try{yield u.delete(`/books/${i._id}`),n({text:"書籍已成功刪除",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),y()}catch(d){console.log(d);const c=((e=(a=d==null?void 0:d.response)==null?void 0:a.data)==null?void 0:e.message)||"刪除書籍時發生錯誤，請稍後再試";n({text:c,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),$=()=>{V.value=1,y()},Z=i=>{o.value=K(H({},i),{image:i.image||""}),P.value=!0,b.value=null,g.value=""},N=()=>{P.value=!1,b.value=null,g.value&&(URL.revokeObjectURL(g.value),g.value="");const i=document.querySelector('input[type="file"]');i&&(i.value="")},ee=()=>U(this,null,function*(){var i,a,e,d,c,B;q.value=!0;try{if(b.value){const s=new FormData;s.append("image",b.value),s.append("title",o.value.title),s.append("authors",o.value.authors),s.append("publisher",o.value.publisher),s.append("retailPrice",o.value.retailPrice),s.append("categories",o.value.categories),s.append("description",o.value.description),yield u.patch(`/books/${o.value._id}`,s,{headers:{"Content-Type":"multipart/form-data"}})}else{const s={title:o.value.title,authors:o.value.authors,publisher:o.value.publisher,retailPrice:parseFloat(o.value.retailPrice)||0,categories:o.value.categories,description:o.value.description};yield u.patch(`/books/${o.value._id}`,s)}n({text:"書籍已成功更新",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),y(),N()}catch(s){console.error("更新書籍失敗:",s);let I="更新書籍時發生錯誤，請稍後再試";((i=s==null?void 0:s.response)==null?void 0:i.status)===404?I="找不到書籍":((a=s==null?void 0:s.response)==null?void 0:a.status)===400?I=((d=(e=s==null?void 0:s.response)==null?void 0:e.data)==null?void 0:d.message)||"ID 格式錯誤":(B=(c=s==null?void 0:s.response)==null?void 0:c.data)!=null&&B.message&&(I=s.response.data.message),n({text:I,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"red",location:"bottom"}})}q.value=!1});return(i,a)=>(D(),S(ie,null,{default:l(()=>[t(Q,null,{default:l(()=>[t(L,{cols:"12"},{default:l(()=>[t(ue,{"items-per-page":_.value,"onUpdate:itemsPerPage":[a[1]||(a[1]=e=>_.value=e),y],"sort-by":f.value,"onUpdate:sortBy":[a[2]||(a[2]=e=>f.value=e),y],page:V.value,"onUpdate:page":[a[3]||(a[3]=e=>V.value=e),y],items:x.value,headers:w,loading:m.value,"items-length":k.value,search:C.value,hover:""},{top:l(()=>[t(h,{label:"搜尋","append-icon":"mdi-magnify",modelValue:C.value,"onUpdate:modelValue":a[0]||(a[0]=e=>C.value=e),"onClick:append":$,onKeydown:re($,["enter"])},null,8,["modelValue"])]),"item.image":l(({item:e})=>[t(G,{src:e.image,width:"80",height:"80",cover:""},null,8,["src"])]),"item.edit":l(({item:e})=>[t(F,{onClick:d=>Z(e)},{default:l(()=>[v("編輯")]),_:2},1032,["onClick"])]),"item.delete":l(({item:e})=>[t(F,{onClick:d=>Y(e)},{default:l(()=>[v("刪除")]),_:2},1032,["onClick"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"]),t(de,{modelValue:P.value,"onUpdate:modelValue":a[10]||(a[10]=e=>P.value=e),persistent:"","max-width":"700px"},{default:l(()=>[t(A,null,{default:l(()=>[t(M,null,{default:l(()=>[v("編輯書籍")]),_:1}),t(J,null,{default:l(()=>[t(ce,{ref:"editForm"},{default:l(()=>[t(Q,null,{default:l(()=>[t(L,{cols:"12",md:"6"},{default:l(()=>[t(h,{modelValue:o.value.title,"onUpdate:modelValue":a[4]||(a[4]=e=>o.value.title=e),label:"書名",required:""},null,8,["modelValue"]),t(h,{modelValue:o.value.authors,"onUpdate:modelValue":a[5]||(a[5]=e=>o.value.authors=e),label:"作者",required:""},null,8,["modelValue"]),t(h,{modelValue:o.value.publisher,"onUpdate:modelValue":a[6]||(a[6]=e=>o.value.publisher=e),label:"出版者",required:""},null,8,["modelValue"]),t(h,{modelValue:o.value.retailPrice,"onUpdate:modelValue":a[7]||(a[7]=e=>o.value.retailPrice=e),label:"價格",required:"",type:"number"},null,8,["modelValue"]),t(h,{modelValue:o.value.categories,"onUpdate:modelValue":a[8]||(a[8]=e=>o.value.categories=e),label:"分類",required:""},null,8,["modelValue"])]),_:1}),t(L,{cols:"12",md:"6"},{default:l(()=>[t(A,{outlined:""},{default:l(()=>[t(M,null,{default:l(()=>[v("書籍圖片")]),_:1}),t(J,null,{default:l(()=>[j()?(D(),S(A,{key:0,class:"image-upload-area mb-3 d-flex align-center justify-center",onClick:O,hover:""},{default:l(()=>[t(G,{class:"mx-auto",src:j(),"max-height":"200","max-width":"100%",contain:""},null,8,["src"]),t(pe,{class:"align-center justify-center hover-overlay","model-value":!1,style:{position:"absolute",top:"0",left:"0",right:"0",bottom:"0",background:"rgba(0,0,0,0.5)",opacity:"0",transition:"opacity 0.3s"}},{default:l(()=>[t(T,{color:"white",size:"48"},{default:l(()=>[v("mdi-camera")]),_:1}),xe]),_:1})]),_:1})):(D(),S(A,{key:1,class:"image-upload-area mb-3 d-flex align-center justify-center",onClick:O,hover:""},{default:l(()=>[R("div",we,[t(T,{size:"64",color:"grey"},{default:l(()=>[v("mdi-camera-plus")]),_:1}),Ce])]),_:1})),R("input",{ref:"fileInput",type:"file",accept:"image/*",style:{display:"none"},onChange:X},null,544),b.value?(D(),S(me,{key:2,class:"mt-3",type:"info",variant:"tonal"},{default:l(()=>[t(T,{class:"mr-2"},{default:l(()=>[v("mdi-file-image")]),_:1}),v("已選擇: "+ve(b.value.name),1)]),_:1})):ge("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),t(L,{cols:"12"},{default:l(()=>[t(fe,{modelValue:o.value.description,"onUpdate:modelValue":a[9]||(a[9]=e=>o.value.description=e),label:"簡介",rows:"5"},null,8,["modelValue"])]),_:1})]),_:1},512)]),_:1}),t(be,null,{default:l(()=>[t(ye),t(F,{color:"blue darken-1",variant:"text",onClick:N},{default:l(()=>[v("取消")]),_:1}),t(F,{color:"blue darken-1",variant:"text",onClick:ee,loading:q.value},{default:l(()=>[v("保存")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}))}},De=he(Pe,[["__scopeId","data-v-9e024360"]]);export{De as default};
