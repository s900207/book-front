var y=(x,k,f)=>new Promise((d,g)=>{var b=u=>{try{c(f.next(u))}catch(v){g(v)}},V=u=>{try{c(f.throw(u))}catch(v){g(v)}},c=u=>u.done?d(u.value):Promise.resolve(u.value).then(b,V);c((f=f.apply(x,k)).next())});import{r as C,J as H,R as E,aj as O,k as ee,L as P,H as e,G as l,a0 as te,ak as le,Q as T,F,a8 as p,a9 as r,a6 as ae,ab as I,a1 as S,u as h,Y as B,Z as _,a5 as m,D as A,M as oe,ah as M,ai as N,al as D,am as j,T as se,U as ue,W as ne,ac as q,X as re,an as z,ao as ie,a7 as de,ap as ce}from"./vue-vendor-CO2Qqhmb.js";import{u as me}from"./vendor-oObasS19.js";import{u as G,a as J}from"./index-BzE3j7FH.js";/* empty css                   */function ve(x){const{apiAuth:k}=J(),f=G(),d=C(!1),g=H(),b=E();return{isFavorite:d,checkFavoriteStatus:()=>y(null,null,function*(){try{const{data:u}=yield k.get("/users/favorite",{params:{bookId:x}});d.value=u.result.includes(x)}catch(u){console.error(u),d.value=!1}}),addFavorite:()=>y(null,null,function*(){if(!f.isLogin){b.push("/login");return}d.value=!d.value;try{const{data:u}=yield k.post("/users/favorite",{bookId:x,isFavorite:d.value});f.favorite=u.result,g({text:d.value?"已加入我的最愛":"已移除我的最愛",showCloseButton:!1,snackbarProps:{timeout:2e3,color:d.value?"green":"red",location:"bottom"}})}catch(u){console.error(u),u.response&&u.response.status===401?b.push("/login"):g({text:"發生錯誤，請稍後再試",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}})}}const fe=["innerHTML"],pe={key:1},we={__name:"BookView",setup(x){const k=O(),f=E(),{api:d,apiAuth:g}=J(),b=C(!1),V=C(!1),c=H(),u=G(),v=C({usersId:"",rating:0,comment:""}),L=C(!1),{handleSubmit:U}=me({initialValues:{usersId:"",rating:0,comment:""}}),o=C({_id:"",image:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",buyLink:"",description:"",reviews:[]}),i=C([]),{isFavorite:$,checkFavoriteStatus:Q,addFavorite:W}=ve(k.params.id),X=()=>{L.value=!1},R=U(s=>y(null,null,function*(){var t,a;if(console.log(v.value),!u.isLogin){f.push("/login"),c({text:"請先登入",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}});return}try{const{data:n}=yield g.post(`/books/${k.params.id}/reviews`,{rating:v.value.rating,conmment:v.value.comment});n&&n.result&&o.value.reviews.push(n.result),c({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(n){console.log(n);const w=((a=(t=n==null?void 0:n.response)==null?void 0:t.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";c({text:w,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}})),Y=s=>{if(s){const t=o.value.reviews.find(a=>a._id===s);i.value.id=t._id,i.value.rating=t.rating,i.value.comment=t.comment,i.value.bookId=o.value._id,console.log(i.value.bookId)}L.value=!0},Z=U(s=>y(null,null,function*(){var t,a;try{console.log(i.value),console.log("Form values:",s);const n=new FormData;for(const w in s)n.append(w,i.value[w]||s[w]);L.value===""&&(yield g.patch(`/books/${i.value.bookId}/reviews/${i.value.id}`,n)),console.log("FormData entries:",...n.entries()),c({text:"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(n){console.log(n);const w=((a=(t=n==null?void 0:n.response)==null?void 0:t.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";c({text:w,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}X()}));console.log(i.value),ee(()=>y(null,null,function*(){try{const{data:s}=yield d.get(`/books/${k.params.id}`);o.value._id=s.result._id,o.value.image=s.result.image,o.value.title=s.result.title,o.value.authors=s.result.authors,o.value.publisher=s.result.publisher,o.value.retailPrice=s.result.retailPrice,o.value.categories=s.result.categories,o.value.buyLink=s.result.buyLink;let t=s.result.description.replace(/(※|★|◆|✓|●|▓|▌|￭|──|【)/g,"<br>$1");t=t.replace(/(】)/g,"$1<br>"),t=t.replace(new RegExp("(?<=──[^,]*?)(?=,)","g"),"<br>$1"),o.value.description=t,o.value.reviews=s.result.reviews,document.title=`書評網 | ${o.value.title}`,yield Q()}catch(s){console.log(s)}}));const K=()=>y(null,null,function*(){var s,t;if(!u.isLogin){f.push("/login");return}try{const{data:a}=yield g.patch("/users/cart",{book:o.value._id,quantity:1});u.cart=a.result,c({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(a){const n=((t=(s=a==null?void 0:a.response)==null?void 0:s.data)==null?void 0:t.message)||"發生錯誤，請稍後再試";c({text:n,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}});return(s,t)=>(F(),P(T,null,[e(te,null,{default:l(()=>[e(p,null,{default:l(()=>[e(r,{cols:"12",md:"3",style:{position:"sticky"},top:"0"},{default:l(()=>[e(ae,{src:o.value.image},null,8,["src"]),e(I,null,{default:l(()=>[e(p,{class:"justify-center align-center"},{default:l(()=>[e(r,{cols:"6"},{default:l(()=>[e(S,{"prepend-icon":h($)?"mdi-heart-minus":"mdi-heart-plus",color:h($)?"red":"blue",onClick:h(W)},{default:l(()=>[B(_(h($)?"取消最愛":"加入最愛"),1)]),_:1},8,["prepend-icon","color","onClick"])]),_:1}),e(r,{cols:"6"},{default:l(()=>[e(S,{color:"primary","prepend-icon":"mdi-cart",onClick:K},{default:l(()=>t[7]||(t[7]=[B("加入購物車",-1)])),_:1,__:[7]})]),_:1})]),_:1})]),_:1})]),_:1}),e(r,{cols:"12",md:"9"},{default:l(()=>[m("h1",null,_(o.value.title),1),m("h2",null,_(o.value.authors),1),e(p,null,{default:l(()=>[e(r,{cols:"auto"},{default:l(()=>t[8]||(t[8]=[m("h3",null,"出版者:",-1)])),_:1,__:[8]}),e(r,null,{default:l(()=>[m("p",null,_(o.value.publisher),1)]),_:1})]),_:1}),e(p,null,{default:l(()=>[e(r,{cols:"auto"},{default:l(()=>t[9]||(t[9]=[m("h3",null,"價格:",-1)])),_:1,__:[9]}),e(r,null,{default:l(()=>[m("p",null,"$"+_(o.value.retailPrice),1)]),_:1})]),_:1}),e(p,null,{default:l(()=>[e(r,{cols:"auto"},{default:l(()=>t[10]||(t[10]=[m("h3",null,"分類:",-1)])),_:1,__:[10]}),e(r,null,{default:l(()=>[m("p",null,_(o.value.categories),1)]),_:1})]),_:1}),e(p,null,{default:l(()=>[e(r,{cols:"auto"},{default:l(()=>[t[11]||(t[11]=m("h3",null,"簡介:",-1)),V.value?(F(),P("p",{key:0,innerHTML:o.value.description},null,8,fe)):(F(),P("p",pe,_(o.value.description.substring(0,500)),1))]),_:1,__:[11]}),e(r,{class:"text-center"},{default:l(()=>[o.value.description.length>100?(F(),A(S,{key:0,color:"#4d4637",onClick:t[0]||(t[0]=a=>V.value=!V.value),icon:V.value?"mdi-chevron-up":"mdi-chevron-down"},null,8,["icon"])):oe("",!0)]),_:1})]),_:1}),e(p,null,{default:l(()=>[e(r,{cols:"12"},{default:l(()=>[t[13]||(t[13]=m("h3",null,"新增書評:",-1)),e(M,{disabled:b.value,onSubmit:N(h(R),["prevent"])},{default:l(()=>[e(D,{modelValue:v.value.rating,"onUpdate:modelValue":t[1]||(t[1]=a=>v.value.rating=a),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(j,{modelValue:v.value.comment,"onUpdate:modelValue":t[2]||(t[2]=a=>v.value.comment=a),label:"你的書評",required:""},null,8,["modelValue"]),e(S,{color:"#4d4637",type:"submit",loading:b.value},{default:l(()=>t[12]||(t[12]=[B("提交",-1)])),_:1,__:[12]},8,["loading"])]),_:1},8,["disabled","onSubmit"])]),_:1,__:[13]})]),_:1}),e(p,null,{default:l(()=>[e(r,{cols:"12"},{default:l(()=>[t[14]||(t[14]=m("h3",null,"書評:",-1)),e(se,null,{default:l(()=>[(F(!0),P(T,null,ue(o.value.reviews,a=>(F(),A(ne,{key:a._id},{default:l(()=>[e(q,null,{default:l(()=>[e(p,null,{default:l(()=>[e(r,{cols:"auto"},{default:l(()=>[e(re,{style:{fontSize:"30px"}},{default:l(()=>[B(_(a.user.account),1)]),_:2},1024)]),_:2},1024),e(r,{cols:"auto"},{default:l(()=>[e(z,null,{default:l(()=>[e(D,{modelValue:a.rating,"onUpdate:modelValue":n=>a.rating=n,color:"#4d4637 darken-3",size:"25",readonly:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),e(p,null,{default:l(()=>[e(r,{cols:"auto"},{default:l(()=>[e(ie,{class:"mb-5",style:{fontSize:"20px"}},{default:l(()=>[B(_(a.comment),1)]),_:2},1024)]),_:2},1024),e(r,{class:"d-flex justify-end"},{default:l(()=>[e(z,null,{default:l(()=>[e(S,{icon:"mdi-pencil",color:"#4d4637",onClick:()=>Y(a._id)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1,__:[14]})]),_:1})]),_:1})]),_:1})]),_:1}),e(le,{modelValue:L.value,"onUpdate:modelValue":t[6]||(t[6]=a=>L.value=a),"max-width":"290"},{default:l(()=>[e(M,{disabled:b.value,onSubmit:N(h(R),["prevent"])},{default:l(()=>[e(q,null,{default:l(()=>[e(de,null,{default:l(()=>t[15]||(t[15]=[m("h3",null,"編輯書評",-1)])),_:1,__:[15]}),e(ce,null,{default:l(()=>[e(D,{modelValue:i.value.rating,"onUpdate:modelValue":t[3]||(t[3]=a=>i.value.rating=a),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(j,{modelValue:i.value.comment,"onUpdate:modelValue":t[4]||(t[4]=a=>i.value.comment=a),label:"你的書評",required:""},null,8,["modelValue"])]),_:1}),e(I,null,{default:l(()=>[e(S,{color:"#4d4637",onClick:t[5]||(t[5]=a=>h(Z)(s.review)),loading:b.value},{default:l(()=>t[16]||(t[16]=[B("修正",-1)])),_:1,__:[16]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64))}};export{we as default};
