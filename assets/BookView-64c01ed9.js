import{p as K,m as O,a as Q,g as W,u as ee,c as e,Z as z,x as y,Y as j,X as H,ab as E,aw as te,A as ae,a0 as C,a1 as P,a3 as t,ax as oe,a5 as R,V as le,ao as T,J as B,a7 as k,a8 as x,aa as f,an as i,a2 as U,a4 as se,av as D,a6 as ne,ap as M,al as ue,ay as re}from"./index-770a4041.js";import{u as ie}from"./vee-validate.esm-f11806ec.js";import{V as ce}from"./VContainer-3bdb694f.js";import{V as m}from"./VRow-8811b363.js";import{V as u}from"./VCol-c6874e82.js";import{V as N}from"./VForm-681a959e.js";import{V as $}from"./VRating-2b9e4ee0.js";import{V as q}from"./VTextarea-47198ca0.js";import{b as de,V as me,a as pe,c as fe}from"./VList-5fe08494.js";import"./VDivider-f5e85a3b.js";const ve=K({start:Boolean,end:Boolean,...O(),...Q()},"VListItemAction"),ge=W()({name:"VListItemAction",props:ve(),setup(c,v){let{slots:_}=v;return ee(()=>e(c.tag,{class:["v-list-item-action",{"v-list-item-action--start":c.start,"v-list-item-action--end":c.end},c.class],style:c.style},_)),{}}});function _e(c){const{apiAuth:v}=E(),_=z(),d=y(!1),w=j(),b=H();return{isFavorite:d,checkFavoriteStatus:async()=>{try{const{data:r}=await v.get("/users/favorite",{params:{bookId:c}});d.value=r.result.includes(c)}catch(r){console.error(r),d.value=!1}},addFavorite:async()=>{if(!_.isLogin){b.push("/login");return}d.value=!d.value;try{const{data:r}=await v.post("/users/favorite",{bookId:c,isFavorite:d.value});_.favorite=r.result,w({text:d.value?"已加入我的最愛":"已移除我的最愛",showCloseButton:!1,snackbarProps:{timeout:2e3,color:d.value?"green":"red",location:"bottom"}})}catch(r){console.error(r),r.response&&r.response.status===401?b.push("/login"):w({text:"發生錯誤，請稍後再試",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}}}const be=i("h3",null,"出版者:",-1),Ve=i("h3",null,"價格:",-1),he=i("h3",null,"分類:",-1),ke=i("h3",null,"簡介:",-1),ye=["innerHTML"],we={key:1},Ce=i("h3",null,"新增書評:",-1),xe=i("h3",null,"書評:",-1),Fe=i("h3",null,"編輯書評",-1),De={__name:"BookView",setup(c){const v=te(),_=H(),{api:d,apiAuth:w}=E(),b=y(!1),F=y(!1),g=j(),r=z(),V=y({usersId:"",rating:0,comment:""}),L=y(!1),{handleSubmit:A}=ie({initialValues:{usersId:"",rating:0,comment:""}}),l=y({_id:"",image:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",buyLink:"",description:"",reviews:[]}),p=y([]),{isFavorite:S,checkFavoriteStatus:J,addFavorite:X}=_e(v.params.id),Y=()=>{L.value=!1},I=A(async s=>{var a,o;if(console.log(V.value),!r.isLogin){_.push("/login"),g({text:"請先登入",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}});return}try{const{data:n}=await w.post(`/books/${v.params.id}/reviews`,{rating:V.value.rating,conmment:V.value.comment});n&&n.result&&l.value.reviews.push(n.result),g({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(n){console.log(n);const h=((o=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:o.message)||"發生錯誤，請稍後再試";g({text:h,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),Z=A(async s=>{var a,o;try{console.log(p.value),console.log("Form values:",s);const n=new FormData;for(const h in s)n.append(h,p.value[h]||s[h]);L.value===""&&await w.patch(`/books/${p.value.bookId}/reviews/${p.value.id}`,n),console.log("FormData entries:",...n.entries()),g({text:"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(n){console.log(n);const h=((o=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:o.message)||"發生錯誤，請稍後再試";g({text:h,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}Y()});console.log(p.value),ae(async()=>{try{const{data:s}=await d.get(`/books/${v.params.id}`);l.value._id=s.result._id,l.value.image=s.result.image,l.value.title=s.result.title,l.value.authors=s.result.authors,l.value.publisher=s.result.publisher,l.value.retailPrice=s.result.retailPrice,l.value.categories=s.result.categories,l.value.buyLink=s.result.buyLink;let a=s.result.description.replace(/(※|★|◆|✓|●|▓|▌|￭|──|【)/g,"<br>$1");a=a.replace(/(】)/g,"$1<br>"),a=a.replace(new RegExp("(?<=──[^,]*?)(?=,)","g"),"<br>$1"),l.value.description=a,l.value.reviews=s.result.reviews,document.title=`書評網 | ${l.value.title}`,await J()}catch(s){console.log(s)}});const G=async()=>{var s,a;if(!r.isLogin){_.push("/login");return}try{const{data:o}=await w.patch("/users/cart",{book:l.value._id,quantity:1});r.cart=o.result,g({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(o){const n=((a=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";g({text:n,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}};return(s,a)=>(C(),P(R,null,[e(ce,null,{default:t(()=>[e(m,null,{default:t(()=>[e(u,{cols:"12",md:"3",style:{position:"sticky"},top:"0"},{default:t(()=>[e(le,{src:l.value.image},null,8,["src"]),e(T,null,{default:t(()=>[e(m,{class:"justify-center align-center"},{default:t(()=>[e(u,{cols:"6"},{default:t(()=>[e(B,{"prepend-icon":k(S)?"mdi-heart-minus":"mdi-heart-plus",color:k(S)?"red":"blue",onClick:k(X)},{default:t(()=>[x(f(k(S)?"取消最愛":"加入最愛"),1)]),_:1},8,["prepend-icon","color","onClick"])]),_:1}),e(u,{cols:"6"},{default:t(()=>[e(B,{color:"primary","prepend-icon":"mdi-cart",onClick:G},{default:t(()=>[x("加入購物車")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(u,{cols:"12",md:"9"},{default:t(()=>[i("h1",null,f(l.value.title),1),i("h2",null,f(l.value.authors),1),e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[be]),_:1}),e(u,null,{default:t(()=>[i("p",null,f(l.value.publisher),1)]),_:1})]),_:1}),e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[Ve]),_:1}),e(u,null,{default:t(()=>[i("p",null,"$"+f(l.value.retailPrice),1)]),_:1})]),_:1}),e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[he]),_:1}),e(u,null,{default:t(()=>[i("p",null,f(l.value.categories),1)]),_:1})]),_:1}),e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[ke,F.value?(C(),P("p",{key:0,innerHTML:l.value.description},null,8,ye)):(C(),P("p",we,f(l.value.description.substring(0,500)),1))]),_:1}),e(u,{class:"text-center"},{default:t(()=>[l.value.description.length>100?(C(),U(B,{key:0,color:"#4d4637",onClick:a[0]||(a[0]=o=>F.value=!F.value),icon:F.value?"mdi-chevron-up":"mdi-chevron-down"},null,8,["icon"])):se("",!0)]),_:1})]),_:1}),e(m,null,{default:t(()=>[e(u,{cols:"12"},{default:t(()=>[Ce,e(N,{disabled:b.value,onSubmit:D(k(I),["prevent"])},{default:t(()=>[e($,{modelValue:V.value.rating,"onUpdate:modelValue":a[1]||(a[1]=o=>V.value.rating=o),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(q,{modelValue:V.value.comment,"onUpdate:modelValue":a[2]||(a[2]=o=>V.value.comment=o),label:"你的書評",required:""},null,8,["modelValue"]),e(B,{color:"#4d4637",type:"submit",loading:b.value},{default:t(()=>[x("提交")]),_:1},8,["loading"])]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1}),e(m,null,{default:t(()=>[e(u,{cols:"12"},{default:t(()=>[xe,e(de,null,{default:t(()=>[(C(!0),P(R,null,ne(l.value.reviews,o=>(C(),U(me,{key:o._id},{default:t(()=>[e(M,null,{default:t(()=>[e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[e(pe,{style:{fontSize:"30px"}},{default:t(()=>[x(f(o.user.account),1)]),_:2},1024)]),_:2},1024),e(u,{cols:"auto"},{default:t(()=>[e(ge,null,{default:t(()=>[e($,{modelValue:o.rating,"onUpdate:modelValue":n=>o.rating=n,color:"#4d4637 darken-3",size:"25",readonly:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),e(m,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[e(fe,{class:"mb-5",style:{fontSize:"20px"}},{default:t(()=>[x(f(o.comment),1)]),_:2},1024)]),_:2},1024),e(u,{class:"d-flex justify-end"})]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(oe,{modelValue:L.value,"onUpdate:modelValue":a[6]||(a[6]=o=>L.value=o),"max-width":"290"},{default:t(()=>[e(N,{disabled:b.value,onSubmit:D(k(I),["prevent"])},{default:t(()=>[e(M,null,{default:t(()=>[e(ue,null,{default:t(()=>[Fe]),_:1}),e(re,null,{default:t(()=>[e($,{modelValue:p.value.rating,"onUpdate:modelValue":a[3]||(a[3]=o=>p.value.rating=o),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(q,{modelValue:p.value.comment,"onUpdate:modelValue":a[4]||(a[4]=o=>p.value.comment=o),label:"你的書評",required:""},null,8,["modelValue"])]),_:1}),e(T,null,{default:t(()=>[e(B,{color:"#4d4637",onClick:a[5]||(a[5]=o=>k(Z)(s.review)),loading:b.value},{default:t(()=>[x("修正")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64))}};export{De as default};
