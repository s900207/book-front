import{p as pe,g as me,o as K,t as _,aO as ve,q as ge,u as fe,c as e,a2 as be,G as W,ar as ye,X as Ve,x as m,$ as R,a0 as r,a5 as q,at as C,aC as he,V as ee,J as A,a8 as g,az as ke,aq as O,al as ae,aB as te,aP as Pe,W as J,an as E,aa as _e,a1 as xe,ao as we,a9 as Se,ab as Ce,aw as Be,ax as De}from"./index-9e598208.js";import{V as Te}from"./VContainer-1430d262.js";import{V as j}from"./VCol-4f31792a.js";import{m as Ie,a as Ue,b as Fe,c as Le,d as Re,e as qe,f as Ae,u as Oe,p as je,g as Ee,h as Ge,i as Ne,j as $e,k as He,l as ze,n as le,o as oe,q as se,r as re}from"./VDataTable-c32ae34e.js";import{V as Ke}from"./VForm-244788d2.js";import{V as ue}from"./VRow-260282bd.js";import{V as We}from"./VAlert-6fb7424b.js";import{V as Je}from"./VTextarea-e821055f.js";import"./VList-2b60d3f3.js";import"./VDivider-7cf8fdb8.js";import"./VChip-14f2a9ed.js";import"./VSelectionControl-82d6cdf0.js";const Xe=pe({itemsLength:{type:[Number,String],required:!0},...Ie(),...Ue(),...Fe()},"VDataTableServer"),Me=me()({name:"VDataTableServer",props:Xe(),emits:{"update:modelValue":o=>!0,"update:page":o=>!0,"update:itemsPerPage":o=>!0,"update:sortBy":o=>!0,"update:options":o=>!0,"update:expanded":o=>!0,"update:groupBy":o=>!0},setup(o,x){let{attrs:h,slots:s}=x;const{groupBy:f}=Le(o),{sortBy:v,multiSort:B,mustSort:G}=Re(o),{page:y,itemsPerPage:w}=qe(o),S=K(()=>parseInt(o.itemsLength,10)),{columns:k,headers:u}=Ae(o,{groupBy:f,showSelect:_(o,"showSelect"),showExpand:_(o,"showExpand")}),{items:c}=Oe(o,k),{toggleSort:p}=je({sortBy:v,multiSort:B,mustSort:G,page:y}),{opened:D,isGroupOpen:U,toggleGroup:F,extractRows:N}=Ee({groupBy:f,sortBy:v}),{pageCount:b,setItemsPerPage:$}=Ge({page:y,itemsPerPage:w,itemsLength:S}),{flatItems:T}=Ne(c,f,D),{isSelected:H,select:L,selectAll:z,toggleSelect:n,someSelected:t,allSelected:a}=$e(o,{allItems:c,currentPage:c}),{isExpanded:i,toggleExpand:d}=He(o),P=K(()=>N(c.value));ze({page:y,itemsPerPage:w,sortBy:v,groupBy:f,search:_(o,"search")}),ve("v-data-table",{toggleSort:p,sortBy:v}),ge({VDataTableRows:{hideNoData:_(o,"hideNoData"),noDataText:_(o,"noDataText"),loading:_(o,"loading"),loadingText:_(o,"loadingText")}});const l=K(()=>({page:y.value,itemsPerPage:w.value,sortBy:v.value,pageCount:b.value,toggleSort:p,setItemsPerPage:$,someSelected:t.value,allSelected:a.value,isSelected:H,select:L,selectAll:z,toggleSelect:n,isExpanded:i,toggleExpand:d,isGroupOpen:U,toggleGroup:F,items:P.value.map(V=>V.raw),internalItems:P.value,groupedItems:T.value,columns:k.value,headers:u.value}));fe(()=>{const V=le.filterProps(o),ie=oe.filterProps(o),de=se.filterProps(o),ce=re.filterProps(o);return e(re,W({class:["v-data-table",{"v-data-table--loading":o.loading},o.class],style:o.style},ce),{top:()=>{var I;return(I=s.top)==null?void 0:I.call(s,l.value)},default:()=>{var I,X,M,Q,Y,Z;return s.default?s.default(l.value):e(be,null,[(I=s.colgroup)==null?void 0:I.call(s,l.value),e("thead",{class:"v-data-table__thead",role:"rowgroup"},[e(oe,W(ie,{sticky:o.fixedHeader}),s)]),(X=s.thead)==null?void 0:X.call(s,l.value),e("tbody",{class:"v-data-table__tbody",role:"rowgroup"},[(M=s["body.prepend"])==null?void 0:M.call(s,l.value),s.body?s.body(l.value):e(se,W(h,de,{items:T.value}),s),(Q=s["body.append"])==null?void 0:Q.call(s,l.value)]),(Y=s.tbody)==null?void 0:Y.call(s,l.value),(Z=s.tfoot)==null?void 0:Z.call(s,l.value)])},bottom:()=>s.bottom?s.bottom(l.value):e(le,V,{prepend:s["footer.prepend"]})})})}});const ne=o=>(Be("data-v-9e024360"),o=o(),De(),o),Qe=ne(()=>E("div",{style:{color:"white","margin-top":"8px"}},"點擊更換圖片",-1)),Ye={class:"text-center"},Ze=ne(()=>E("div",{class:"mt-2 text-grey"},"點擊上傳圖片",-1)),ea={__name:"BookmanagementView",setup(o){const{apiAuth:x}=Ce(),h=Ve(),s=m(10),f=m([{key:"createdAt",order:"desc"}]),v=m(1),B=m([]),G=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"title"},{title:"作者",align:"center",sortable:!0,key:"authors"},{title:"出版者",align:"center",sortable:!0,key:"publisher"},{title:"價格",align:"center",sortable:!0,key:"retailPrice"},{title:"分類",align:"center",sortable:!0,key:"categories"},{title:"編輯",align:"center",sortable:!1,key:"edit"},{title:"刪除",align:"center",sortable:!1,key:"delete"}],y=m(!0),w=m(0),S=m(""),k=m(!1),u=m({_id:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",description:"",image:""}),c=m(null),p=m(""),D=m(!1),U=()=>p.value?p.value:u.value.image||"",F=()=>{const n=document.querySelector('input[type="file"]');n&&n.click()},N=n=>{const t=n.target.files[0];t&&(c.value=t,p.value&&URL.revokeObjectURL(p.value),p.value=URL.createObjectURL(t))},b=async()=>{var n,t,a,i;y.value=!0;try{const{data:d}=await x.get("/books/all",{params:{page:v.value,itemsPerPage:s.value,sortBy:((n=f.value[0])==null?void 0:n.key)||"createdAt",sortOrder:((t=f.value[0])==null?void 0:t.order)==="asc"?1:-1,search:S.value}});B.value.splice(0,B.value.length,...d.result.data),w.value=d.result.total}catch(d){console.log(d);const P=((i=(a=d==null?void 0:d.response)==null?void 0:a.data)==null?void 0:i.message)||"發生錯誤，請稍後再試";h({text:P,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}y.value=!1};b();const $=async n=>{var t,a;if(console.log(n),!n._id){console.error("沒有書籍 ID");return}try{await x.delete(`/books/${n._id}`),h({text:"書籍已成功刪除",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),b()}catch(i){console.log(i);const d=((a=(t=i==null?void 0:i.response)==null?void 0:t.data)==null?void 0:a.message)||"刪除書籍時發生錯誤，請稍後再試";h({text:d,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}},T=()=>{v.value=1,b()},H=n=>{u.value={...n,image:n.image||""},k.value=!0,c.value=null,p.value=""},L=()=>{k.value=!1,c.value=null,p.value&&(URL.revokeObjectURL(p.value),p.value="");const n=document.querySelector('input[type="file"]');n&&(n.value="")},z=async()=>{var n,t,a,i,d,P;D.value=!0;try{if(c.value){const l=new FormData;l.append("image",c.value),l.append("title",u.value.title),l.append("authors",u.value.authors),l.append("publisher",u.value.publisher),l.append("retailPrice",u.value.retailPrice),l.append("categories",u.value.categories),l.append("description",u.value.description),await x.patch(`/books/${u.value._id}`,l,{headers:{"Content-Type":"multipart/form-data"}})}else{const l={title:u.value.title,authors:u.value.authors,publisher:u.value.publisher,retailPrice:parseFloat(u.value.retailPrice)||0,categories:u.value.categories,description:u.value.description};await x.patch(`/books/${u.value._id}`,l)}h({text:"書籍已成功更新",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),b(),L()}catch(l){console.error("更新書籍失敗:",l);let V="更新書籍時發生錯誤，請稍後再試";((n=l==null?void 0:l.response)==null?void 0:n.status)===404?V="找不到書籍":((t=l==null?void 0:l.response)==null?void 0:t.status)===400?V=((i=(a=l==null?void 0:l.response)==null?void 0:a.data)==null?void 0:i.message)||"ID 格式錯誤":(P=(d=l==null?void 0:l.response)==null?void 0:d.data)!=null&&P.message&&(V=l.response.data.message),h({text:V,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"red",location:"bottom"}})}D.value=!1};return(n,t)=>(q(),R(Te,null,{default:r(()=>[e(ue,null,{default:r(()=>[e(j,{cols:"12"},{default:r(()=>[e(Me,{"items-per-page":s.value,"onUpdate:itemsPerPage":[t[1]||(t[1]=a=>s.value=a),b],"sort-by":f.value,"onUpdate:sortBy":[t[2]||(t[2]=a=>f.value=a),b],page:v.value,"onUpdate:page":[t[3]||(t[3]=a=>v.value=a),b],items:B.value,headers:G,loading:y.value,"items-length":w.value,search:S.value,hover:""},{top:r(()=>[e(C,{label:"搜尋","append-icon":"mdi-magnify",modelValue:S.value,"onUpdate:modelValue":t[0]||(t[0]=a=>S.value=a),"onClick:append":T,onKeydown:he(T,["enter"])},null,8,["modelValue"])]),"item.image":r(({item:a})=>[e(ee,{src:a.image,width:"80",height:"80",cover:""},null,8,["src"])]),"item.edit":r(({item:a})=>[e(A,{onClick:i=>H(a)},{default:r(()=>[g("編輯")]),_:2},1032,["onClick"])]),"item.delete":r(({item:a})=>[e(A,{onClick:i=>$(a)},{default:r(()=>[g("刪除")]),_:2},1032,["onClick"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"]),e(ke,{modelValue:k.value,"onUpdate:modelValue":t[10]||(t[10]=a=>k.value=a),persistent:"","max-width":"700px"},{default:r(()=>[e(O,null,{default:r(()=>[e(ae,null,{default:r(()=>[g("編輯書籍")]),_:1}),e(te,null,{default:r(()=>[e(Ke,{ref:"editForm"},{default:r(()=>[e(ue,null,{default:r(()=>[e(j,{cols:"12",md:"6"},{default:r(()=>[e(C,{modelValue:u.value.title,"onUpdate:modelValue":t[4]||(t[4]=a=>u.value.title=a),label:"書名",required:""},null,8,["modelValue"]),e(C,{modelValue:u.value.authors,"onUpdate:modelValue":t[5]||(t[5]=a=>u.value.authors=a),label:"作者",required:""},null,8,["modelValue"]),e(C,{modelValue:u.value.publisher,"onUpdate:modelValue":t[6]||(t[6]=a=>u.value.publisher=a),label:"出版者",required:""},null,8,["modelValue"]),e(C,{modelValue:u.value.retailPrice,"onUpdate:modelValue":t[7]||(t[7]=a=>u.value.retailPrice=a),label:"價格",required:"",type:"number"},null,8,["modelValue"]),e(C,{modelValue:u.value.categories,"onUpdate:modelValue":t[8]||(t[8]=a=>u.value.categories=a),label:"分類",required:""},null,8,["modelValue"])]),_:1}),e(j,{cols:"12",md:"6"},{default:r(()=>[e(O,{outlined:""},{default:r(()=>[e(ae,null,{default:r(()=>[g("書籍圖片")]),_:1}),e(te,null,{default:r(()=>[U()?(q(),R(O,{key:0,class:"image-upload-area mb-3 d-flex align-center justify-center",onClick:F,hover:""},{default:r(()=>[e(ee,{class:"mx-auto",src:U(),"max-height":"200","max-width":"100%",contain:""},null,8,["src"]),e(Pe,{class:"align-center justify-center hover-overlay","model-value":!1,style:{position:"absolute",top:"0",left:"0",right:"0",bottom:"0",background:"rgba(0,0,0,0.5)",opacity:"0",transition:"opacity 0.3s"}},{default:r(()=>[e(J,{color:"white",size:"48"},{default:r(()=>[g("mdi-camera")]),_:1}),Qe]),_:1})]),_:1})):(q(),R(O,{key:1,class:"image-upload-area mb-3 d-flex align-center justify-center",onClick:F,hover:""},{default:r(()=>[E("div",Ye,[e(J,{size:"64",color:"grey"},{default:r(()=>[g("mdi-camera-plus")]),_:1}),Ze])]),_:1})),E("input",{ref:"fileInput",type:"file",accept:"image/*",style:{display:"none"},onChange:N},null,544),c.value?(q(),R(We,{key:2,class:"mt-3",type:"info",variant:"tonal"},{default:r(()=>[e(J,{class:"mr-2"},{default:r(()=>[g("mdi-file-image")]),_:1}),g("已選擇: "+_e(c.value.name),1)]),_:1})):xe("",!0)]),_:1})]),_:1})]),_:1})]),_:1}),e(j,{cols:"12"},{default:r(()=>[e(Je,{modelValue:u.value.description,"onUpdate:modelValue":t[9]||(t[9]=a=>u.value.description=a),label:"簡介",rows:"5"},null,8,["modelValue"])]),_:1})]),_:1},512)]),_:1}),e(we,null,{default:r(()=>[e(Se),e(A,{color:"blue darken-1",variant:"text",onClick:L},{default:r(()=>[g("取消")]),_:1}),e(A,{color:"blue darken-1",variant:"text",onClick:z,loading:D.value},{default:r(()=>[g("保存")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}))}},ma=ye(ea,[["__scopeId","data-v-9e024360"]]);export{ma as default};
