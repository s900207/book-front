var y=(A,V,i)=>new Promise((x,d)=>{var B=n=>{try{v(i.next(n))}catch(p){d(p)}},C=n=>{try{v(i.throw(n))}catch(p){d(p)}},v=n=>n.done?x(n.value):Promise.resolve(n.value).then(B,C);v((i=i.apply(A,V)).next())});import{J as X,r as g,D as S,G as f,a0 as Y,E as Z,F as M,H as w,a8 as O,a9 as Q,aq as W,al as z,a6 as b,M as I,ad as k,ar as ee,as as te,Y as se,Z as ae}from"./vue-vendor-CO2Qqhmb.js";import{u as le,a as re}from"./index-DEE-id0k.js";import"./vendor-oObasS19.js";/* empty css                   */const F=55,ve={__name:"MybookView",setup(A){const{apiAuth:V}=re(),i=le(),x=X(),d=g(10),B=g([{key:"createdAt",order:"desc"}]),C=g(1),v=g([]),n=g(null),p=new Map,L=g(!1),H=t=>{var s;return((s=t==null?void 0:t.result)==null?void 0:s.image)||(t==null?void 0:t.image)||""},N=t=>{var e;const l=(((e=t==null?void 0:t.result)==null?void 0:e.reviews)||(t==null?void 0:t.reviews)||[]).find(a=>a.user.$oid===i.value||a.user===i.value);return(l==null?void 0:l.rating)||0},K=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"result.title"},{title:"作者",align:"center",sortable:!0,key:"result.authors"},{title:"出版者",align:"center",sortable:!0,key:"result.publisher"},{title:"分類",align:"center",sortable:!0,key:"result.categories"},{title:"評分(1-5)",align:"center",sortable:!0,key:"result.rating"},{title:"書評",align:"center",sortable:!1,key:"result.review",value:t=>{var e;const l=(((e=t==null?void 0:t.result)==null?void 0:e.reviews)||(t==null?void 0:t.reviews)||[]).find(a=>a.user.$oid===i.value||a.user===i.value);if(l){const a=l.comment,u=[];for(let r=0;r<a.length;r+=F)u.push(a.substring(r,r+F));return u.join(`
`)}else return"未提供書評"}}],m=g(!0),R=g(0),$=g(""),j=t=>y(null,null,function*(){var s;if(p.has(t))return p.get(t);try{const e=(yield V.get(`/books/${t}`)).data;return p.set(t,e),e}catch(l){if(((s=l.response)==null?void 0:s.status)===404)return p.set(t,null),null;throw l}}),q=(t,s=3)=>y(null,null,function*(){const l=[],e=[];for(let a=0;a<t.length;a+=s){const r=t.slice(a,a+s).map(o=>y(null,null,function*(){try{const h=yield j(o);return{bookId:o,book:h,valid:h!==null}}catch(h){return console.warn(`獲取書籍 ${o} 失敗:`,h),{bookId:o,book:null,valid:!1}}})),_=yield Promise.all(r);for(const o of _)o.valid&&o.book?l.push(o.book):e.push(o.bookId);a+s<t.length&&(yield new Promise(o=>setTimeout(o,100)))}return{validBooks:l,invalidIds:e}}),E=t=>y(null,null,function*(){if(!(!t||t.length===0||L.value)){L.value=!0;try{console.log("開始清理無效的 favorite 記錄:",t),n.value=`發現 ${t.length} 本無效書籍，正在清理...`;const s=t.map(a=>y(null,null,function*(){var u;try{return yield V.delete(`/users/favorite/${a}`),{bookId:a,success:!0}}catch(r){return((u=r.response)==null?void 0:u.status)===404?{bookId:a,success:!0,alreadyRemoved:!0}:(console.warn(`清理 favorite ${a} 失敗:`,r),{bookId:a,success:!1,error:r})}})),e=(yield Promise.all(s)).filter(a=>a.success).length;e>0&&(n.value=`已清理 ${e} 筆無效記錄`,setTimeout(()=>{n.value=null},3e3))}catch(s){console.error("清理 favorite 記錄時發生錯誤:",s),n.value="清理過程中發生錯誤"}finally{L.value=!1}}}),P=()=>y(null,null,function*(){var t,s;m.value=!0,n.value=null;try{console.log("開始載入使用者喜愛書籍...");const{data:l}=yield V.get("/users/favorite");console.log("獲取 favorite IDs:",l);const e=l.result||l;if(!e||e.length===0){v.value=[],R.value=0;return}console.log(`找到 ${e.length} 本喜愛書籍`);const{validBooks:a,invalidIds:u}=yield q(e);console.log(`有效書籍: ${a.length}, 無效書籍: ${u.length}`),u.length>0&&setTimeout(()=>E(u),0);let r=a;if($.value){const h=$.value.toLowerCase();r=a.filter(c=>{var T,U;const G=((T=c==null?void 0:c.result)==null?void 0:T.title)||(c==null?void 0:c.title)||"",J=((U=c==null?void 0:c.result)==null?void 0:U.authors)||(c==null?void 0:c.authors)||"";return G.toLowerCase().includes(h)||J.toLowerCase().includes(h)})}const _=(C.value-1)*d.value,o=_+d.value;v.value=r.slice(_,o),R.value=r.length,console.log(`最終顯示書籍數量: ${v.value.length}`)}catch(l){console.error("載入失敗:",l);const e=((s=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:s.message)||"載入喜愛書籍失敗";x({text:e,showCloseButton:!1,snackbarProps:{timeout:3e3,color:"red",location:"bottom"}}),v.value=[],R.value=0}finally{m.value=!1}}),D=()=>{C.value=1,P()};return P(),(t,s)=>{const l=Z("RouterLink");return M(),S(Y,null,{default:f(()=>[w(O,null,{default:f(()=>[w(Q,{cols:"12"},{default:f(()=>[w(W,{"items-per-page":d.value,"onUpdate:itemsPerPage":[s[2]||(s[2]=e=>d.value=e),P],"sort-by":B.value,"onUpdate:sortBy":[s[3]||(s[3]=e=>B.value=e),P],page:C.value,"onUpdate:page":[s[4]||(s[4]=e=>C.value=e),P],items:v.value,headers:K,loading:m.value,"items-length":R.value,search:$.value,hover:""},{top:f(()=>[w(k,{label:"搜尋","append-icon":"mdi-magnify",modelValue:$.value,"onUpdate:modelValue":s[0]||(s[0]=e=>$.value=e),"onClick:append":D,onKeydown:ee(D,["enter"])},null,8,["modelValue"]),n.value?(M(),S(te,{key:0,class:"mt-2",type:"warning",dismissible:"","onClick:close":s[1]||(s[1]=e=>n.value=null)},{default:f(()=>[se(ae(n.value),1)]),_:1})):I("",!0)]),"item.image":f(({item:e})=>{var a,u,r;return[w(l,{class:"text-primary text-decoration-none",to:"/books/"+(((a=e==null?void 0:e.result)==null?void 0:a._id)||(e==null?void 0:e._id)||((u=e==null?void 0:e.result)==null?void 0:u.id)||(e==null?void 0:e.id)),title:((r=e==null?void 0:e.result)==null?void 0:r.title)||(e==null?void 0:e.title)||""},{default:f(()=>[w(b,{src:H(e),width:"80",height:"80",cover:""},null,8,["src"])]),_:2},1032,["to","title"])]}),"item.starRating":f(({item:e})=>[w(z,{value:N(e),readonly:"",color:"#4d4637 darken-3",size:"20"},null,8,["value"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1})}}};export{ve as default};
