import{u as B,a as V}from"./index-Mk3cYYfI.js";import{J as q,r as b,d as g,k as P,D,G as l,a0 as S,R as I,F as N,H as o,a9 as m,a5 as v,ag as $,aq as A,a1 as i,Y as f,Z as h,a6 as R}from"./vue-vendor-DZ6ShR-l.js";import"./vendor-fvIX-KvJ.js";const J={__name:"CartView",setup(T){const{apiAuth:c}=V(),n=q(),u=B(),p=I(),s=b([]),y=[{align:"center",sortable:!1,value:"name"},{title:"書本圖片",key:"book.image"},{title:"書本名稱",key:"book.title"},{title:"單價",key:"book.retailPrice"},{title:"數量",key:"quantity"},{title:"總價",key:"total",value:t=>t.book.retailPrice*t.quantity},{title:"操作",key:"action"}],C=g(()=>s.value.reduce((t,e)=>t+e.quantity*e.book.retailPrice,0)),d=async(t,e)=>{if(!u.isLogin){p.push("/login");return}try{const{data:a}=await c.patch("/users/cart",{book:t,quantity:e});u.cart=a.result,n({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}});const r=s.value.findIndex(w=>w.book._id===t);s.value[r].quantity+=e,s.value[r].quantity<=0&&s.value.splice(r,1)}catch(a){const r=a?.response?.data?.message||"發生錯誤，請稍後再試";n({text:r,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}},_=g(()=>s.value.length>0),k=b(!1),x=async()=>{k.value=!0;try{await c.post("/orders"),u.cart=0,p.push("/orders"),n({text:"結帳成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(t){const e=t?.response?.data?.message||"發生錯誤，請稍後再試";n({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}k.value=!1};return P(async()=>{try{const{data:t}=await c.get("/users/cart");s.value.push(...t.result)}catch(t){const e=t?.response?.data?.message||"發生錯誤，請稍後再試";n({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),(t,e)=>(N(),D(S,null,{default:l(()=>[o(m,{cols:"12"},{default:l(()=>e[0]||(e[0]=[v("h1",null,"購物車",-1)])),_:1,__:[0]}),o($),o(m,{cols:"12"},{default:l(()=>[o(A,{items:s.value,headers:y},{"item.book.image":l(({item:a})=>[o(R,{src:a.book.image,alt:"Book Image","max-height":"100","max-width":"60"},null,8,["src"])]),"item.quantity":l(({item:a})=>[o(i,{variant:"text",icon:"mdi-minus",color:"red",onClick:r=>d(a.book._id,-1)},null,8,["onClick"]),f(h(a.quantity),1),o(i,{variant:"text",icon:"mdi-plus",color:"green",onClick:r=>d(a.book._id,1)},null,8,["onClick"])]),"item.action":l(({item:a})=>[o(i,{variant:"text",icon:"mdi-delete",color:"red",onClick:r=>d(a.book._id,a.quantity*-1)},null,8,["onClick"])]),_:2},1032,["items"])]),_:1}),o(m,{class:"text-center",cols:"12"},{default:l(()=>[v("p",null,"總金額: "+h(C.value),1),o(i,{color:"green",disabled:!_.value,loading:k.value,onClick:x},{default:l(()=>e[1]||(e[1]=[f("結帳",-1)])),_:1,__:[1]},8,["disabled","loading"])]),_:1})]),_:1}))}};export{J as default};
