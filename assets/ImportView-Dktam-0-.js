import{d as g,D as ee,n as l,v as E,h as ae,w as le,a1 as I,a2 as t,a3 as B,y as L,ag as te,P as oe,ae as se,u as r,a8 as G,a6 as U}from"./vue-vendor-BLj5oUxN.js";import{c as re,a as q,d as ue}from"./index.esm-Czkp3GW_.js";import{u as ne,a as f}from"./vee-validate-Dn-W1gkU.js";import{y as ie,z as O,A as de,B as me,s as ce,w as pe,v as J,I as x,H as $,V as ve,r as fe,i as D,E as ge,G as be,aa as Ve}from"./index-Ct63UvUN.js";import{V as ye}from"./VContainer-BKDADTkO.js";import{V as R}from"./VRow-BlMyHqYR.js";import{V as C}from"./VCol-DYv38b4a.js";import{V as he}from"./VForm-DYeKozmq.js";import{V as K,m as ke,a as xe}from"./VChip-DVNNT57J.js";import{g as Ce,p as we,C as Pe,f as Ie,ad as Be,o as Ue}from"./vuetify-vendor-BJLvFpJU.js";import{V as Re}from"./VTextarea-Bc5Izp79.js";import"./VSelectionControl-CCNJ0nGE.js";const Me=we({...me(),...Ue(ke(),["inline"])},"VCheckbox"),Se=Ce()({name:"VCheckbox",inheritAttrs:!1,props:Me(),emits:{"update:modelValue":n=>!0,"update:focused":n=>!0},setup(n,_){let{attrs:i,slots:M}=_;const d=Pe(n,"modelValue"),{isFocused:p,focus:m,blur:c}=ie(n),u=g(),b=ee();return Ie(()=>{const[w,j]=Be(i),T=O.filterProps(n),S=K.filterProps(n);return l(O,E({ref:u,class:["v-checkbox",n.class]},w,T,{modelValue:d.value,"onUpdate:modelValue":v=>d.value=v,id:n.id||`checkbox-${b}`,focused:p.value,style:n.style}),{...M,default:v=>{let{id:V,messagesId:y,isDisabled:h,isReadonly:P,isValid:k}=v;return l(K,E(S,{id:V.value,"aria-describedby":y.value,disabled:h.value,readonly:P.value},j,{error:k.value===!1,modelValue:d.value,"onUpdate:modelValue":A=>d.value=A,onFocus:m,onBlur:c}),M)}})}),de({},u)}}),Ge={__name:"ImportView",setup(n){const{apiAuth:_}=pe(),i=ce(),M=g(!1),d=g(!1),p=g(""),m=g(""),c=g(null),u=g(""),b=g(!1),w=ae(()=>u.value==="upload"&&c.value?URL.createObjectURL(c.value):u.value==="api"&&m.value?m.value:null),j=re({title:q().required("缺少商品名稱"),publisher:q().required("缺少出版者"),retailPrice:ue().typeError("書籍價格格式錯誤").required("缺少書籍價格").min(0,"書籍價格不能小於 0"),description:q().required("缺少簡介")}),{handleSubmit:T,resetForm:S}=ne({validationSchema:j,initialValues:{title:"",authors:"",publisher:"",retailPrice:"",categories:"",description:"",image:"",maturityRating:""}}),v=f("title"),V=f("authors"),y=f("publisher"),h=f("retailPrice"),P=f("categories"),k=f("description"),A=f("image"),H=f("maturityRating");le(b,o=>{H.value.value=o?"MATURE":"NOT_MATURE"});const W=o=>{const e=o.target.files[0];if(e){if(!["image/jpeg","image/png","image/jpg"].includes(e.type)){i({text:"只支援 JPG 和 PNG 格式",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),o.target.value="";return}if(e.size>1024*1024){i({text:"檔案大小不能超過 1MB",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),o.target.value="";return}c.value=e,u.value="upload",i({text:"圖片選取成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}},F=()=>{c.value=null,m.value="",u.value="",A.value.value="",document.querySelector('input[type="file"]')&&(document.querySelector('input[type="file"]').value="")},Q=()=>{S(),F(),p.value="",b.value=!1},X=(o,e=null)=>{const a=new FormData;return Object.keys(o).forEach(s=>{o[s]!==null&&o[s]!==void 0&&o[s]!==""&&a.append(s,o[s])}),e&&a.append("image",e),a},Y=T(async o=>{d.value=!0;try{let e;const a={};u.value==="upload"&&c.value?(console.log("準備提交含用戶圖片的資料..."),e=X(o,c.value),a["Content-Type"]="multipart/form-data"):(console.log("準備提交 JSON 資料..."),e={...o,image:u.value==="api"&&m.value?m.value:""},a["Content-Type"]="application/json"),console.log("準備提交數據:",e);const s=await _.post("/books",e,{headers:a});console.log("書籍創建成功:",s.data),i({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),Q()}catch(e){console.error("提交失敗:",e),console.error("錯誤詳情:",e.response?.data);const a=e?.response?.data?.message||"發生錯誤，請稍後再試";i({text:a,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}finally{d.value=!1}}),z=async()=>{if(p.value.trim())try{const o=/^\d{10}(\d{3})?$/.test(p.value),e=encodeURIComponent(p.value.trim()),{data:a}=await Ve.get(`https://www.googleapis.com/books/v1/volumes?q=${o?"isbn":"intitle"}:${e}`);if(console.log("Google Books API 回應:",a),a&&a.items&&a.items.length>0){const s=a.items[0].volumeInfo,N=a.items[0].saleInfo;v.value.value=s.title||"",V.value.value=s.authors?s.authors.join(", "):"",y.value.value=s.publisher||"",h.value.value=N.retailPrice?N.retailPrice.amount:"",P.value.value=s.categories?s.categories.join(", "):"",k.value.value=s.description||"";const Z=s.maturityRating||"";b.value=Z==="MATURE",s.imageLinks&&s.imageLinks.thumbnail?(m.value=s.imageLinks.thumbnail.replace("http://","https://").replace("img=1&zoom=1","img=2").replace("edge=curl",""),u.value="api",A.value.value=m.value,c.value=null,document.querySelector('input[type="file"]')&&(document.querySelector('input[type="file"]').value="")):F(),i({text:"引入成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}else i({text:"查無此書",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}catch(o){console.error("搜尋書籍錯誤:",o);const e=o?.response?.data?.message||"查無此書";i({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),S(),F()}};return(o,e)=>(B(),I(ye,null,{default:t(()=>[l(R,null,{default:t(()=>[l(C,{cols:"12"},{default:t(()=>e[9]||(e[9]=[L("h1",{class:"text-center"},"引入書籍",-1)])),_:1,__:[9]})]),_:1}),l(J,null,{default:t(()=>[l(R,null,{default:t(()=>[l(C,null,{default:t(()=>[l(x,{class:"mx-auto mt-5",modelValue:p.value,"onUpdate:modelValue":e[0]||(e[0]=a=>p.value=a),density:"comfortable","menu-icon":"",placeholder:"請輸入書籍名稱或13碼的isbn進行搜尋","prepend-inner-icon":"mdi-magnify",rounded:"",theme:"light",variant:"solo",style:oe({width:M.value?"100%":"500px"}),"onClick:append":z,onKeydown:te(z,["enter"])},null,8,["modelValue","style"])]),_:1})]),_:1})]),_:1}),l(R,null,{default:t(()=>[l(C,{class:"d-flex justify-center",cols:"12"},{default:t(()=>[l(he,{disabled:d.value,onSubmit:se(r(Y),["prevent"])},{default:t(()=>[l($,null,{default:t(()=>[l(R,{class:"flex justify-center align-center"},{default:t(()=>[l(C,null,{default:t(()=>[l($,{class:"d-flex justify-center align-center flex-column ml-4",outlined:"",style:{"min-height":"500px","min-width":"400px"}},{default:t(()=>[w.value?(B(),I(ve,{key:0,src:w.value,width:"350px",height:"500px",cover:""},null,8,["src"])):(B(),I(fe,{key:1,class:"mb-3",size:"100",color:"grey-lighten-2"},{default:t(()=>e[10]||(e[10]=[U("mdi-image-outline",-1)])),_:1,__:[10]})),u.value==="upload"?(B(),I(xe,{key:2,class:"mb-3",color:"green",size:"small"},{default:t(()=>e[11]||(e[11]=[U("上傳圖片",-1)])),_:1,__:[11]})):G("",!0),l(D,{class:"mt-1",color:"primary","prepend-icon":"mdi-upload",onClick:e[1]||(e[1]=a=>o.$refs.fileInput.click()),disabled:d.value},{default:t(()=>e[12]||(e[12]=[U("上傳自己的圖片",-1)])),_:1,__:[12]},8,["disabled"]),L("input",{ref:"fileInput",type:"file",accept:"image/*",style:{display:"none"},onChange:W},null,544),w.value?(B(),I(D,{key:3,class:"mt-2",color:"error",variant:"text",size:"small",onClick:F},{default:t(()=>e[13]||(e[13]=[U("清除圖片",-1)])),_:1,__:[13]})):G("",!0)]),_:1})]),_:1}),l(C,{class:"me-5 mt-5"},{default:t(()=>[l(ge),l(x,{label:"書本名稱",modelValue:r(v).value.value,"onUpdate:modelValue":e[2]||(e[2]=a=>r(v).value.value=a),width:300,"error-messages":r(v).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"作者",modelValue:r(V).value.value,"onUpdate:modelValue":e[3]||(e[3]=a=>r(V).value.value=a),"error-messages":r(V).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"出版者",modelValue:r(y).value.value,"onUpdate:modelValue":e[4]||(e[4]=a=>r(y).value.value=a),"error-messages":r(y).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"價格",modelValue:r(h).value.value,"onUpdate:modelValue":e[5]||(e[5]=a=>r(h).value.value=a),"error-messages":r(h).errorMessage.value},null,8,["modelValue","error-messages"]),l(x,{label:"分類",modelValue:r(P).value.value,"onUpdate:modelValue":e[6]||(e[6]=a=>r(P).value.value=a)},null,8,["modelValue"]),l($,{class:"pa-1 mb-6",outlined:"",style:{"background-color":"rgba(0,0,0,0.04)"}},{default:t(()=>[l(Se,{label:"成人內容 (18+)",modelValue:b.value,"onUpdate:modelValue":e[7]||(e[7]=a=>b.value=a),"hide-details":""},null,8,["modelValue"])]),_:1}),l(Re,{label:"簡介",modelValue:r(k).value.value,"onUpdate:modelValue":e[8]||(e[8]=a=>r(k).value.value=a),"error-messages":r(k).errorMessage.value},null,8,["modelValue","error-messages"]),l(be)]),_:1})]),_:1}),l(R,{class:"text-center mb-5",cols:"12"},{default:t(()=>[l(C,null,{default:t(()=>[l(J),l(D,{color:"green",type:"submit",loading:d.value},{default:t(()=>e[14]||(e[14]=[U("送出",-1)])),_:1,__:[14]},8,["loading"])]),_:1})]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1})]),_:1}))}};export{Ge as default};
