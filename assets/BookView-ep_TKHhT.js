import{j as t,P as W,n as X,b as k,ac as M,af as Y,H as ee,a7 as P,a2 as o,F as I,a3 as w,u as d,a6 as C,Z as p,l as i,a1 as A,a8 as te,ae as D,ad as oe}from"./vue-vendor-DIljl67C.js";import{u as le}from"./vee-validate-7KorKqsb.js";import{m as ae,t as q,s as N,w as j,J as se,V as ne,G as R,i as h,H as T,E as ue,K as re}from"./index-CMCGl2Or.js";import{h as ie,i as de,c as ce,q as me}from"./icons-BFoqPsYi.js";import{V as fe}from"./VContainer-BpspjPie.js";import{V as f}from"./VRow-BvayA_Gc.js";import{V as n}from"./VCol-DB2KSHUE.js";import{V as U}from"./VForm-B_56vQWn.js";import{V as L}from"./VRating-BWq-LMC1.js";import{V as H}from"./VTextarea-CaxvLfDj.js";import{V as pe,a as ve,b as ge,c as be}from"./VList-M0qda9_D.js";import{g as Ve,p as _e,f as ke,a as ye}from"./vuetify-vendor-BSJ2BONf.js";import"./VDivider-BGXdOhCk.js";const we=_e({start:Boolean,end:Boolean,...ye(),...ae()},"VListItemAction"),z=Ve()({name:"VListItemAction",props:we(),setup(c,v){let{slots:b}=v;return ke(()=>t(c.tag,{class:X(["v-list-item-action",{"v-list-item-action--start":c.start,"v-list-item-action--end":c.end},c.class]),style:W(c.style)},b)),{}}});function Ce(c){const{apiAuth:v}=j(),b=q(),m=k(!1),y=N(),V=M();return{isFavorite:m,checkFavoriteStatus:async()=>{try{const{data:r}=await v.get("/users/favorite",{params:{bookId:c}});m.value=r.result.includes(c)}catch(r){console.error(r),m.value=!1}},addFavorite:async()=>{if(!b.isLogin){V.push("/login");return}m.value=!m.value;try{const{data:r}=await v.post("/users/favorite",{bookId:c,isFavorite:m.value});b.favorite=r.result,y({text:m.value?"已加入我的最愛":"已移除我的最愛",showCloseButton:!1,snackbarProps:{timeout:2e3,color:m.value?"green":"red",location:"bottom"}})}catch(r){console.error(r),r.response&&r.response.status===401?V.push("/login"):y({text:"發生錯誤，請稍後再試",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}}}const he=["innerHTML"],xe={key:1},ze={__name:"BookView",setup(c){const v=Y(),b=M(),{api:m,apiAuth:y}=j(),V=k(!1),x=k(!1),g=N(),r=q(),_=k({usersId:"",rating:0,comment:""}),F=k(!1),{handleSubmit:S}=le({initialValues:{usersId:"",rating:0,comment:""}}),s=k({_id:"",image:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",buyLink:"",description:"",reviews:[]}),u=k([]),{isFavorite:B,checkFavoriteStatus:E,addFavorite:G}=Ce(v.params.id),J=()=>{F.value=!1},$=S(async a=>{if(console.log(_.value),!r.isLogin){b.push("/login"),g({text:"請先登入",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}});return}try{const{data:e}=await y.post(`/books/${v.params.id}/reviews`,{rating:_.value.rating,conmment:_.value.comment});e&&e.result&&s.value.reviews.push(e.result),g({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(e){console.log(e);const l=e?.response?.data?.message||"發生錯誤，請稍後再試";g({text:l,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),K=a=>{if(a){const e=s.value.reviews.find(l=>l._id===a);u.value.id=e._id,u.value.rating=e.rating,u.value.comment=e.comment,u.value.bookId=s.value._id,console.log(u.value.bookId)}F.value=!0},Z=S(async a=>{try{console.log(u.value),console.log("Form values:",a);const e=new FormData;for(const l in a)e.append(l,u.value[l]||a[l]);F.value===""&&await y.patch(`/books/${u.value.bookId}/reviews/${u.value.id}`,e),console.log("FormData entries:",...e.entries()),g({text:"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(e){console.log(e);const l=e?.response?.data?.message||"發生錯誤，請稍後再試";g({text:l,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}J()});console.log(u.value),ee(async()=>{try{const{data:a}=await m.get(`/books/${v.params.id}`);s.value._id=a.result._id,s.value.image=a.result.image,s.value.title=a.result.title,s.value.authors=a.result.authors,s.value.publisher=a.result.publisher,s.value.retailPrice=a.result.retailPrice,s.value.categories=a.result.categories,s.value.buyLink=a.result.buyLink;let e=a.result.description.replace(/(※|★|◆|✓|●|▓|▌|￭|──|【)/g,"<br>$1");e=e.replace(/(】)/g,"$1<br>"),e=e.replace(new RegExp("(?<=──[^,]*?)(?=,)","g"),"<br>$1"),s.value.description=e,s.value.reviews=a.result.reviews,document.title=`書評網 | ${s.value.title}`,await E()}catch(a){console.log(a)}});const O=async()=>{if(!r.isLogin){b.push("/login");return}try{const{data:a}=await y.patch("/users/cart",{book:s.value._id,quantity:1});r.cart=a.result,g({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(a){const e=a?.response?.data?.message||"發生錯誤，請稍後再試";g({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}};return(a,e)=>(w(),P(I,null,[t(fe,null,{default:o(()=>[t(f,null,{default:o(()=>[t(n,{cols:"12",md:"3",style:{position:"sticky"},top:"0"},{default:o(()=>[t(ne,{src:s.value.image},null,8,["src"]),t(R,null,{default:o(()=>[t(f,{class:"justify-center align-center"},{default:o(()=>[t(n,{cols:"6"},{default:o(()=>[t(h,{"prepend-icon":d(B)?d(ie):d(de),color:d(B)?"red":"blue",onClick:d(G)},{default:o(()=>[C(p(d(B)?"取消最愛":"加入最愛"),1)]),_:1},8,["prepend-icon","color","onClick"])]),_:1}),t(n,{cols:"6"},{default:o(()=>[t(h,{color:"primary","prepend-icon":d(ce),onClick:O},{default:o(()=>e[7]||(e[7]=[C("加入購物車",-1)])),_:1,__:[7]},8,["prepend-icon"])]),_:1})]),_:1})]),_:1})]),_:1}),t(n,{cols:"12",md:"9"},{default:o(()=>[i("h1",null,p(s.value.title),1),i("h2",null,p(s.value.authors),1),t(f,null,{default:o(()=>[t(n,{cols:"auto"},{default:o(()=>e[8]||(e[8]=[i("h3",null,"出版者:",-1)])),_:1,__:[8]}),t(n,null,{default:o(()=>[i("p",null,p(s.value.publisher),1)]),_:1})]),_:1}),t(f,null,{default:o(()=>[t(n,{cols:"auto"},{default:o(()=>e[9]||(e[9]=[i("h3",null,"價格:",-1)])),_:1,__:[9]}),t(n,null,{default:o(()=>[i("p",null,"$"+p(s.value.retailPrice),1)]),_:1})]),_:1}),t(f,null,{default:o(()=>[t(n,{cols:"auto"},{default:o(()=>e[10]||(e[10]=[i("h3",null,"分類:",-1)])),_:1,__:[10]}),t(n,null,{default:o(()=>[i("p",null,p(s.value.categories),1)]),_:1})]),_:1}),t(f,null,{default:o(()=>[t(n,{cols:"auto"},{default:o(()=>[e[11]||(e[11]=i("h3",null,"簡介:",-1)),x.value?(w(),P("p",{key:0,innerHTML:s.value.description},null,8,he)):(w(),P("p",xe,p(s.value.description.substring(0,500)),1))]),_:1,__:[11]}),t(n,{class:"text-center"},{default:o(()=>[s.value.description.length>100?(w(),A(h,{key:0,color:"#4d4637",onClick:e[0]||(e[0]=l=>x.value=!x.value),icon:x.value?"mdi-chevron-up":"mdi-chevron-down"},null,8,["icon"])):te("",!0)]),_:1})]),_:1}),t(f,null,{default:o(()=>[t(n,{cols:"12"},{default:o(()=>[e[13]||(e[13]=i("h3",null,"新增書評:",-1)),t(U,{disabled:V.value,onSubmit:D(d($),["prevent"])},{default:o(()=>[t(L,{modelValue:_.value.rating,"onUpdate:modelValue":e[1]||(e[1]=l=>_.value.rating=l),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),t(H,{modelValue:_.value.comment,"onUpdate:modelValue":e[2]||(e[2]=l=>_.value.comment=l),label:"你的書評",required:""},null,8,["modelValue"]),t(h,{color:"#4d4637",type:"submit",loading:V.value},{default:o(()=>e[12]||(e[12]=[C("提交",-1)])),_:1,__:[12]},8,["loading"])]),_:1},8,["disabled","onSubmit"])]),_:1,__:[13]})]),_:1}),t(f,null,{default:o(()=>[t(n,{cols:"12"},{default:o(()=>[e[14]||(e[14]=i("h3",null,"書評:",-1)),t(pe,null,{default:o(()=>[(w(!0),P(I,null,oe(s.value.reviews,l=>(w(),A(ve,{key:l._id},{default:o(()=>[t(T,null,{default:o(()=>[t(f,null,{default:o(()=>[t(n,{cols:"auto"},{default:o(()=>[t(ge,{style:{fontSize:"30px"}},{default:o(()=>[C(p(l.user.account),1)]),_:2},1024)]),_:2},1024),t(n,{cols:"auto"},{default:o(()=>[t(z,null,{default:o(()=>[t(L,{modelValue:l.rating,"onUpdate:modelValue":Q=>l.rating=Q,color:"#4d4637 darken-3",size:"25",readonly:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),t(f,null,{default:o(()=>[t(n,{cols:"auto"},{default:o(()=>[t(be,{class:"mb-5",style:{fontSize:"20px"}},{default:o(()=>[C(p(l.comment),1)]),_:2},1024)]),_:2},1024),t(n,{class:"d-flex justify-end"},{default:o(()=>[t(z,null,{default:o(()=>[t(h,{icon:d(me),color:"#4d4637",onClick:()=>K(l._id)},null,8,["icon","onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1,__:[14]})]),_:1})]),_:1})]),_:1})]),_:1}),t(se,{modelValue:F.value,"onUpdate:modelValue":e[6]||(e[6]=l=>F.value=l),"max-width":"290"},{default:o(()=>[t(U,{disabled:V.value,onSubmit:D(d($),["prevent"])},{default:o(()=>[t(T,null,{default:o(()=>[t(ue,null,{default:o(()=>e[15]||(e[15]=[i("h3",null,"編輯書評",-1)])),_:1,__:[15]}),t(re,null,{default:o(()=>[t(L,{modelValue:u.value.rating,"onUpdate:modelValue":e[3]||(e[3]=l=>u.value.rating=l),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),t(H,{modelValue:u.value.comment,"onUpdate:modelValue":e[4]||(e[4]=l=>u.value.comment=l),label:"你的書評",required:""},null,8,["modelValue"])]),_:1}),t(R,null,{default:o(()=>[t(h,{color:"#4d4637",onClick:e[5]||(e[5]=l=>d(Z)(a.review)),loading:V.value},{default:o(()=>e[16]||(e[16]=[C("修正",-1)])),_:1,__:[16]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64))}};export{ze as default};
