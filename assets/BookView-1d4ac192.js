import{p as W,m as Z,a as ee,g as te,u as ae,c as e,Y as j,x as y,X as H,a3 as E,ab as J,A as oe,_ as P,a0 as t,az as le,a2 as D,aA as se,a5 as C,V as ne,ao as R,J as x,a7 as k,a8 as B,aa as f,an as c,$ as T,a1 as ue,ay as U,a6 as re,aq as q,al as ie,aB as ce}from"./index-6851ac4d.js";import{u as de}from"./vee-validate.esm-238e7707.js";import{V as me}from"./VContainer-622fefbb.js";import{V as p}from"./VRow-4fc3757b.js";import{V as u}from"./VCol-b84c0405.js";import{V as z}from"./VForm-fda22642.js";import{V as $}from"./VRating-941bbe27.js";import{V as M}from"./VTextarea-e9691060.js";import{b as pe,V as fe,a as ve,c as _e}from"./VList-60964e8e.js";import"./VDivider-1adb3401.js";const ge=W({start:Boolean,end:Boolean,...Z(),...ee()},"VListItemAction"),N=te()({name:"VListItemAction",props:ge(),setup(d,v){let{slots:g}=v;return ae(()=>e(d.tag,{class:["v-list-item-action",{"v-list-item-action--start":d.start,"v-list-item-action--end":d.end},d.class],style:d.style},g)),{}}});function be(d){const{apiAuth:v}=J(),g=j(),m=y(!1),w=H(),b=E();return{isFavorite:m,checkFavoriteStatus:async()=>{try{const{data:i}=await v.get("/users/favorite",{params:{bookId:d}});m.value=i.result.includes(d)}catch(i){console.error(i),m.value=!1}},addFavorite:async()=>{if(!g.isLogin){b.push("/login");return}m.value=!m.value;try{const{data:i}=await v.post("/users/favorite",{bookId:d,isFavorite:m.value});g.favorite=i.result,w({text:m.value?"已加入我的最愛":"已移除我的最愛",showCloseButton:!1,snackbarProps:{timeout:2e3,color:m.value?"green":"red",location:"bottom"}})}catch(i){console.error(i),i.response&&i.response.status===401?b.push("/login"):w({text:"發生錯誤，請稍後再試",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}}}const Ve=c("h3",null,"出版者:",-1),he=c("h3",null,"價格:",-1),ke=c("h3",null,"分類:",-1),ye=c("h3",null,"簡介:",-1),we=["innerHTML"],Ce={key:1},xe=c("h3",null,"新增書評:",-1),Be=c("h3",null,"書評:",-1),Fe=c("h3",null,"編輯書評",-1),qe={__name:"BookView",setup(d){const v=se(),g=E(),{api:m,apiAuth:w}=J(),b=y(!1),F=y(!1),_=H(),i=j(),V=y({usersId:"",rating:0,comment:""}),L=y(!1),{handleSubmit:A}=de({initialValues:{usersId:"",rating:0,comment:""}}),l=y({_id:"",image:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",buyLink:"",description:"",reviews:[]}),r=y([]),{isFavorite:S,checkFavoriteStatus:X,addFavorite:Y}=be(v.params.id),G=()=>{L.value=!1},I=A(async s=>{var a,o;if(console.log(V.value),!i.isLogin){g.push("/login"),_({text:"請先登入",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}});return}try{const{data:n}=await w.post(`/books/${v.params.id}/reviews`,{rating:V.value.rating,conmment:V.value.comment});n&&n.result&&l.value.reviews.push(n.result),_({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(n){console.log(n);const h=((o=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:o.message)||"發生錯誤，請稍後再試";_({text:h,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),K=s=>{if(s){const a=l.value.reviews.find(o=>o._id===s);r.value.id=a._id,r.value.rating=a.rating,r.value.comment=a.comment,r.value.bookId=l.value._id,console.log(r.value.bookId)}L.value=!0},O=A(async s=>{var a,o;try{console.log(r.value),console.log("Form values:",s);const n=new FormData;for(const h in s)n.append(h,r.value[h]||s[h]);L.value===""&&await w.patch(`/books/${r.value.bookId}/reviews/${r.value.id}`,n),console.log("FormData entries:",...n.entries()),_({text:"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(n){console.log(n);const h=((o=(a=n==null?void 0:n.response)==null?void 0:a.data)==null?void 0:o.message)||"發生錯誤，請稍後再試";_({text:h,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}G()});console.log(r.value),oe(async()=>{try{const{data:s}=await m.get(`/books/${v.params.id}`);l.value._id=s.result._id,l.value.image=s.result.image,l.value.title=s.result.title,l.value.authors=s.result.authors,l.value.publisher=s.result.publisher,l.value.retailPrice=s.result.retailPrice,l.value.categories=s.result.categories,l.value.buyLink=s.result.buyLink;let a=s.result.description.replace(/(※|★|◆|✓|●|▓|▌|￭|──|【)/g,"<br>$1");a=a.replace(/(】)/g,"$1<br>"),a=a.replace(new RegExp("(?<=──[^,]*?)(?=,)","g"),"<br>$1"),l.value.description=a,l.value.reviews=s.result.reviews,document.title=`書評網 | ${l.value.title}`,await X()}catch(s){console.log(s)}});const Q=async()=>{var s,a;if(!i.isLogin){g.push("/login");return}try{const{data:o}=await w.patch("/users/cart",{book:l.value._id,quantity:1});i.cart=o.result,_({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(o){const n=((a=(s=o==null?void 0:o.response)==null?void 0:s.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";_({text:n,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}};return(s,a)=>(C(),P(D,null,[e(me,null,{default:t(()=>[e(p,null,{default:t(()=>[e(u,{cols:"12",md:"3",style:{position:"sticky"},top:"0"},{default:t(()=>[e(ne,{src:l.value.image},null,8,["src"]),e(R,null,{default:t(()=>[e(p,{class:"justify-center align-center"},{default:t(()=>[e(u,{cols:"6"},{default:t(()=>[e(x,{"prepend-icon":k(S)?"mdi-heart-minus":"mdi-heart-plus",color:k(S)?"red":"blue",onClick:k(Y)},{default:t(()=>[B(f(k(S)?"取消最愛":"加入最愛"),1)]),_:1},8,["prepend-icon","color","onClick"])]),_:1}),e(u,{cols:"6"},{default:t(()=>[e(x,{color:"primary","prepend-icon":"mdi-cart",onClick:Q},{default:t(()=>[B("加入購物車")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(u,{cols:"12",md:"9"},{default:t(()=>[c("h1",null,f(l.value.title),1),c("h2",null,f(l.value.authors),1),e(p,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[Ve]),_:1}),e(u,null,{default:t(()=>[c("p",null,f(l.value.publisher),1)]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[he]),_:1}),e(u,null,{default:t(()=>[c("p",null,"$"+f(l.value.retailPrice),1)]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[ke]),_:1}),e(u,null,{default:t(()=>[c("p",null,f(l.value.categories),1)]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[ye,F.value?(C(),P("p",{key:0,innerHTML:l.value.description},null,8,we)):(C(),P("p",Ce,f(l.value.description.substring(0,500)),1))]),_:1}),e(u,{class:"text-center"},{default:t(()=>[l.value.description.length>100?(C(),T(x,{key:0,color:"#4d4637",onClick:a[0]||(a[0]=o=>F.value=!F.value),icon:F.value?"mdi-chevron-up":"mdi-chevron-down"},null,8,["icon"])):ue("",!0)]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(u,{cols:"12"},{default:t(()=>[xe,e(z,{disabled:b.value,onSubmit:U(k(I),["prevent"])},{default:t(()=>[e($,{modelValue:V.value.rating,"onUpdate:modelValue":a[1]||(a[1]=o=>V.value.rating=o),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(M,{modelValue:V.value.comment,"onUpdate:modelValue":a[2]||(a[2]=o=>V.value.comment=o),label:"你的書評",required:""},null,8,["modelValue"]),e(x,{color:"#4d4637",type:"submit",loading:b.value},{default:t(()=>[B("提交")]),_:1},8,["loading"])]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1}),e(p,null,{default:t(()=>[e(u,{cols:"12"},{default:t(()=>[Be,e(pe,null,{default:t(()=>[(C(!0),P(D,null,re(l.value.reviews,o=>(C(),T(fe,{key:o._id},{default:t(()=>[e(q,null,{default:t(()=>[e(p,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[e(ve,{style:{fontSize:"30px"}},{default:t(()=>[B(f(o.user.account),1)]),_:2},1024)]),_:2},1024),e(u,{cols:"auto"},{default:t(()=>[e(N,null,{default:t(()=>[e($,{modelValue:o.rating,"onUpdate:modelValue":n=>o.rating=n,color:"#4d4637 darken-3",size:"25",readonly:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),e(p,null,{default:t(()=>[e(u,{cols:"auto"},{default:t(()=>[e(_e,{class:"mb-5",style:{fontSize:"20px"}},{default:t(()=>[B(f(o.comment),1)]),_:2},1024)]),_:2},1024),e(u,{class:"d-flex justify-end"},{default:t(()=>[e(N,null,{default:t(()=>[e(x,{icon:"mdi-pencil",color:"#4d4637",onClick:()=>K(o._id)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(le,{modelValue:L.value,"onUpdate:modelValue":a[6]||(a[6]=o=>L.value=o),"max-width":"290"},{default:t(()=>[e(z,{disabled:b.value,onSubmit:U(k(I),["prevent"])},{default:t(()=>[e(q,null,{default:t(()=>[e(ie,null,{default:t(()=>[Fe]),_:1}),e(ce,null,{default:t(()=>[e($,{modelValue:r.value.rating,"onUpdate:modelValue":a[3]||(a[3]=o=>r.value.rating=o),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),e(M,{modelValue:r.value.comment,"onUpdate:modelValue":a[4]||(a[4]=o=>r.value.comment=o),label:"你的書評",required:""},null,8,["modelValue"])]),_:1}),e(R,null,{default:t(()=>[e(x,{color:"#4d4637",onClick:a[5]||(a[5]=o=>k(O)(s.review)),loading:b.value},{default:t(()=>[B("修正")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64))}};export{qe as default};
