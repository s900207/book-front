import{U as T,x,Z as j,$ as s,af as A,a4 as N,c as e,au as m,bH as z,aB as E,a7 as D,aa as B,ax as K,a6 as o,as as P,V as O,ap as H,ar as Y,a9 as Z,a8 as G,ae as J,bI as Q}from"./index-ec73ba28.js";import{c as W,a as k,d as X}from"./index.esm-3d8b24aa.js";import{u as ee,a as u}from"./vee-validate.esm-1217ed01.js";import{V as ae}from"./VContainer-e4d82e7d.js";import{V as d}from"./VCol-dc2d63ff.js";import{V as y}from"./VRow-6455967c.js";import{V as le}from"./VForm-3c0515f3.js";import{V as te}from"./VTextarea-d112d4e3.js";const oe=J("h1",{class:"text-center"},"引入書籍",-1),pe={__name:"ImportView",setup(se){const{apiAuth:_}=A(),h=T(),M=x(!1),I=x(!1),c=x(""),R=W({title:k().required("缺少商品名稱"),publisher:k().required("缺少出版者"),retailPrice:X().typeError("商品價格格式錯誤").required("缺少商品價格").min(0,"商品價格不能小於 0"),description:k().required("缺少簡介")}),{handleSubmit:S}=ee({validationSchema:R,initialValues:{title:"",authors:"",publisher:"",retailPrice:"",categories:"",description:"",image:"",maturityRating:"",buyLink:""}}),v=u("title"),p=u("authors"),f=u("publisher"),g=u("retailPrice"),w=u("categories"),b=u("description"),V=u("image"),F=u("maturityRating"),$=u("buyLink"),C=async()=>{var i,l;if(c.value.trim())try{const a=/^\d{10}(\d{3})?$/.test(c.value),r=encodeURIComponent(c.value.trim()),{data:t}=await Q.get(`https://www.googleapis.com/books/v1/volumes?q=${a?"isbn":"intitle"}:${r}`);console.log(t),t&&t.items&&t.items.length>0&&(v.value.value=t.items[0].volumeInfo.title,p.value.value=t.items[0].volumeInfo.authors,f.value.value=t.items[0].volumeInfo.publisher,g.value.value=t.items[0].saleInfo.retailPrice?t.items[0].saleInfo.retailPrice.amount:null,w.value.value=t.items[0].volumeInfo.categories,b.value.value=t.items[0].volumeInfo.description,V.value.value=t.items[0].volumeInfo.imageLinks.thumbnail.replace("http://","https://").replace("img=1&zoom=1","img=1&zoom=2").replace("edge=curl",""),F.value.value=t.items[0].volumeInfo.maturityRating,$.value.value=t.items[0].saleInfo.buyLink,h({text:"引入成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}))}catch(a){console.error(a);const r=((l=(i=a==null?void 0:a.response)==null?void 0:i.data)==null?void 0:l.message)||"查無此書";h({text:r,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}}),v.value.value="",p.value.value="",f.value.value="",g.value.value="",w.value.value="",b.value.value="",V.value.value=""}},L=S(async i=>{var l,a;console.log(i);try{const r=new FormData;for(const n in i)r.append(n,i[n]);if(V.value){const n=await fetch(V.value).then(U=>{if(!U.ok)throw new Error("無法獲取圖片");return U.blob()}),q=new File([n],"image.jpg",{type:n.type});r.append("image",q)}for(const n of r.entries())console.log(n[0]+": "+n[1]);const t=await _.post("https://api.cloudinary.com/v1_1/YOUR_CLOUD_NAME/image/upload",r,{headers:{"Content-Type":"multipart/form-data"}});t.data.secure_url&&r.append("imageUrl",t.data.secure_url),await _.post("/books",r),h({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(r){console.log(r);const t=((a=(l=r==null?void 0:r.response)==null?void 0:l.data)==null?void 0:a.message)||"發生錯誤，請稍後再試";h({text:t,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}});return(i,l)=>(N(),j(ae,null,{default:s(()=>[e(y,null,{default:s(()=>[e(d,{cols:"12"},{default:s(()=>[oe]),_:1})]),_:1}),e(B,null,{default:s(()=>[e(y,null,{default:s(()=>[e(d,null,{default:s(()=>[e(m,{class:"mx-auto mt-5",modelValue:c.value,"onUpdate:modelValue":l[0]||(l[0]=a=>c.value=a),density:"comfortable","menu-icon":"",placeholder:"請輸入書籍名稱或13碼的isbn進行搜尋",rounded:"",theme:"light",variant:"solo",style:z({width:M.value?"100%":"500px"}),"onClick:append":C,onKeydown:E(C,["enter"])},{"prepend-inner":s(()=>[e(D,{href:"#icon-magnify"})]),_:1},8,["modelValue","style"])]),_:1})]),_:1})]),_:1}),e(y,null,{default:s(()=>[e(d,{class:"d-flex justify-center",cols:"12"},{default:s(()=>[e(le,{disabled:I.value,onSubmit:K(o(L),["prevent"])},{default:s(()=>[e(P,null,{default:s(()=>[e(y,{class:"flex justify-center align-center"},{default:s(()=>[e(d,null,{default:s(()=>[e(P,{class:"d-flex justify-center align-center",outlined:""}),e(O,{src:o(V).value.value,width:"300px",cover:"",readonly:""},null,8,["src"])]),_:1}),e(d,{class:"me-2"},{default:s(()=>[e(H),e(m,{label:"書本名稱",modelValue:o(v).value.value,"onUpdate:modelValue":l[1]||(l[1]=a=>o(v).value.value=a),width:300,"error-messages":o(v).errorMessage.value},null,8,["modelValue","error-messages"]),e(m,{label:"作者",modelValue:o(p).value.value,"onUpdate:modelValue":l[2]||(l[2]=a=>o(p).value.value=a),"error-messages":o(p).errorMessage.value},null,8,["modelValue","error-messages"]),e(m,{label:"出版者",modelValue:o(f).value.value,"onUpdate:modelValue":l[3]||(l[3]=a=>o(f).value.value=a),"error-messages":o(f).errorMessage.value},null,8,["modelValue","error-messages"]),e(m,{label:"價格",modelValue:o(g).value.value,"onUpdate:modelValue":l[4]||(l[4]=a=>o(g).value.value=a),"error-messages":o(g).errorMessage.value},null,8,["modelValue","error-messages"]),e(m,{label:"分類",modelValue:o(w).value.value,"onUpdate:modelValue":l[5]||(l[5]=a=>o(w).value.value=a)},null,8,["modelValue"]),e(te,{label:"簡介",modelValue:o(b).value.value,"onUpdate:modelValue":l[6]||(l[6]=a=>o(b).value.value=a),"error-messages":o(b).errorMessage.value},null,8,["modelValue","error-messages"]),e(Y)]),_:1})]),_:1})]),_:1}),e(y,{class:"text-center mb-5",cols:"12"},{default:s(()=>[e(d,null,{default:s(()=>[e(B),e(Z,{color:"green",type:"submit",loading:I.value},{default:s(()=>[G("送出")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1})]),_:1})]),_:1}))}};export{pe as default};
