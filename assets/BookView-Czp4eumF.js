import{n as t,P as W,q as X,d as k,ac as H,af as Y,H as ee,a7 as B,a2 as l,F as I,a3 as w,u as _,a6 as C,Z as f,y as i,a1 as A,a8 as te,ae as D,ad as le}from"./vue-vendor-BLj5oUxN.js";import{u as oe}from"./vee-validate-Dn-W1gkU.js";import{m as ae,t as M,s as N,w as j,J as se,V as ne,G as R,i as h,H as T,E as ue,K as re}from"./index-Ct63UvUN.js";import{V as ie}from"./VContainer-BKDADTkO.js";import{V as m}from"./VRow-BlMyHqYR.js";import{V as n}from"./VCol-DYv38b4a.js";import{V as U}from"./VForm-DYeKozmq.js";import{V as P}from"./VRating-DKAwfr8C.js";import{V as z}from"./VTextarea-Bc5Izp79.js";import{V as de,a as ce,b as me,c as fe}from"./VList-7JITbm1I.js";import{g as pe,p as ve,f as ge,a as be}from"./vuetify-vendor-BJLvFpJU.js";import"./VDivider-BgotosWf.js";const Ve=ve({start:Boolean,end:Boolean,...be(),...ae()},"VListItemAction"),q=pe()({name:"VListItemAction",props:Ve(),setup(d,p){let{slots:g}=p;return ge(()=>t(d.tag,{class:X(["v-list-item-action",{"v-list-item-action--start":d.start,"v-list-item-action--end":d.end},d.class]),style:W(d.style)},g)),{}}});function _e(d){const{apiAuth:p}=j(),g=M(),c=k(!1),y=N(),b=H();return{isFavorite:c,checkFavoriteStatus:async()=>{try{const{data:r}=await p.get("/users/favorite",{params:{bookId:d}});c.value=r.result.includes(d)}catch(r){console.error(r),c.value=!1}},addFavorite:async()=>{if(!g.isLogin){b.push("/login");return}c.value=!c.value;try{const{data:r}=await p.post("/users/favorite",{bookId:d,isFavorite:c.value});g.favorite=r.result,y({text:c.value?"已加入我的最愛":"已移除我的最愛",showCloseButton:!1,snackbarProps:{timeout:2e3,color:c.value?"green":"red",location:"bottom"}})}catch(r){console.error(r),r.response&&r.response.status===401?b.push("/login"):y({text:"發生錯誤，請稍後再試",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}}}const ke=["innerHTML"],ye={key:1},De={__name:"BookView",setup(d){const p=Y(),g=H(),{api:c,apiAuth:y}=j(),b=k(!1),x=k(!1),v=N(),r=M(),V=k({usersId:"",rating:0,comment:""}),F=k(!1),{handleSubmit:S}=oe({initialValues:{usersId:"",rating:0,comment:""}}),s=k({_id:"",image:"",title:"",authors:"",publisher:"",retailPrice:"",categories:"",buyLink:"",description:"",reviews:[]}),u=k([]),{isFavorite:L,checkFavoriteStatus:E,addFavorite:G}=_e(p.params.id),J=()=>{F.value=!1},$=S(async a=>{if(console.log(V.value),!r.isLogin){g.push("/login"),v({text:"請先登入",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}});return}try{const{data:e}=await y.post(`/books/${p.params.id}/reviews`,{rating:V.value.rating,conmment:V.value.comment});e&&e.result&&s.value.reviews.push(e.result),v({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(e){console.log(e);const o=e?.response?.data?.message||"發生錯誤，請稍後再試";v({text:o,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),K=a=>{if(a){const e=s.value.reviews.find(o=>o._id===a);u.value.id=e._id,u.value.rating=e.rating,u.value.comment=e.comment,u.value.bookId=s.value._id,console.log(u.value.bookId)}F.value=!0},Z=S(async a=>{try{console.log(u.value),console.log("Form values:",a);const e=new FormData;for(const o in a)e.append(o,u.value[o]||a[o]);F.value===""&&await y.patch(`/books/${u.value.bookId}/reviews/${u.value.id}`,e),console.log("FormData entries:",...e.entries()),v({text:"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(e){console.log(e);const o=e?.response?.data?.message||"發生錯誤，請稍後再試";v({text:o,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}J()});console.log(u.value),ee(async()=>{try{const{data:a}=await c.get(`/books/${p.params.id}`);s.value._id=a.result._id,s.value.image=a.result.image,s.value.title=a.result.title,s.value.authors=a.result.authors,s.value.publisher=a.result.publisher,s.value.retailPrice=a.result.retailPrice,s.value.categories=a.result.categories,s.value.buyLink=a.result.buyLink;let e=a.result.description.replace(/(※|★|◆|✓|●|▓|▌|￭|──|【)/g,"<br>$1");e=e.replace(/(】)/g,"$1<br>"),e=e.replace(new RegExp("(?<=──[^,]*?)(?=,)","g"),"<br>$1"),s.value.description=e,s.value.reviews=a.result.reviews,document.title=`書評網 | ${s.value.title}`,await E()}catch(a){console.log(a)}});const O=async()=>{if(!r.isLogin){g.push("/login");return}try{const{data:a}=await y.patch("/users/cart",{book:s.value._id,quantity:1});r.cart=a.result,v({text:"新增成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}})}catch(a){const e=a?.response?.data?.message||"發生錯誤，請稍後再試";v({text:e,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}};return(a,e)=>(w(),B(I,null,[t(ie,null,{default:l(()=>[t(m,null,{default:l(()=>[t(n,{cols:"12",md:"3",style:{position:"sticky"},top:"0"},{default:l(()=>[t(ne,{src:s.value.image},null,8,["src"]),t(R,null,{default:l(()=>[t(m,{class:"justify-center align-center"},{default:l(()=>[t(n,{cols:"6"},{default:l(()=>[t(h,{"prepend-icon":_(L)?"mdi-heart-minus":"mdi-heart-plus",color:_(L)?"red":"blue",onClick:_(G)},{default:l(()=>[C(f(_(L)?"取消最愛":"加入最愛"),1)]),_:1},8,["prepend-icon","color","onClick"])]),_:1}),t(n,{cols:"6"},{default:l(()=>[t(h,{color:"primary","prepend-icon":"mdi-cart",onClick:O},{default:l(()=>e[7]||(e[7]=[C("加入購物車",-1)])),_:1,__:[7]})]),_:1})]),_:1})]),_:1})]),_:1}),t(n,{cols:"12",md:"9"},{default:l(()=>[i("h1",null,f(s.value.title),1),i("h2",null,f(s.value.authors),1),t(m,null,{default:l(()=>[t(n,{cols:"auto"},{default:l(()=>e[8]||(e[8]=[i("h3",null,"出版者:",-1)])),_:1,__:[8]}),t(n,null,{default:l(()=>[i("p",null,f(s.value.publisher),1)]),_:1})]),_:1}),t(m,null,{default:l(()=>[t(n,{cols:"auto"},{default:l(()=>e[9]||(e[9]=[i("h3",null,"價格:",-1)])),_:1,__:[9]}),t(n,null,{default:l(()=>[i("p",null,"$"+f(s.value.retailPrice),1)]),_:1})]),_:1}),t(m,null,{default:l(()=>[t(n,{cols:"auto"},{default:l(()=>e[10]||(e[10]=[i("h3",null,"分類:",-1)])),_:1,__:[10]}),t(n,null,{default:l(()=>[i("p",null,f(s.value.categories),1)]),_:1})]),_:1}),t(m,null,{default:l(()=>[t(n,{cols:"auto"},{default:l(()=>[e[11]||(e[11]=i("h3",null,"簡介:",-1)),x.value?(w(),B("p",{key:0,innerHTML:s.value.description},null,8,ke)):(w(),B("p",ye,f(s.value.description.substring(0,500)),1))]),_:1,__:[11]}),t(n,{class:"text-center"},{default:l(()=>[s.value.description.length>100?(w(),A(h,{key:0,color:"#4d4637",onClick:e[0]||(e[0]=o=>x.value=!x.value),icon:x.value?"mdi-chevron-up":"mdi-chevron-down"},null,8,["icon"])):te("",!0)]),_:1})]),_:1}),t(m,null,{default:l(()=>[t(n,{cols:"12"},{default:l(()=>[e[13]||(e[13]=i("h3",null,"新增書評:",-1)),t(U,{disabled:b.value,onSubmit:D(_($),["prevent"])},{default:l(()=>[t(P,{modelValue:V.value.rating,"onUpdate:modelValue":e[1]||(e[1]=o=>V.value.rating=o),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),t(z,{modelValue:V.value.comment,"onUpdate:modelValue":e[2]||(e[2]=o=>V.value.comment=o),label:"你的書評",required:""},null,8,["modelValue"]),t(h,{color:"#4d4637",type:"submit",loading:b.value},{default:l(()=>e[12]||(e[12]=[C("提交",-1)])),_:1,__:[12]},8,["loading"])]),_:1},8,["disabled","onSubmit"])]),_:1,__:[13]})]),_:1}),t(m,null,{default:l(()=>[t(n,{cols:"12"},{default:l(()=>[e[14]||(e[14]=i("h3",null,"書評:",-1)),t(de,null,{default:l(()=>[(w(!0),B(I,null,le(s.value.reviews,o=>(w(),A(ce,{key:o._id},{default:l(()=>[t(T,null,{default:l(()=>[t(m,null,{default:l(()=>[t(n,{cols:"auto"},{default:l(()=>[t(me,{style:{fontSize:"30px"}},{default:l(()=>[C(f(o.user.account),1)]),_:2},1024)]),_:2},1024),t(n,{cols:"auto"},{default:l(()=>[t(q,null,{default:l(()=>[t(P,{modelValue:o.rating,"onUpdate:modelValue":Q=>o.rating=Q,color:"#4d4637 darken-3",size:"25",readonly:""},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),t(m,null,{default:l(()=>[t(n,{cols:"auto"},{default:l(()=>[t(fe,{class:"mb-5",style:{fontSize:"20px"}},{default:l(()=>[C(f(o.comment),1)]),_:2},1024)]),_:2},1024),t(n,{class:"d-flex justify-end"},{default:l(()=>[t(q,null,{default:l(()=>[t(h,{icon:"mdi-pencil",color:"#4d4637",onClick:()=>K(o._id)},null,8,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1,__:[14]})]),_:1})]),_:1})]),_:1})]),_:1}),t(se,{modelValue:F.value,"onUpdate:modelValue":e[6]||(e[6]=o=>F.value=o),"max-width":"290"},{default:l(()=>[t(U,{disabled:b.value,onSubmit:D(_($),["prevent"])},{default:l(()=>[t(T,null,{default:l(()=>[t(ue,null,{default:l(()=>e[15]||(e[15]=[i("h3",null,"編輯書評",-1)])),_:1,__:[15]}),t(re,null,{default:l(()=>[t(P,{modelValue:u.value.rating,"onUpdate:modelValue":e[3]||(e[3]=o=>u.value.rating=o),color:"#4d4637 darken-3",hover:""},null,8,["modelValue"]),t(z,{modelValue:u.value.comment,"onUpdate:modelValue":e[4]||(e[4]=o=>u.value.comment=o),label:"你的書評",required:""},null,8,["modelValue"])]),_:1}),t(R,null,{default:l(()=>[t(h,{color:"#4d4637",onClick:e[5]||(e[5]=o=>_(Z)(a.review)),loading:b.value},{default:l(()=>e[16]||(e[16]=[C("修正",-1)])),_:1,__:[16]},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64))}};export{De as default};
