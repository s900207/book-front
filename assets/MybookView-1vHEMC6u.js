import{e as j,l as x,m as W,n as ee,b as d,H as te,a1 as A,a2 as c,aa as ae,a3 as $,j as h,Z as D,a8 as se,ag as re,u as ne,a6 as le}from"./vue-vendor-DIljl67C.js";import{u as oe,n as ie,e as ue,b as ce,o as de,_ as ge,t as me,w as pe,V as ve,J as fe}from"./index-C_tv00P6.js";import{j as he}from"./icons-BmvWcfYN.js";import{V as ye}from"./VContainer-CZi5Xp4O.js";import{V as be}from"./VRow-DuJyZejm.js";import{V as we}from"./VCol-nel5MGKg.js";import{V as ke}from"./VDataTable-DVLAs7ew.js";import{V as Ve}from"./VRating-CcUcrCpY.js";import{g as Ce,p as _e,d as xe,R as Se,E as Be,f as Pe,m as Re}from"./vuetify-vendor-CjpGIcAt.js";import{V as Le}from"./VAlert-jzCBz_KK.js";import"./VList-OwPThN99.js";import"./VDivider-oSapOaJL.js";import"./VChip-DFe582hF.js";import"./VSelectionControl-CwyxR3d7.js";const Te={actions:"button@2",article:"heading, paragraph",avatar:"avatar",button:"button",card:"image, heading","card-avatar":"image, list-item-avatar",chip:"chip","date-picker":"list-item, heading, divider, date-picker-options, date-picker-days, actions","date-picker-options":"text, avatar@2","date-picker-days":"avatar@28",divider:"divider",heading:"heading",image:"image","list-item":"text","list-item-avatar":"avatar, text","list-item-two-line":"sentences","list-item-avatar-two-line":"avatar, sentences","list-item-three-line":"paragraph","list-item-avatar-three-line":"avatar, paragraph",ossein:"ossein",paragraph:"text@3",sentences:"text@2",subtitle:"text",table:"table-heading, table-thead, table-tbody, table-tfoot","table-heading":"chip, text","table-thead":"heading@6","table-tbody":"table-row-divider@6","table-row-divider":"table-row, divider","table-row":"text@6","table-tfoot":"text@2, avatar@2",text:"text"};function Ue(s){let o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];return x("div",{class:ee(["v-skeleton-loader__bone",`v-skeleton-loader__${s}`])},[o])}function E(s){const[o,l]=s.split("@");return Array.from({length:l}).map(()=>S(o))}function S(s){let o=[];if(!s)return o;const l=Te[s];if(s!==l){if(s.includes(","))return M(s);if(s.includes("@"))return E(s);l.includes(",")?o=M(l):l.includes("@")?o=E(l):l&&o.push(S(l))}return[Ue(s,o)]}function M(s){return s.replace(/\s/g,"").split(",").map(S)}const Ae=_e({boilerplate:Boolean,color:String,loading:Boolean,loadingText:{type:String,default:"$vuetify.loading"},type:{type:[String,Array],default:"ossein"},...de(),...ce(),...Re()},"VSkeletonLoader"),$e=Ce()({name:"VSkeletonLoader",props:Ae(),setup(s,o){let{slots:l}=o;const{backgroundColorClasses:V,backgroundColorStyles:y}=oe(()=>s.color),{dimensionStyles:C}=ie(s),{elevationClasses:g}=ue(s),{themeClasses:b}=xe(s),{t:m}=Se(),p=j(()=>S(Be(s.type).join(",")));return Pe(()=>{const v=!l.default||s.loading,f=s.boilerplate||!v?{}:{ariaLive:"polite",ariaLabel:m(s.loadingText),role:"alert"};return x("div",W({class:["v-skeleton-loader",{"v-skeleton-loader--boilerplate":s.boilerplate},b.value,V.value,g.value],style:[y.value,v?C.value:{}]},f),[v?p.value:l.default?.()])}),{}}}),De={class:"text-left pa-2",style:{"max-width":"300px"}},Ee={class:"text-body-2 mb-0"},I=100,R=3,N=100,Me={__name:"MybookView",setup(s,{expose:o}){const{apiAuth:l}=pe(),V=me(),y=d(10),C=d([{key:"createdAt",order:"desc"}]),g=d(1),b=d([]),m=d([]),p=d(null),v=d(!1),f=d(""),w=new Map,B=d(!1),F=j(()=>f.value?T().length:m.value.length),H=a=>a?.result?.image||a?.image||"/placeholder-book.jpg",L=()=>{try{if(!V.token)return null;const a=V.token.split(".");if(a.length!==3)return null;const t=JSON.parse(atob(a[1]));return t._id||t.id||t.userId}catch{return null}},z=a=>{const t=a?.result?.reviews||a?.reviews||[],r=L();return!r||!t.length?0:t.find(n=>{const i=n.user?.$oid||n.user?._id||n.user?.id||n.user;return String(i)===String(r)})?.rating||0},J=a=>{const t=a?.result?.reviews||a?.reviews||[],r=L();if(!r||!t.length)return"尚未撰寫書評";const e=t.find(n=>{const i=n.user?.$oid||n.user?._id||n.user?.id||n.user;return String(i)===String(r)});if(e?.comment){const n=e.comment.toString();return n.length>I?n.substring(0,I)+"...":n}return"尚未撰寫書評"},K=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"書名",align:"center",sortable:!0,key:"result.title"},{title:"作者",align:"center",sortable:!0,key:"result.authors"},{title:"出版者",align:"center",sortable:!0,key:"result.publisher"},{title:"分類",align:"center",sortable:!0,key:"result.categories"},{title:"我的評分",align:"center",sortable:!1,key:"starRating"},{title:"我的書評",align:"center",sortable:!1,key:"userReview"}],Y=async(a,t=2)=>{if(w.has(a))return w.get(a);let r=null;for(let e=0;e<=t;e++)try{const i=(await l.get(`/books/${a}`)).data;return w.set(a,i),i}catch(n){if(r=n,n.response?.status===404)return w.set(a,null),null;e<t&&await new Promise(i=>setTimeout(i,N*(e+1)))}return console.warn(`獲取書籍 ${a} 失敗 (已重試 ${t} 次):`,r),w.set(a,null),null},Z=async a=>{const t=[],r=[];try{for(let e=0;e<a.length;e+=R){const i=a.slice(e,e+R).map(async u=>{try{const _=await Y(u);return{bookId:u,book:_,valid:_!==null}}catch(_){return console.warn(`批次處理書籍 ${u} 失敗:`,_),{bookId:u,book:null,valid:!1}}}),Q=await Promise.all(i);for(const u of Q)u.valid&&u.book?t.push(u.book):r.push(u.bookId);e+R<a.length&&await new Promise(u=>setTimeout(u,N))}}catch(e){console.error("批次獲取書籍時發生錯誤:",e),p.value="載入書籍時發生錯誤，請稍後重試"}return{validBooks:t,invalidIds:r}},O=async a=>{if(!(!a?.length||B.value)){B.value=!0;try{const t=a.map(async r=>{try{return await l.delete(`/users/favorite/${r}`),{bookId:r,success:!0}}catch(e){return e.response?.status===404?{bookId:r,success:!0,alreadyRemoved:!0}:(console.warn(`清理收藏 ${r} 失敗:`,e),{bookId:r,success:!1,error:e})}});await Promise.all(t)}catch(t){console.error("清理無效收藏時發生錯誤:",t)}finally{B.value=!1}}},T=()=>{if(!f.value)return m.value;const a=f.value.toLowerCase();return m.value.filter(t=>{const r=t?.result?.title||t?.title||"",e=t?.result?.authors||t?.authors||"",n=t?.result?.publisher||t?.publisher||"",i=t?.result?.categories||t?.categories||"";return r.toLowerCase().includes(a)||e.toLowerCase().includes(a)||n.toLowerCase().includes(a)||i.toLowerCase().includes(a)})},k=()=>{const a=T(),t=(g.value-1)*y.value,r=t+y.value;b.value=a.slice(t,r)},U=async()=>{if(!v.value){v.value=!0,p.value=null;try{const{data:a}=await l.get("/users/favorite"),t=a?.result||a||[];if(!t.length){m.value=[],b.value=[];return}const{validBooks:r,invalidIds:e}=await Z(t);m.value=r,k(),e.length>0&&setTimeout(()=>O(e),0)}catch(a){console.error("載入收藏失敗:",a),p.value=a?.response?.data?.message||"載入喜愛書籍失敗",m.value=[],b.value=[]}finally{v.value=!1}}},P=()=>{g.value=1,k()},X=()=>{k()},q=()=>{g.value=1,k()},G=()=>{g.value=1,k()};return te(()=>{U()}),o({tableLoadItems:U,tableApplySearch:P}),(a,t)=>{const r=ae("RouterLink");return $(),A(ye,null,{default:c(()=>[h(be,null,{default:c(()=>[h(we,{cols:"12"},{default:c(()=>[h(ke,{"items-per-page":y.value,"onUpdate:itemsPerPage":[t[2]||(t[2]=e=>y.value=e),q],"sort-by":C.value,"onUpdate:sortBy":[t[3]||(t[3]=e=>C.value=e),G],page:g.value,"onUpdate:page":[t[4]||(t[4]=e=>g.value=e),X],items:b.value,headers:K,loading:v.value,"items-length":F.value,search:f.value,hover:""},{top:c(()=>[h(fe,{class:"mr-3",label:"搜尋","append-icon":ne(he),modelValue:f.value,"onUpdate:modelValue":t[0]||(t[0]=e=>f.value=e),"onClick:append":P,onKeydown:re(P,["enter"])},null,8,["append-icon","modelValue"]),p.value?($(),A(Le,{key:0,class:"mt-2",type:"error",dismissible:"","onClick:close":t[1]||(t[1]=e=>p.value=null)},{default:c(()=>[le(D(p.value),1)]),_:1})):se("",!0)]),"item.image":c(({item:e})=>[h(r,{class:"text-primary text-decoration-none",to:"/books/"+(e?.result?._id||e?._id||e?.result?.id||e?.id),title:e?.result?.title||e?.title||""},{default:c(()=>[h(ve,{src:H(e),width:"80",height:"80",cover:"",alt:e?.result?.title||e?.title||"書籍圖片"},{placeholder:c(()=>[h($e,{type:"image"})]),_:2},1032,["src","alt"])]),_:2},1032,["to","title"])]),"item.starRating":c(({item:e})=>[h(Ve,{"model-value":z(e),readonly:"",color:"#4d4637 darken-3",size:"20"},null,8,["model-value"])]),"item.userReview":c(({item:e})=>[x("div",De,[x("p",Ee,D(J(e)),1)])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1})}}},Qe=ge(Me,[["__scopeId","data-v-c5a048e1"]]);export{Qe as default};
